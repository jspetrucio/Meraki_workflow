# =============================================================================
# CodeRabbit Configuration - Cisco Neural Language (CNL)
# =============================================================================
# Project: Brownfield — Python backend + React/TS frontend + Rust/Tauri desktop
# Profile: assertive (production-grade, comprehensive review)
# Generated by: @devops (Gage) — 2026-02-05
# Documentation: https://docs.coderabbit.ai/configuration
# =============================================================================

version: 2
language: "en-US"
early_access: false

# -----------------------------------------------------------------------------
# REVIEW CONFIGURATION
# -----------------------------------------------------------------------------
reviews:
  profile: "assertive"

  request_changes_workflow: false
  high_level_summary: true
  high_level_summary_placeholder: "@coderabbitai summary"
  poem: false
  review_status: true
  collapse_walkthrough: false
  abort_on_close: true

  auto_review:
    enabled: true
    drafts: false
    base_branches:
      - "main"
      - "develop"
      - "release/*"

  finishing_touches:
    docstrings:
      enabled: false
    unit_tests:
      enabled: false

  # ---------------------------------------------------------------------------
  # PATH FILTERS - Exclude from review
  # ---------------------------------------------------------------------------
  path_filters:
    # Generated/build files
    - "!**/node_modules/**"
    - "!**/dist/**"
    - "!**/build/**"
    - "!**/coverage/**"
    - "!**/*.min.js"
    - "!**/*.min.css"
    - "!**/__pycache__/**"
    - "!**/*.pyc"
    - "!**/.pytest_cache/**"

    # Lock files
    - "!**/package-lock.json"
    - "!**/yarn.lock"
    - "!**/pnpm-lock.yaml"
    - "!**/Cargo.lock"

    # Generated type definitions
    - "!**/*.d.ts"

    # Client data (runtime, not code)
    - "!clients/**"

    # AIOS framework internals
    - "!.aios-core/**"

    # Static assets
    - "!docs/Pictures/**"
    - "!**/*.png"
    - "!**/*.jpg"
    - "!**/*.ico"

  # ---------------------------------------------------------------------------
  # PATH INSTRUCTIONS - Context-specific review rules
  # ---------------------------------------------------------------------------
  path_instructions:
    # -------------------------------------------------------------------------
    # PYTHON BACKEND (scripts/)
    # -------------------------------------------------------------------------
    - path: "scripts/**/*.py"
      instructions: |
        Python backend modules for Meraki network management.
        Uses: FastAPI, Meraki SDK, LiteLLM, Pydantic, Click.

        CRITICAL (must fix immediately):
        - Hardcoded API keys or credentials (must use ~/.meraki/credentials or env vars)
        - SQL injection or command injection vulnerabilities
        - Meraki API rate limit violations (max 10 req/s per org)
        - Exposed sensitive network data in logs

        HIGH (should fix before merge):
        - Missing error handling for Meraki API calls (network timeouts, 429 rate limits)
        - Unvalidated user input passed to API calls
        - Missing type hints on public functions
        - Async/await misuse (blocking calls in async context)

        MEDIUM (document as tech debt):
        - Code duplication across modules
        - Functions exceeding 50 lines
        - Missing input validation on CLI commands

        CONTEXT:
        - scripts/auth.py: Credential management (~/.meraki/credentials)
        - scripts/api.py: Meraki SDK wrapper
        - scripts/server.py: FastAPI on localhost:3141
        - scripts/ai_engine.py: LiteLLM multi-provider wrapper
        - scripts/agent_router.py: Intent classification + agent dispatch

    # -------------------------------------------------------------------------
    # REACT/TYPESCRIPT FRONTEND (frontend/)
    # -------------------------------------------------------------------------
    - path: "frontend/src/**/*.tsx"
      instructions: |
        React 19 components with TypeScript.
        Uses: shadcn/ui, Tailwind CSS, Zustand state management.

        FOCUS ON:
        - Component prop typing (no 'any')
        - Hook dependency arrays (useEffect, useMemo, useCallback)
        - Key prop usage in lists
        - Memory leaks (useEffect cleanup, interval cleanup)
        - Accessibility (aria labels, semantic HTML)
        - WebSocket connection lifecycle management

        SKIP:
        - JSX formatting preferences
        - Tailwind class ordering

    - path: "frontend/src/**/*.ts"
      instructions: |
        TypeScript utility files, stores, and API clients.

        FOCUS ON:
        - Strict typing (minimize 'any')
        - Zustand store patterns (immutable updates)
        - API client error handling
        - WebSocket reconnection logic

    - path: "frontend/src/stores/**"
      instructions: |
        Zustand state management stores.

        VALIDATE:
        - Immutable state updates
        - No side effects in store definitions
        - Proper TypeScript interfaces for state shape
        - Actions are well-named and focused

    # -------------------------------------------------------------------------
    # RUST/TAURI DESKTOP (src-tauri/)
    # -------------------------------------------------------------------------
    - path: "src-tauri/**/*.rs"
      instructions: |
        Tauri 2.0 desktop application code (Rust).
        Pattern: Sidecar — Rust spawns Python/uvicorn as child process.

        CRITICAL:
        - Child process not properly terminated on app close
        - Port binding without fallback
        - Unsafe blocks without justification

        HIGH:
        - Missing error handling (unwrap() on potentially failing operations)
        - Resource leaks (file handles, network connections)
        - Missing Tauri permission declarations

        MEDIUM:
        - Clippy warnings
        - Missing documentation on public functions

    - path: "src-tauri/tauri.conf.json"
      instructions: |
        Tauri configuration file.

        VALIDATE:
        - Security allowlist is minimal (principle of least privilege)
        - CSP headers are restrictive
        - Auto-updater endpoints use HTTPS
        - Bundle identifier matches Cisco naming

    # -------------------------------------------------------------------------
    # TEMPLATES (templates/)
    # -------------------------------------------------------------------------
    - path: "templates/**"
      instructions: |
        Jinja2 templates for Meraki configurations and reports.

        VALIDATE:
        - Template variables are properly escaped
        - No hardcoded network-specific values
        - Templates are reusable across different network topologies

    # -------------------------------------------------------------------------
    # TESTS
    # -------------------------------------------------------------------------
    - path: "tests/**/*.py"
      instructions: |
        Python test files (pytest).

        VALIDATE:
        - Tests cover edge cases and error paths
        - Meraki API calls are properly mocked (never hit real API in tests)
        - Fixtures are reusable
        - Test names are descriptive

        DO NOT:
        - Require docstrings in test functions
        - Flag test-specific patterns (mock.ANY, etc.)

    - path: "frontend/**/*.test.*"
      instructions: |
        Frontend test files (Vitest + React Testing Library).

        VALIDATE:
        - User interaction testing (not implementation details)
        - Proper async handling (waitFor, findBy)
        - Component state assertions

    # -------------------------------------------------------------------------
    # CI/CD & CONFIGURATION
    # -------------------------------------------------------------------------
    - path: ".github/workflows/**"
      instructions: |
        GitHub Actions workflow files.

        CRITICAL:
        - Secrets exposed in logs (use masking)
        - Overly permissive permissions
        - Pinned action versions (use SHA, not @latest)

        HIGH:
        - Missing caching for dependencies
        - No timeout limits on jobs

    - path: "*.toml"
      instructions: |
        TOML configuration files (pyproject.toml, Cargo.toml).

        VALIDATE:
        - Dependency versions are pinned or use compatible ranges
        - No conflicting dependency requirements
        - Metadata fields are complete

    - path: ".env*"
      instructions: |
        Environment files.

        CRITICAL:
        - Real secrets in .env.example
        - Production API keys committed

    # -------------------------------------------------------------------------
    # DOCUMENTATION
    # -------------------------------------------------------------------------
    - path: "docs/**/*.md"
      instructions: |
        Project documentation.

        VALIDATE:
        - Clarity and completeness
        - Code examples are correct and runnable
        - Links are valid

        DO NOT:
        - Flag markdown style preferences
        - Require specific heading structures

    - path: "docs/stories/**"
      instructions: |
        User story files. These follow AIOS story template format.

        VALIDATE:
        - All acceptance criteria are clear and testable
        - Dev notes include sufficient implementation detail
        - File Locations table is present
        - Testing section has concrete examples

# -----------------------------------------------------------------------------
# CHAT CONFIGURATION
# -----------------------------------------------------------------------------
chat:
  auto_reply: true

# -----------------------------------------------------------------------------
# KNOWLEDGE BASE
# -----------------------------------------------------------------------------
knowledge_base:
  learnings:
    scope: "auto"
  issues:
    scope: "auto"
  pull_requests:
    scope: "auto"
