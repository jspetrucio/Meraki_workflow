# Epic 7: Deterministic Task Executor & Modular Agent Architecture

> **Priority:** P0 — Core architecture change
> **Sprint:** S6-S7 (2 weeks)
> **Owner:** @pm (Morgan)
> **Agents:** @architect, @dev, @qa
> **Source:** `docs/cnl-add-feature-task-executor.md`
> **Date:** 2026-02-07

---

## Problem Statement

The CNL system currently operates in **single-shot mode**: the Router classifies intent, loads a monolithic `.md` as system prompt, and the LLM decides everything — tool order, safety checks, confirmations. This causes:

- LLM can skip safety steps (backup, confirmation)
- LLM can invert operation order (apply before preview)
- No deterministic guarantee on execution sequence
- Monolithic `.md` files (300+ lines) waste tokens and reduce LLM quality
- No real rollback (backup/restore not in mandatory flow)

## Solution

A **deterministic Python loop** (`task_executor.py`) controls step-by-step execution. The LLM only participates in steps requiring interpretation. Safety hooks (pre-task/post-task) run ALWAYS, without depending on the LLM.

## Architecture Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Step execution | Deterministic Python loop | Safety guarantees |
| Task definition | YAML frontmatter in .md files | Human-readable + machine-parseable |
| State persistence | JSON file-based (`task-runs/`) | Local-first, no new DB |
| Integration | Layer on top of process_message | Backward compatible |
| FUNCTION_REGISTRY | No refactor, reuse as-is | Minimize blast radius |
| Migration | Gradual with feature flag | Zero downtime |

## Stories

| Story | Title | Points | Agent | Depends On |
|-------|-------|--------|-------|------------|
| 7.1 | Task Executor Core Engine | 13 | @dev | — |
| 7.2 | YAML Frontmatter Parser & Task Registry | 5 | @dev | — |
| 7.3 | Router Integration & Feature Flag | 10 | @dev | 7.1, 7.2 |
| 7.4 | New FUNCTION_REGISTRY Entries | 5 | @dev | — |
| 7.5 | Network Analyst Skill Migration | 5 | @dev | 7.1, 7.2 |
| 7.6 | Meraki Specialist Skill Migration | 8 | @dev | 7.1, 7.2 |
| 7.7 | Bug Fixes (Router Regex + update_vlan Schema) | 2 | @dev | — |

**Total Points:** 48

## Wave Plan

### Wave 1 — Foundation (parallelizable)
- **7.1** Task Executor Core Engine
- **7.2** YAML Frontmatter Parser & Task Registry
- **7.4** New FUNCTION_REGISTRY Entries
- **7.7** Bug Fixes

### Wave 2 — Integration (depends on Wave 1)
- **7.3** Router Integration & Feature Flag

### Wave 3 — Migration (depends on Wave 2)
- **7.5** Network Analyst Skill Migration
- **7.6** Meraki Specialist Skill Migration

## Success Criteria

### Functional
- [ ] task_executor.py runs tasks step-by-step deterministically
- [ ] Steps `tool` call FUNCTION_REGISTRY directly (no LLM)
- [ ] Steps `agent` use ai_engine with streaming
- [ ] Steps `gate` pause execution and await user confirmation
- [ ] Pre-task hook runs ALWAYS before any task
- [ ] Post-task hook runs ALWAYS after any task
- [ ] Rollback works using change-log saved in JSON
- [ ] process_message routes to task_executor when modular task exists
- [ ] process_message keeps legacy flow when modular task does NOT exist

### Security
- [ ] No write operation without prior backup
- [ ] No write operation without user confirmation (gate step)
- [ ] detect_catalyst_mode blocks writes on monitored devices
- [ ] sgt_preflight_check alerts about SGT-locked ports before write

### Compatibility
- [ ] Messages not matching modular tasks continue working (legacy flow)
- [ ] FUNCTION_REGISTRY unchanged (or minimal extraction to utils)
- [ ] Directory structure clients/{name}/ preserved + task-runs/ added
- [ ] CLI and REST endpoints continue working

## Out of Scope

- Workflow Creator (3rd agent) — future roadmap
- FUNCTION_REGISTRY refactor
- New database — JSON file-based is sufficient
- UI/Frontend changes — backend only
- New Meraki tools — can be added incrementally later

---

*— Morgan, planejando o futuro*
