# Story 6.1: pip Distribution

> **Epic:** 6 - Distribution & Packaging
> **Sprint:** S7 (Week 6-7)
> **Priority:** P1
> **Points:** 3
> **Type:** DevOps / Packaging
> **Agent:** @devops
> **Depends on:** Story 1.1 (FastAPI Server), Story 2.1 (React Scaffold)

---

## Status

**Draft**

---

## Story

**As a** Python user,
**I want** to install CNL via `pip install cnl`,
**so that** I can use it with my existing Python environment.

---

## Acceptance Criteria

1. Package published to PyPI as `cnl` (or internal Cisco PyPI if required)
2. `pip install cnl` installs all dependencies including frontend assets
3. `cnl` command launches FastAPI server + opens browser
4. `cnl --cli` drops into CLI-only mode (no web UI)
5. `cnl --version` shows semantic version
6. Frontend static files bundled inside the Python package
7. setup.py/pyproject.toml correctly configured with all dependencies

---

## Integration Verification

- **IV1:** Clean install in fresh virtualenv works end-to-end
- **IV2:** All CLI commands from original project work under `cnl` namespace
- **IV3:** `pip install` + `cnl` completes under 2 minutes

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`scripts/**/*.py`** (cli.py entry point, __version__.py):
- HIGH: CLI entry point must handle import errors gracefully (missing dependencies)
- MEDIUM: Version string must be single source of truth

**`*.toml`** (pyproject.toml):
- VALIDATE: Dependency versions pinned or use compatible ranges
- VALIDATE: No conflicting dependency requirements
- VALIDATE: Package metadata complete (name, description, classifiers)

### Review Focus for This Story
- `pyproject.toml` must not include dev dependencies in main dependencies list
- `MANIFEST.in` must include all non-Python assets (templates, frontend/dist, agent defs)
- `cnl` entry point must handle both `--cli` and default server modes
- Frontend static files must be discoverable at runtime regardless of install method

---

## Tasks / Subtasks

- [ ] **T1: Create pyproject.toml** (AC: 7)
  - [ ] T1.1: Migrate from `setup.py` to `pyproject.toml` (keep setup.py as fallback)
  - [ ] T1.2: Package name: `cnl`
  - [ ] T1.3: Python requirement: `>=3.10`
  - [ ] T1.4: Dependencies list (all from requirements.txt + new ones)
  - [ ] T1.5: Optional dependencies: `[dev]` for test tools, `[docker]` for Docker extras
  - [ ] T1.6: Classifiers: "Development Status :: 4 - Beta", "Framework :: FastAPI"

- [ ] **T2: Configure entry points** (AC: 3, 4, 5)
  - [ ] T2.1: Console script: `cnl = scripts.cli:main` (or new entry point)
  - [ ] T2.2: `cnl` (no args) → start FastAPI server + open browser
  - [ ] T2.3: `cnl --cli` → drop into existing Click CLI (no web server)
  - [ ] T2.4: `cnl --version` → print version from package metadata
  - [ ] T2.5: `cnl serve` → start server only (no browser open)
  - [ ] T2.6: `cnl serve --port 3141 --host 127.0.0.1` → configurable

- [ ] **T3: Bundle frontend assets** (AC: 6)
  - [ ] T3.1: Build frontend: `cd frontend && npm run build` → `frontend/dist/`
  - [ ] T3.2: Include `frontend/dist/` in Python package via `package_data` or `MANIFEST.in`
  - [ ] T3.3: FastAPI serves from packaged `frontend/dist/` (resolve path at runtime)
  - [ ] T3.4: Build script: `scripts/build.sh` that builds frontend then packages Python

- [ ] **T4: Package structure** (AC: 2, 7)
  - [ ] T4.1: Package includes: `scripts/`, `templates/`, `frontend/dist/`, `.claude/agents/`
  - [ ] T4.2: Exclude: `tests/`, `docs/`, `clients/`, `src-tauri/`, `node_modules/`
  - [ ] T4.3: `MANIFEST.in` for non-Python files (templates, frontend assets, agent definitions)
  - [ ] T4.4: Verify `pip install -e .` works for development

- [ ] **T5: Version management** (AC: 5)
  - [ ] T5.1: Version in `pyproject.toml` → single source of truth
  - [ ] T5.2: Create `scripts/__version__.py` — `__version__ = "0.1.0"` (new file, does not exist yet)
  - [ ] T5.3: Ensure `pyproject.toml` reads version from `scripts/__version__.py` via `dynamic = ["version"]` or hardcode and keep in sync
  - [ ] T5.4: Sync with Tauri version in CI (Story 6.5)

- [ ] **T6: Test installation** (AC: IV1, IV2, IV3)
  - [ ] T6.1: Create fresh virtualenv → `pip install .` → verify `cnl --version`
  - [ ] T6.2: Run `cnl` → verify server starts, UI loads at localhost:3141
  - [ ] T6.3: Run `cnl --cli` → verify Click CLI works
  - [ ] T6.4: Test all existing CLI commands still work
  - [ ] T6.5: Measure install time (target: < 2 minutes)

- [ ] **T7: PyPI publishing prep** (AC: 1)
  - [ ] T7.1: Build distribution: `python -m build` → sdist + wheel
  - [ ] T7.2: Test with TestPyPI first: `twine upload --repository testpypi dist/*`
  - [ ] T7.3: Verify TestPyPI install: `pip install -i https://test.pypi.org/simple/ cnl`
  - [ ] T7.4: Document publishing process for CI (Story 6.5)

---

## Dev Notes

### pyproject.toml Structure

```toml
[build-system]
requires = ["setuptools>=68.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "cnl"
version = "0.1.0"
description = "Cisco Neural Language - Natural language interface for Meraki network management"
requires-python = ">=3.10"
dependencies = [
    "meraki>=1.38.0",
    "python-dotenv>=1.0.0",
    "pydantic>=2.0.0",
    "pyyaml>=6.0",
    "click>=8.0.0",
    "rich>=13.0.0",
    "jinja2>=3.0.0",
    "fastapi>=0.109.0",
    "uvicorn[standard]>=0.27.0",
    "litellm>=1.30.0",
    "cryptography>=42.0.0",
    "httpx>=0.27.0",
    "websockets>=12.0",
]

[project.optional-dependencies]
dev = ["pytest", "pytest-cov", "pytest-asyncio", "ruff", "httpx"]
pdf = ["weasyprint"]

[project.scripts]
cnl = "scripts.cli:main"

[tool.setuptools.package-data]
"*" = ["templates/**/*", "frontend/dist/**/*", ".claude/agents/*.md"]
```

### Entry Point Logic

```python
# scripts/cli.py — updated main()
@click.group(invoke_without_command=True)
@click.option("--cli", is_flag=True, help="CLI-only mode (no web UI)")
@click.option("--version", is_flag=True, help="Show version")
@click.pass_context
def main(ctx, cli, version):
    if version:
        from scripts.__version__ import __version__
        click.echo(f"cnl {__version__}")
        return
    if ctx.invoked_subcommand is None and not cli:
        # Launch web server + open browser
        launch_server()
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Package config | `pyproject.toml` | Python packaging |
| Version | `scripts/__version__.py` | Version string |
| Manifest | `MANIFEST.in` | Non-Python file inclusion |
| Build script | `scripts/build.sh` | Frontend build + package |

---

## Testing

- **Framework:** Manual (virtualenv install test)
- **Commands:**
  ```bash
  python -m venv /tmp/cnl-test && source /tmp/cnl-test/bin/activate
  pip install .
  cnl --version
  cnl serve &
  curl http://localhost:3141/api/v1/health
  ```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
