# Story 1.4: Settings & Credential Management

> **Epic:** 1 - API Foundation & Agent Router
> **Sprint:** S1 (Week 1)
> **Priority:** P0 (dependency for all other stories)
> **Points:** 3
> **Type:** Backend/API
> **Agent:** @dev

---

## Status

**Done**

---

## Story

**As a** user,
**I want** to manage my AI provider keys and application settings through the API,
**so that** the frontend can provide a settings interface and all modules can access shared configuration.

---

## Acceptance Criteria

1. Settings stored in `~/.cnl/settings.json` (theme, default provider, N8N URL, etc.)
2. AI provider keys stored in `~/.cnl/settings.json` (encrypted at rest using Fernet)
3. REST endpoints for CRUD on settings (`GET/PUT /api/v1/settings`)
4. REST endpoints for credential management (`GET /api/v1/credentials/providers`, `POST /api/v1/credentials/provider/{name}`)
5. Credential validation endpoint (`POST /api/v1/credentials/validate`) tests connectivity for Meraki + AI provider
6. Existing `~/.meraki/credentials` format remains supported and is the source of truth for Meraki keys

---

## Integration Verification

- **IV1:** Existing `~/.meraki/credentials` file is NOT modified by new settings module
- **IV2:** CLI commands using `--profile` flag still work with existing credential format
- **IV3:** Settings changes via API are immediately reflected in subsequent API calls

---

## Dependencies

| Direction | Story | Title | Status |
|-----------|-------|-------|--------|
| Blocked by | — | None (first story to implement) | — |
| Blocks | 1.1 | FastAPI Server Bootstrap | Draft |
| Blocks | 3.1 | LiteLLM AI Engine | Draft |

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`scripts/**/*.py`** (settings.py, settings_routes.py):
- CRITICAL: API keys must be encrypted at rest using Fernet — never stored in plaintext
- CRITICAL: Decrypted keys must never appear in logs, error messages, or API responses
- CRITICAL: `~/.meraki/credentials` must NEVER be modified by settings module
- HIGH: Fernet key derivation must use consistent machine-specific data
- HIGH: Encryption failure must fail gracefully (return None, not crash)
- HIGH: Settings REST endpoints must mask encrypted fields in responses (`has_ai_key: bool`)
- MEDIUM: `~/.cnl/` directory auto-created with appropriate permissions

**`tests/**/*.py`** (test_settings.py):
- VALIDATE: Encryption/decryption roundtrip tests
- VALIDATE: Backward compatibility — existing auth.py functions unaffected
- VALIDATE: Settings persistence across load/save cycles
- DO NOT: Require docstrings in test functions

### Review Focus for This Story
- Fernet key derivation from `hostname:username` must handle edge cases (Docker containers, CI)
- `encrypt_key()` / `decrypt_key()` must handle the `"enc:"` prefix correctly
- Settings update endpoint must validate input (reject unknown providers, invalid ports)
- Credential validation endpoints must not store the test credentials permanently

---

## Tasks / Subtasks

- [x] **T1: Create `scripts/settings.py` module** (AC: 1)
  - [x] T1.1: Define `Settings` dataclass with all fields (ai_provider, ai_model, ai_api_key, meraki_profile, n8n_enabled, n8n_url, n8n_api_key, theme, language, port, telemetry_enabled)
  - [x] T1.2: Set sensible defaults: ai_provider="anthropic", theme="dark", port=3141, telemetry_enabled=False
  - [x] T1.3: Implement `SettingsManager` class with CONFIG_DIR=`~/.cnl/` and SETTINGS_FILE=`~/.cnl/settings.json`
  - [x] T1.4: Implement `SettingsManager.load() -> Settings` (create defaults if file missing)
  - [x] T1.5: Implement `SettingsManager.save(settings: Settings) -> None`
  - [x] T1.6: Implement `SettingsManager.update(**kwargs) -> Settings` (partial update, save, return new)
  - [x] T1.7: Implement `SettingsManager.is_onboarding_complete() -> bool` (check ai_api_key + meraki profile exists)
  - [x] T1.8: Ensure `~/.cnl/` directory auto-created on first access

- [x] **T2: Implement API key encryption** (AC: 2)
  - [x] T2.1: Install `cryptography` package (add to requirements.txt)
  - [x] T2.2: Implement `encrypt_key(key: str) -> str` using Fernet symmetric encryption
  - [x] T2.3: Implement `decrypt_key(encrypted: str) -> str`
  - [x] T2.4: Derive machine key from `hostname + username` hash (not military-grade, prevents casual file reading)
  - [x] T2.5: AI keys encrypted before save, decrypted on load - transparent to consumers
  - [x] T2.6: Handle decryption failure gracefully (key changed machine → prompt re-entry)

- [x] **T3: Implement credential validation** (AC: 5)
  - [x] T3.1: Implement `validate_meraki_credentials(api_key: str, org_id: str) -> tuple[bool, str]`
    - Call Meraki API `getOrganizations` to verify key is valid
    - Return (True, "Connected to org: {name}") or (False, "Invalid API key: {error}")
  - [x] T3.2: Implement `validate_ai_credentials(provider: str, api_key: str) -> tuple[bool, str]`
    - Use LiteLLM to send a minimal test completion
    - Return (True, "Connected to {provider}") or (False, "{error}")
  - [x] T3.3: Implement `validate_n8n_connection(url: str, api_key: Optional[str]) -> tuple[bool, str]`
    - HTTP GET to `{url}/api/v1/workflows` with optional auth
    - Return (True, "N8N connected: {n} workflows") or (False, "{error}")

- [x] **T4: Backward compatibility with existing Meraki credentials** (AC: 6, IV1, IV2)
  - [x] T4.1: Settings module reads `meraki_profile` name and delegates to existing `scripts.auth.load_profile()` - NEVER reads/writes `~/.meraki/credentials` directly
  - [x] T4.2: Add helper `get_active_meraki_profile() -> MerakiProfile` that loads settings → gets profile name → calls `auth.load_profile(name)`
  - [x] T4.3: Test: existing `meraki discover full --client X` still works unchanged
  - [x] T4.4: Test: `~/.meraki/credentials` file is never modified by settings module

- [x] **T5: REST API endpoints** (AC: 3, 4 - NOTE: these will be minimal stubs; full server created in Story 1.1)
  - [x] T5.1: Create `scripts/settings_routes.py` with FastAPI APIRouter (will be mounted by server.py in Story 1.1)
  - [x] T5.2: `GET /api/v1/settings` → return current settings (mask encrypted keys in response)
  - [x] T5.3: `PATCH /api/v1/settings` → partial update settings
  - [x] T5.4: `GET /api/v1/credentials/providers` → list configured providers with masked keys
  - [x] T5.5: `POST /api/v1/credentials/provider/{name}` → save provider API key (encrypted)
  - [x] T5.6: `POST /api/v1/credentials/validate` → body: `{type: "meraki"|"ai"|"n8n", ...params}` → validate and return result
  - [x] T5.7: `GET /api/v1/settings/onboarding-status` → return `{complete: bool, missing: [...]}`
  - [x] T5.8: All endpoints use Pydantic models for request/response validation

- [x] **T6: Write unit tests**
  - [x] T6.1: `tests/test_settings.py` - Test Settings dataclass defaults and serialization
  - [x] T6.2: Test SettingsManager load/save/update cycle
  - [x] T6.3: Test encryption/decryption roundtrip
  - [x] T6.4: Test `is_onboarding_complete()` with various settings states
  - [x] T6.5: Test backward compatibility - verify auth.py functions still work
  - [x] T6.6: Test REST endpoints using FastAPI TestClient
  - [x] T6.7: Ensure all tests pass: `pytest tests/test_settings.py -v`

---

## Dev Notes

### Module Design

[Source: architecture.md#5.4 Settings Manager]

```python
# scripts/settings.py

from dataclasses import dataclass, field, asdict
from pathlib import Path
from typing import Optional
import json

@dataclass
class Settings:
    # AI Provider
    ai_provider: str = "anthropic"          # anthropic, openai, google, ollama
    ai_model: str = "claude-sonnet"         # Provider-specific model name
    ai_api_key: Optional[str] = None        # Encrypted at rest

    # Meraki
    meraki_profile: str = "default"         # Active profile from ~/.meraki/credentials

    # N8N (optional)
    n8n_enabled: bool = False
    n8n_url: Optional[str] = None           # e.g., http://localhost:5678
    n8n_api_key: Optional[str] = None       # Encrypted at rest

    # UI
    theme: str = "dark"                     # dark, light
    language: str = "en"                    # en, pt

    # Server
    port: int = 3141

    # Privacy
    telemetry_enabled: bool = False         # Always false for internal tool


class SettingsManager:
    CONFIG_DIR = Path.home() / ".cnl"
    SETTINGS_FILE = CONFIG_DIR / "settings.json"

    def load(self) -> Settings: ...
    def save(self, settings: Settings) -> None: ...
    def update(self, **kwargs) -> Settings: ...
    def is_onboarding_complete(self) -> bool: ...
    def encrypt_key(self, key: str) -> str: ...
    def decrypt_key(self, encrypted: str) -> str: ...
```

### Encryption Design

[Source: architecture.md#5.4 Settings Manager - Encryption]

- Use `cryptography.Fernet` for symmetric encryption
- Key derived from machine-specific data: `hashlib.sha256(f"{hostname}:{username}".encode()).digest()` → base64 → Fernet key
- Encrypted fields: `ai_api_key`, `n8n_api_key`
- On save: encrypt clear text → store as `"enc:xxxxx"` prefixed string
- On load: detect `"enc:"` prefix → decrypt → return clear text
- If decryption fails (machine changed): set field to None, log warning

### Existing Credential System (DO NOT MODIFY)

[Source: scripts/auth.py - existing module]

The existing credential system uses INI format at `~/.meraki/credentials`:
```ini
[default]
api_key = YOUR_API_KEY
org_id = YOUR_ORG_ID

[client-acme]
api_key = ACME_API_KEY
org_id = ACME_ORG_ID
```

Key existing functions (import and call, NEVER modify):
- `auth.load_profile(name: Optional[str]) -> MerakiProfile` - Load by name
- `auth.list_profiles() -> list[str]` - List available profiles
- `auth.validate_credentials(profile: MerakiProfile) -> tuple[bool, str]` - Validate against API
- `auth.get_organizations(profile: MerakiProfile) -> list[dict]` - List orgs

The settings module stores ONLY the active profile NAME (`meraki_profile: str`). Actual Meraki credentials stay in `~/.meraki/credentials` managed by auth.py.

### REST API Router Design

[Source: architecture.md#6.1 REST API Endpoints]

Create a standalone FastAPI router that will be mounted by server.py (Story 1.1):

```python
# scripts/settings_routes.py
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel

router = APIRouter(prefix="/api/v1", tags=["settings"])

class SettingsResponse(BaseModel):
    ai_provider: str
    ai_model: str
    has_ai_key: bool  # Don't expose actual key
    meraki_profile: str
    n8n_enabled: bool
    n8n_url: Optional[str]
    has_n8n_key: bool
    theme: str
    language: str
    port: int

class SettingsUpdateRequest(BaseModel):
    ai_provider: Optional[str] = None
    ai_model: Optional[str] = None
    meraki_profile: Optional[str] = None
    n8n_enabled: Optional[bool] = None
    n8n_url: Optional[str] = None
    theme: Optional[str] = None
    language: Optional[str] = None

class CredentialSaveRequest(BaseModel):
    api_key: str

class ValidationRequest(BaseModel):
    type: str  # "meraki", "ai", "n8n"
    api_key: Optional[str] = None
    org_id: Optional[str] = None
    provider: Optional[str] = None
    url: Optional[str] = None

class ValidationResponse(BaseModel):
    valid: bool
    message: str

class OnboardingStatusResponse(BaseModel):
    complete: bool
    missing: list[str]
```

### File Locations

[Source: architecture.md#8 Source Tree]

| File | Location | Purpose |
|------|----------|---------|
| Settings module | `scripts/settings.py` | Core settings management |
| Settings routes | `scripts/settings_routes.py` | FastAPI router (mounted by server.py) |
| Unit tests | `tests/test_settings.py` | All tests |
| User settings | `~/.cnl/settings.json` | Persisted settings |
| Meraki creds | `~/.meraki/credentials` | EXISTING - DO NOT MODIFY |

### Import Pattern

[Source: architecture.md#10.3 Critical Integration Rules]

```python
# In settings.py - import from existing modules
from scripts.auth import load_profile, list_profiles, validate_credentials, MerakiProfile

# Async boundary - if called from FastAPI async endpoint:
# result = await asyncio.to_thread(validate_credentials, profile)
```

### Dependencies to Add

Add to `requirements.txt`:
```
cryptography>=42.0.0    # Fernet encryption for API keys
```

For T3.2 (AI validation), LiteLLM is needed but will be installed in Story 3.1. For now, make AI validation optional - if LiteLLM not installed, return (False, "LiteLLM not installed - install with: pip install litellm").

---

## Testing

[Source: architecture.md#11 Testing Strategy]

- **Framework:** pytest
- **Location:** `tests/test_settings.py`
- **Coverage target:** 90%
- **Pattern:** Follow existing test patterns in `tests/test_auth.py`
- **Mock strategy:** Mock filesystem for settings file, mock Meraki API calls for validation
- **FastAPI testing:** Use `fastapi.testclient.TestClient` for endpoint tests

```python
# Test structure
import pytest
from scripts.settings import Settings, SettingsManager
from fastapi.testclient import TestClient

@pytest.fixture
def temp_config_dir(tmp_path):
    """Override CONFIG_DIR to temp directory for testing."""
    ...

def test_settings_defaults():
    s = Settings()
    assert s.ai_provider == "anthropic"
    assert s.theme == "dark"
    assert s.port == 3141

def test_settings_save_load_roundtrip(temp_config_dir):
    manager = SettingsManager()
    settings = Settings(ai_provider="openai", theme="light")
    manager.save(settings)
    loaded = manager.load()
    assert loaded.ai_provider == "openai"

def test_encryption_roundtrip():
    manager = SettingsManager()
    encrypted = manager.encrypt_key("sk-test-key-12345")
    decrypted = manager.decrypt_key(encrypted)
    assert decrypted == "sk-test-key-12345"

def test_onboarding_incomplete():
    s = Settings()  # No AI key set
    manager = SettingsManager()
    assert not manager.is_onboarding_complete()

def test_existing_meraki_credentials_untouched():
    """Verify ~/.meraki/credentials is never modified."""
    ...
```

Run tests: `pytest tests/test_settings.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |
| 2026-02-05 | 0.1.2 | Added structured Dependencies section per PO validation | River (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- All 40 tests passed on first run (0 failures)
- Existing auth tests (16) verified passing — backward compatibility confirmed

### Completion Notes List
- Settings dataclass with 11 fields and sensible defaults
- SettingsManager with Fernet encryption (hostname:username key derivation)
- Encrypted fields: ai_api_key, n8n_api_key (enc: prefix)
- Graceful fallback when cryptography not installed
- 7 REST endpoints via FastAPI APIRouter with Pydantic validation
- Input validation: rejects unknown providers, invalid themes
- AI validation gracefully handles missing LiteLLM dependency
- N8N validation uses stdlib urllib (no extra dependency)
- ~/.meraki/credentials NEVER touched by settings module

### File List
| File | Action | Lines |
|------|--------|-------|
| `scripts/settings.py` | Created | 167 |
| `scripts/settings_routes.py` | Created | 165 |
| `tests/test_settings.py` | Created | 248 |
| `requirements.txt` | Modified | +4 lines (cryptography, fastapi, uvicorn, httpx) |
| `docs/stories/1.4.story.md` | Modified | Status → Done, tasks checked |

---

## QA Results
_(To be filled by QA agent)_
