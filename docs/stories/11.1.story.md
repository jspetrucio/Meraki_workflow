# Story 11.1: SD-WAN / Uplink Selection

> **Epic:** 11 - SD-WAN, Policy & Templates
> **Sprint:** S8
> **Priority:** P1 (advanced operations)
> **Points:** 8
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** None (independent)

---

## Status

**Draft**

---

## Story

**As a** network architect,
**I want** to configure SD-WAN uplink policies and preferences,
**so that** I can optimize WAN path selection across the organization.

---

## Acceptance Criteria

1. `discover_sdwan_config` returns current uplink selection policies and preferences
2. `configure_sdwan_policy` supports performance-based and custom uplink policies
3. `set_uplink_preference` configures WAN1/WAN2 preference per traffic type
4. `get_vpn_exclusions` returns traffic excluded from VPN tunnels
5. Issue detection: `sdwan_no_policy` added to `find_issues()` when no SD-WAN policy is configured
6. Backup created before any SD-WAN config change
7. Dry-run mode supported: preview SD-WAN policy changes before applying
8. SD-WAN status integrated into `full_discovery()` output

---

## Scope

| Layer | New Items | Details |
|-------|-----------|---------|
| `api.py` | 4 methods | `get_uplink_selection`, `update_uplink_selection`, `get_uplink_statuses`, `get_vpn_exclusions` |
| `discovery.py` | 1 function | `discover_sdwan_config` |
| `config.py` | 2 functions | `configure_sdwan_policy`, `set_uplink_preference` |
| `agent_tools.py` | 4 schemas | meraki-specialist tools |
| Safety | DANGEROUS | SD-WAN changes affect all traffic paths |

---

## Implementation Pattern

This story follows the standardized 7-step implementation pattern:

1. `api.py` -- Add SDK wrapper methods with `@log_api_call`
2. `discovery.py` -- Add discovery function with `client.safe_call()`
3. `config.py` -- Add config functions with backup + `ConfigResult`
4. `agent_router.py` -- Register in `FUNCTION_REGISTRY`
5. `agent_tools.py` -- Add tool schemas + TOOL_SAFETY classification
6. `safety.py` -- Register in `SAFETY_CLASSIFICATION`
7. `tests/` -- Add comprehensive tests

**Note:** Both `SAFETY_CLASSIFICATION` (safety.py) and `TOOL_SAFETY` (agent_tools.py) must be updated.

---

## Tasks

- [ ] Add `get_uplink_selection`, `update_uplink_selection`, `get_uplink_statuses`, `get_vpn_exclusions` to api.py with `@log_api_call`
- [ ] Add `discover_sdwan_config` to discovery.py with `client.safe_call()`
- [ ] Add `configure_sdwan_policy` and `set_uplink_preference` to config.py with backup + `ConfigResult`
- [ ] Register SD-WAN functions in FUNCTION_REGISTRY (agent_router.py)
- [ ] Add 4 tool schemas to agent_tools.py (meraki-specialist)
- [ ] Register safety classifications in safety.py (DANGEROUS) and agent_tools.py (TOOL_SAFETY)
- [ ] Add `sdwan_no_policy` issue detection to `find_issues()`
- [ ] Integrate SD-WAN status into `full_discovery()` output
- [ ] Implement dry-run mode for SD-WAN policy changes
- [ ] Add tests (target: >= 90% coverage)
- [ ] Verify all schemas pass `validate_tool_schema()` with `additionalProperties: False`

---

## File List

(To be populated during implementation)

---

## Dependencies

- Phase 1 complete (Epics 8-10)
- Requires `appliance` product type in network
- Uses existing backup infrastructure from config.py

---

## Testing

### Test Coverage

- Unit tests for all 4 api.py methods
- Integration tests for discovery and config functions
- Safety classification tests
- Tool schema validation tests
- Issue detection test for `sdwan_no_policy`
- Dry-run mode test

### Test Expectations

- >= 90% code coverage for new functions
- All schemas pass validation with `additionalProperties: False`
- DANGEROUS tools require confirmation
- Backup created before all config changes
- `full_discovery()` includes SD-WAN data when product type is `appliance`

---
