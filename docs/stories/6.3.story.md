# Story 6.3: Homebrew Distribution

> **Epic:** 6 - Distribution & Packaging
> **Sprint:** S8 (Week 7-8)
> **Priority:** P3
> **Points:** 3
> **Type:** DevOps / macOS
> **Agent:** @devops
> **Depends on:** Story 4.1 (Tauri App Shell), Story 6.5 (Tauri Release Pipeline)

---

## Status

**Draft**

---

## Story

**As a** Mac user,
**I want** to install CNL via `brew install cnl`,
**so that** I can manage it with my package manager.

---

## Acceptance Criteria

1. Homebrew formula/cask created for CNL
2. `brew install cnl` installs the Tauri desktop app
3. `cnl` command available in PATH after install
4. Auto-update via `brew upgrade cnl`
5. Formula hosted in custom tap (e.g., `brew tap cisco/cnl`)

---

## Integration Verification

- **IV1:** `brew install` + launch completes under 2 minutes
- **IV2:** App functions identically to direct .app install
- **IV3:** `brew uninstall cnl` cleanly removes all installed files

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`.github/workflows/**`** (release.yml trigger for Homebrew update):
- CRITICAL: Secrets must not be exposed in logs (use masking)
- HIGH: `repository_dispatch` token must be scoped to minimum permissions

### Review Focus for This Story
- Homebrew cask SHA256 must be verified against the actual `.dmg` artifact
- Auto-update workflow must not commit directly to main without validation
- `zap trash` paths must match actual CNL data directories
- Binary symlink must work on both Intel and Apple Silicon Macs

---

## Tasks / Subtasks

- [ ] **T1: Create Homebrew tap repository** (AC: 5)
  - [ ] T1.1: Create GitHub repo: `cisco/homebrew-cnl` (or org-specific)
  - [ ] T1.2: Add `Formula/` directory structure
  - [ ] T1.3: Add README with tap usage instructions
  - [ ] T1.4: Configure repo permissions for automated formula updates

- [ ] **T2: Create Homebrew Cask** (AC: 1, 2)
  - [ ] T2.1: `Formula/cnl.rb` — Homebrew Cask definition
  - [ ] T2.2: Download URL → GitHub Releases `.dmg` artifact
  - [ ] T2.3: SHA256 checksum verification
  - [ ] T2.4: App name: "Cisco Neural Language.app"
  - [ ] T2.5: Binary symlink: `cnl` → points to CLI entry point

- [ ] **T3: CLI symlink** (AC: 3)
  - [ ] T3.1: Cask creates symlink in `/usr/local/bin/cnl` (Intel) or equivalent
  - [ ] T3.2: `cnl` command starts server (same as pip `cnl serve`)
  - [ ] T3.3: Or: `cnl` opens the .app via `open -a "Cisco Neural Language"`

- [ ] **T4: Auto-update support** (AC: 4)
  - [ ] T4.1: `auto_updates true` in cask definition (Tauri handles app updates)
  - [ ] T4.2: Or: formula version bump on each release (CI updates formula)
  - [ ] T4.3: `brew upgrade cnl` downloads latest `.dmg` and replaces

- [ ] **T5: CI integration** (AC: 4, 5)
  - [ ] T5.1: GitHub Action: on new release → update formula SHA + version
  - [ ] T5.2: Auto-commit to `homebrew-cnl` tap repo
  - [ ] T5.3: Triggered by Story 6.5 release pipeline

- [ ] **T6: Test installation** (AC: IV1, IV2, IV3)
  - [ ] T6.1: `brew tap cisco/cnl && brew install cnl` → installs successfully
  - [ ] T6.2: Open app → all features work
  - [ ] T6.3: `cnl` in terminal → CLI works
  - [ ] T6.4: `brew uninstall cnl` → clean removal
  - [ ] T6.5: Measure total install time (target: < 2 minutes)

---

## Dev Notes

### Homebrew Cask Definition

```ruby
# Formula/cnl.rb
cask "cnl" do
  version "0.1.0"
  sha256 "CHECKSUM_HERE"

  url "https://github.com/cisco/cnl/releases/download/v#{version}/CNL_#{version}_aarch64.dmg"
  name "Cisco Neural Language"
  desc "Natural language interface for Meraki network management"
  homepage "https://github.com/cisco/cnl"

  livecheck do
    url :url
    strategy :github_latest
  end

  app "Cisco Neural Language.app"
  binary "#{appdir}/Cisco Neural Language.app/Contents/MacOS/cnl", target: "cnl"

  zap trash: [
    "~/.cnl",
    "~/Library/Application Support/com.cisco.cnl",
    "~/Library/Caches/com.cisco.cnl",
    "~/Library/Preferences/com.cisco.cnl.plist",
  ]
end
```

### Tap Repository Structure

```
homebrew-cnl/
├── Formula/
│   └── cnl.rb          # Cask definition
├── README.md           # Installation instructions
└── .github/
    └── workflows/
        └── update-formula.yml  # Auto-update on release
```

### Auto-Update Workflow

Triggered by Story 6.5 release pipeline via `repository_dispatch` event:

```yaml
# .github/workflows/update-formula.yml (in homebrew-cnl repo)
name: Update Homebrew Formula
on:
  repository_dispatch:
    types: [new-release]
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update formula version and SHA
        env:
          VERSION: ${{ github.event.client_payload.version }}
          DMG_URL: ${{ github.event.client_payload.dmg_url }}
          SHA256: ${{ github.event.client_payload.sha256 }}
        run: |
          sed -i "s/version \".*\"/version \"$VERSION\"/" Formula/cnl.rb
          sed -i "s/sha256 \".*\"/sha256 \"$SHA256\"/" Formula/cnl.rb

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -am "Update to v${{ github.event.client_payload.version }}"
          git push
```

### CI Trigger from Release Pipeline (Story 6.5)

The release pipeline dispatches to the tap repo after publishing:

```yaml
# In .github/workflows/release.yml (Story 6.5) — post-release step
- name: Trigger Homebrew formula update
  uses: peter-evans/repository-dispatch@v2
  with:
    token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
    repository: cisco/homebrew-cnl
    event-type: new-release
    client-payload: |
      {
        "version": "${{ steps.version.outputs.clean }}",
        "dmg_url": "https://github.com/cisco/cnl/releases/download/v${{ steps.version.outputs.clean }}/CNL_${{ steps.version.outputs.clean }}_aarch64.dmg",
        "sha256": "${{ steps.checksum.outputs.sha256 }}"
      }
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Cask formula | `homebrew-cnl/Formula/cnl.rb` | Homebrew Cask definition |
| CI workflow | `homebrew-cnl/.github/workflows/update-formula.yml` | Auto-update on release |
| Release trigger | `.github/workflows/release.yml` (Story 6.5) | Dispatches to tap repo |

---

## Testing

- **Framework:** Manual testing on macOS
- **Test Scenarios:**
  - Fresh install from tap on Intel Mac
  - Fresh install from tap on Apple Silicon Mac
  - Upgrade from v0.1.0 to v0.2.0
  - Uninstall → verify clean removal

### Test Commands

```bash
# Add custom tap
brew tap cisco/cnl

# Install
brew install --cask cnl

# Verify app installed
ls /Applications/Cisco\ Neural\ Language.app

# Verify CLI symlink
which cnl
cnl --version

# Test upgrade
brew upgrade --cask cnl

# Test uninstall
brew uninstall --cask cnl
ls /Applications/Cisco\ Neural\ Language.app  # Should not exist

# Verify clean removal
ls ~/Library/Application\ Support/com.cisco.cnl  # Should not exist
ls ~/Library/Caches/com.cisco.cnl                 # Should not exist
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
