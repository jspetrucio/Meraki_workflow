# Story 6.5: Tauri Release Pipeline

> **Epic:** 6 - Distribution & Packaging
> **Sprint:** S8 (Week 7-8)
> **Priority:** P1
> **Points:** 5
> **Type:** CI/CD
> **Agent:** @devops
> **Depends on:** Story 4.1 (Tauri App Shell), Story 4.3 (Auto-Update)

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** an automated build pipeline for Tauri releases,
**so that** new versions are built and published for all platforms.

---

## Acceptance Criteria

1. GitHub Actions workflow for Tauri builds (macOS .dmg, Windows .msi, Linux .AppImage)
2. Triggered on git tag push (e.g., `v1.0.0`)
3. Builds uploaded to GitHub Releases
4. Tauri auto-updater manifest generated and published
5. Code signing for macOS (Apple Developer certificate) — or skip for internal distribution
6. Build completes in under 15 minutes

---

## Integration Verification

- **IV1:** GitHub Actions builds succeed for all three platforms
- **IV2:** Published .dmg installs and runs correctly on macOS
- **IV3:** Auto-updater correctly detects new releases

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`.github/workflows/**`** (release.yml):
- CRITICAL: Secrets must not be exposed in workflow logs (use masking)
- CRITICAL: `TAURI_SIGNING_PRIVATE_KEY` must never appear in build output
- HIGH: Action versions must be pinned (use SHA, not `@latest`)
- HIGH: Missing caching for Rust + Node.js dependencies

**`scripts/**/*.py`** (sync-version.sh touches __version__.py):
- VALIDATE: Version sync script updates all 5 files atomically

### Review Focus for This Story
- `tauri-apps/tauri-action` must use a pinned version (not `@v0` which auto-updates)
- `sync-version.sh` must handle macOS `sed` differences (no `-i.bak` needed on Linux)
- Release artifacts must be signed with Tauri updater private key
- Pre-release detection (`-rc` suffix) must correctly set `prerelease: true`
- Build cache keys must include `Cargo.lock` hash (not just target platform)

### Quality Gate Tasks

- [ ] **Pre-Commit (@dev):** No hardcoded secrets in workflow YAML (scan with `gitleaks` or manual review)
- [ ] **Pre-Commit (@dev):** All GitHub Actions use pinned SHA versions (no `@latest`, no `@v0` floating tags)
- [ ] **Pre-PR (@devops):** `sync-version.sh` tested on both macOS and Linux `sed` (no `.bak` file left behind)
- [ ] **Pre-PR (@devops):** Release workflow dry-run passes (`act` or manual trigger on test tag)
- [ ] **Pre-Deployment (@devops):** `TAURI_SIGNING_PRIVATE_KEY` never appears in build logs (verified via log grep)
- [ ] **Pre-Deployment (@devops):** All release artifacts have valid Tauri updater signatures
- [ ] **Pre-Deployment (@devops):** `latest.json` manifest format matches Tauri 2.0 updater specification

---

## Tasks / Subtasks

- [ ] **T1: Create GitHub Actions workflow** (AC: 1, 2)
  - [ ] T1.1: `.github/workflows/release.yml` — release pipeline
  - [ ] T1.2: Trigger: `on: push: tags: ['v*']`
  - [ ] T1.3: Matrix strategy: `[macos-latest, ubuntu-latest, windows-latest]`
  - [ ] T1.4: Job steps: checkout → setup Node.js → setup Rust → build frontend → build Tauri

- [ ] **T2: Build steps** (AC: 1)
  - [ ] T2.1: Install Node.js 20 → `npm ci` in `frontend/`
  - [ ] T2.2: Build frontend: `npm run build` → produces `frontend/dist/`
  - [ ] T2.3: Install Rust toolchain (stable)
  - [ ] T2.4: Build Tauri: `cargo tauri build` → produces platform-specific binary
  - [ ] T2.5: macOS: `.app` + `.dmg` in `src-tauri/target/release/bundle/`
  - [ ] T2.6: Windows: `.msi` + `.exe` in `src-tauri/target/release/bundle/`
  - [ ] T2.7: Linux: `.AppImage` + `.deb` in `src-tauri/target/release/bundle/`

- [ ] **T3: Upload to GitHub Releases** (AC: 3)
  - [ ] T3.1: Use `softprops/action-gh-release` or `tauri-apps/tauri-action`
  - [ ] T3.2: Upload all artifacts: `.dmg`, `.msi`, `.AppImage`, `.deb`
  - [ ] T3.3: Generate release notes from git changelog (or manual)
  - [ ] T3.4: Mark as pre-release for RC tags (`v1.0.0-rc1`)

- [ ] **T4: Auto-updater manifest** (AC: 4)
  - [ ] T4.1: Generate `latest.json` with platform-specific download URLs + signatures
  - [ ] T4.2: Upload `latest.json` alongside release artifacts
  - [ ] T4.3: Sign update artifacts with Tauri updater private key
  - [ ] T4.4: Include signatures in manifest for verification

- [ ] **T5: Code signing** (AC: 5)
  - [ ] T5.1: macOS: Apple Developer certificate for .app signing
  - [ ] T5.2: Store certificate as GitHub secret (base64 encoded)
  - [ ] T5.3: Or: skip signing for internal Cisco distribution (document how to bypass Gatekeeper)
  - [ ] T5.4: Windows: optional code signing with Authenticode certificate
  - [ ] T5.5: Linux: no signing required for .AppImage

- [ ] **T6: Version management in CI** (AC: 2)
  - [ ] T6.1: Extract version from git tag: `v1.0.0` → `1.0.0`
  - [ ] T6.2: Create version sync script `scripts/sync-version.sh` (see Dev Notes)
  - [ ] T6.3: Update `src-tauri/tauri.conf.json` → `.version` field
  - [ ] T6.4: Update `pyproject.toml` → `[project].version` field
  - [ ] T6.5: Update `frontend/package.json` → `version` field
  - [ ] T6.6: Update `scripts/__version__.py` → `__version__` string
  - [ ] T6.7: Update `src-tauri/Cargo.toml` → `[package].version` field

- [ ] **T7: Notify downstream** (AC: related to 6.3)
  - [ ] T7.1: After release published → trigger Homebrew formula update
  - [ ] T7.2: `repository_dispatch` event to `homebrew-cnl` repo
  - [ ] T7.3: Include version, download URL, SHA256 in payload

- [ ] **T8: Build performance** (AC: 6)
  - [ ] T8.1: Cache Rust dependencies (`~/.cargo/registry`, `target/`)
  - [ ] T8.2: Cache Node.js dependencies (`node_modules/`)
  - [ ] T8.3: Use `actions/cache` for both Rust and Node caches
  - [ ] T8.4: Target: < 15 minutes per platform build

- [ ] **T9: Write tests / validation**
  - [ ] T9.1: Test workflow syntax with `act` (local GH Actions runner)
  - [ ] T9.2: Dry-run build locally: `cargo tauri build`
  - [ ] T9.3: Verify `latest.json` format matches Tauri 2.0 updater spec
  - [ ] T9.4: Test tag push → release flow on a test branch

---

## Dev Notes

### GitHub Actions Workflow

```yaml
# .github/workflows/release.yml
name: Release
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - platform: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            src-tauri/target
          key: rust-${{ matrix.target }}-${{ hashFiles('src-tauri/Cargo.lock') }}

      - name: Install frontend deps
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Install Linux deps
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev

      - name: Build Tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "CNL ${{ github.ref_name }}"
          releaseBody: "See CHANGELOG.md for details."
          releaseDraft: false
          prerelease: false
```

### Auto-Updater Manifest (latest.json)

```json
{
  "version": "1.0.0",
  "notes": "Release notes here",
  "pub_date": "2026-02-05T00:00:00Z",
  "platforms": {
    "darwin-aarch64": {
      "signature": "SIGNATURE",
      "url": "https://github.com/cisco/cnl/releases/download/v1.0.0/CNL.app.tar.gz"
    },
    "darwin-x86_64": {
      "signature": "SIGNATURE",
      "url": "https://github.com/cisco/cnl/releases/download/v1.0.0/CNL.app.tar.gz"
    },
    "linux-x86_64": {
      "signature": "SIGNATURE",
      "url": "https://github.com/cisco/cnl/releases/download/v1.0.0/CNL.AppImage.tar.gz"
    },
    "windows-x86_64": {
      "signature": "SIGNATURE",
      "url": "https://github.com/cisco/cnl/releases/download/v1.0.0/CNL.msi.zip"
    }
  }
}
```

### Version Sync Script

All version files must be updated atomically before building:

```bash
#!/bin/bash
# scripts/sync-version.sh — Sync version across all package files
# Usage: ./scripts/sync-version.sh 1.0.0

VERSION=$1
if [ -z "$VERSION" ]; then
  echo "Usage: $0 <version>"
  exit 1
fi

echo "Syncing version to $VERSION..."

# 1. tauri.conf.json
jq --arg v "$VERSION" '.version = $v' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json

# 2. Cargo.toml
sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml && rm src-tauri/Cargo.toml.bak

# 3. pyproject.toml
sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml && rm pyproject.toml.bak

# 4. frontend/package.json
jq --arg v "$VERSION" '.version = $v' frontend/package.json > tmp.json && mv tmp.json frontend/package.json

# 5. scripts/__version__.py
echo "__version__ = \"$VERSION\"" > scripts/__version__.py

echo "✓ Version synced to $VERSION across all files"
```

### CI Version Extraction Step

```yaml
# In release.yml — before build step
- name: Extract version from tag
  id: version
  run: |
    TAG="${{ github.ref_name }}"
    VERSION="${TAG#v}"  # Strip 'v' prefix: v1.0.0 → 1.0.0
    echo "clean=$VERSION" >> $GITHUB_OUTPUT
    echo "Version: $VERSION"

- name: Sync version across files
  run: bash scripts/sync-version.sh ${{ steps.version.outputs.clean }}
```

### Secrets Required

| Secret | Purpose |
|--------|---------|
| `TAURI_SIGNING_PRIVATE_KEY` | Sign update artifacts |
| `TAURI_SIGNING_PRIVATE_KEY_PASSWORD` | Private key password |
| `APPLE_CERTIFICATE` | macOS code signing (base64) |
| `APPLE_CERTIFICATE_PASSWORD` | Certificate password |
| `APPLE_SIGNING_IDENTITY` | Certificate identity |
| `APPLE_ID` | Apple notarization |
| `APPLE_PASSWORD` | App-specific password |

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Release workflow | `.github/workflows/release.yml` | CI/CD pipeline |
| Tauri config | `src-tauri/tauri.conf.json` | Version + updater config |
| Signing key | GitHub Secrets | Tauri updater signing |

---

## Testing

- **Framework:** GitHub Actions (test with dry-run)
- **Validation:**
  - Push tag `v0.1.0-test` → verify workflow triggers
  - All 3+ platform builds succeed
  - Artifacts uploaded to GitHub Release
  - `latest.json` generated correctly
  - Build time < 15 minutes per platform

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |
| 2026-02-05 | 0.1.2 | Added security Quality Gates per PO validation (NO-GO fix) | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
