# Story 5.3: Workflow Monitoring

> **Epic:** 5 - N8N Integration
> **Sprint:** S7 (Week 6-7)
> **Priority:** P3
> **Points:** 3
> **Type:** Frontend + Backend
> **Agent:** @dev
> **Depends on:** Story 5.1 (N8N Connection Manager), Story 2.4 (Agent Sidebar)

---

## Status

**Draft**

---

## Story

**As a** user,
**I want** to see the status of my N8N automation workflows from within CNL,
**so that** I know my automated tasks are running correctly.

---

## Acceptance Criteria

1. N8N panel in sidebar (when connected) showing active workflows
2. Each workflow shows: name, schedule, last run time, last run status
3. Quick actions: pause/resume workflow, view last execution log
4. Error notifications in chat when a workflow fails
5. Chat command: "show my automated workflows" returns status summary

---

## Integration Verification

- **IV1:** Workflow status refreshes in real-time (polling every 60s)
- **IV2:** Pausing/resuming from CNL is reflected in N8N Dashboard
- **IV3:** Panel gracefully handles N8N being temporarily unavailable

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`scripts/**/*.py`** (server.py — N8N proxy routes):
- CRITICAL: N8N API key must not be exposed in frontend responses
- HIGH: Polling endpoint must not overload N8N API (respect rate limits)
- HIGH: Workflow activation/deactivation must validate ownership

**`frontend/src/**/*.tsx`** (N8NPanel.tsx, WorkflowCard.tsx):
- FOCUS: Polling interval cleanup on unmount (memory leak prevention)
- FOCUS: Stale data handling when N8N is unavailable
- FOCUS: Component prop typing, accessibility

**`frontend/src/stores/**`** (n8nStore.ts):
- VALIDATE: Immutable state updates, proper TypeScript interfaces

### Review Focus for This Story
- 60s polling interval must be configurable and must clean up on component unmount
- Pause/resume actions must have optimistic UI update with rollback on failure
- Error notifications via WebSocket must not flood the chat with repeated failures
- Stale data must show "Last updated: {time}" instead of disappearing

---

## Tasks / Subtasks

- [ ] **T1: N8N Workflow Panel component** (AC: 1, 2)
  - [ ] T1.1: `frontend/src/components/sidebar/N8NPanel.tsx` — workflow list in sidebar
  - [ ] T1.2: Only visible when `n8n.connected == true` in status API
  - [ ] T1.3: Collapsible section in sidebar below agents/profiles
  - [ ] T1.4: Each workflow card: name, schedule (cron → human-readable), status badge

- [ ] **T2: Workflow status display** (AC: 2)
  - [ ] T2.1: `WorkflowCard.tsx` — individual workflow status card
  - [ ] T2.2: Status badges: Active (green), Paused (yellow), Error (red)
  - [ ] T2.3: Last run: relative time ("2 hours ago"), status (success/failed)
  - [ ] T2.4: Schedule: human-readable ("Every day at 7:00 AM")

- [ ] **T3: Quick actions** (AC: 3)
  - [ ] T3.1: Pause button → `PATCH /api/v1/n8n/workflows/{id}` with `active: false`
  - [ ] T3.2: Resume button → `PATCH /api/v1/n8n/workflows/{id}` with `active: true`
  - [ ] T3.3: View log button → expand last execution details
  - [ ] T3.4: Confirmation before pause ("Pause 'Daily Discovery'?")

- [ ] **T4: Backend polling + proxy routes** (AC: 1, IV1)
  - [ ] T4.1: `GET /api/v1/n8n/workflows` → includes execution data (last run, status)
  - [ ] T4.2: `PATCH /api/v1/n8n/workflows/{id}` → proxy activate/deactivate to N8N
  - [ ] T4.3: `GET /api/v1/n8n/executions/{workflow_id}` → last 5 executions with logs
  - [ ] T4.4: Frontend polls `/api/v1/n8n/workflows` every 60 seconds

- [ ] **T5: Error notifications** (AC: 4)
  - [ ] T5.1: Backend checks for failed executions during polling
  - [ ] T5.2: If new failure detected → send WebSocket message `{type: "n8n_error", workflow, error}`
  - [ ] T5.3: Frontend shows error in chat: "Workflow 'Daily Discovery' failed: {error}"
  - [ ] T5.4: Also update workflow card status badge to red

- [ ] **T6: Chat command integration** (AC: 5)
  - [ ] T6.1: Agent router recognizes "show workflows" / "workflow status" intents
  - [ ] T6.2: Response: formatted table of all workflows with status
  - [ ] T6.3: Include suggestion: "Run *pause {name}* to pause a workflow"

- [ ] **T7: Graceful handling** (AC: IV3)
  - [ ] T7.1: If N8N unreachable during poll → show "N8N unavailable" in panel
  - [ ] T7.2: Don't remove workflow data — show stale data with "Last updated: {time}"
  - [ ] T7.3: Auto-recover when N8N comes back online

- [ ] **T8: Write tests**
  - [ ] T8.1: Test N8NPanel renders with workflow data
  - [ ] T8.2: Test pause/resume API calls
  - [ ] T8.3: Test polling interval
  - [ ] T8.4: Test error notification display in chat
  - [ ] T8.5: Test graceful degradation when N8N offline

---

## Dev Notes

### Component Structure

```
components/sidebar/
├── N8NPanel.tsx          # N8N workflows section in sidebar
└── WorkflowCard.tsx      # Individual workflow status card
```

### Cron to Human-Readable

Use `cronstrue` npm package to convert cron expressions:
- `0 7 * * *` → "Every day at 7:00 AM"
- `0 0 * * 0` → "Every Sunday at midnight"
- `*/5 * * * *` → "Every 5 minutes"

```bash
npm install cronstrue
```

### N8NPanel Component

```typescript
// frontend/src/components/sidebar/N8NPanel.tsx
import { useEffect } from 'react';
import { useN8NStore } from '@/stores/n8nStore';
import { api } from '@/lib/api';
import { WorkflowCard } from './WorkflowCard';

export function N8NPanel() {
  const { connected, workflows, lastUpdated, setWorkflows } = useN8NStore();

  useEffect(() => {
    if (!connected) return;
    const poll = async () => {
      try {
        const data = await api.get('/n8n/workflows');
        setWorkflows(data);
      } catch {
        // Show stale data with "last updated" time
      }
    };
    poll();
    const interval = setInterval(poll, 60_000); // 60s polling
    return () => clearInterval(interval);
  }, [connected]);

  if (!connected) return null;

  return (
    <div className="n8n-panel">
      <h3>Automations</h3>
      {workflows.map(wf => (
        <WorkflowCard key={wf.id} workflow={wf} />
      ))}
      {lastUpdated && (
        <span className="text-xs text-muted">
          Updated {formatRelativeTime(lastUpdated)}
        </span>
      )}
    </div>
  );
}
```

### WorkflowCard Component

```typescript
// frontend/src/components/sidebar/WorkflowCard.tsx
import cronstrue from 'cronstrue';
import { api } from '@/lib/api';

interface WorkflowCardProps {
  workflow: N8NWorkflow;
}

export function WorkflowCard({ workflow }: WorkflowCardProps) {
  const handleToggle = async () => {
    await api.patch(`/n8n/workflows/${workflow.id}`, {
      active: !workflow.active,
    });
  };

  const statusColor = workflow.active
    ? workflow.lastRunStatus === 'error' ? 'red' : 'green'
    : 'yellow';

  return (
    <div className="workflow-card">
      <span className={`status-dot bg-${statusColor}`} />
      <div>
        <strong>{workflow.name}</strong>
        <p className="text-xs">{cronstrue.toString(workflow.cron)}</p>
        {workflow.lastRunAt && (
          <p className="text-xs">Last: {formatRelativeTime(workflow.lastRunAt)}</p>
        )}
      </div>
      <button onClick={handleToggle}>
        {workflow.active ? 'Pause' : 'Resume'}
      </button>
    </div>
  );
}
```

### Backend Polling Route

```python
# In scripts/server.py — N8N routes

@app.get("/api/v1/n8n/workflows")
async def list_n8n_workflows():
    """List workflows with execution status for frontend polling."""
    client = get_n8n_client()
    if not client:
        raise HTTPException(503, "N8N not configured")
    workflows = client.list_workflows()
    # Enrich with last execution data
    for wf in workflows:
        execs = client.get_executions(workflow_id=wf["id"], limit=1)
        if execs:
            wf["lastRunAt"] = execs[0].get("startedAt")
            wf["lastRunStatus"] = execs[0].get("finished") and "success" or "error"
    return workflows
```

### Zustand Store

```typescript
// stores/n8nStore.ts
import { create } from 'zustand';

interface N8NWorkflow {
  id: string;
  name: string;
  active: boolean;
  cron: string;
  lastRunAt: string | null;
  lastRunStatus: 'success' | 'error' | null;
}

interface N8NStore {
  connected: boolean;
  workflows: N8NWorkflow[];
  lastUpdated: Date | null;
  setWorkflows: (wf: N8NWorkflow[]) => void;
  setConnected: (v: boolean) => void;
}

export const useN8NStore = create<N8NStore>((set) => ({
  connected: false,
  workflows: [],
  lastUpdated: null,
  setWorkflows: (workflows) => set({ workflows, lastUpdated: new Date() }),
  setConnected: (connected) => set({ connected }),
}));
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| N8NPanel | `frontend/src/components/sidebar/N8NPanel.tsx` | Sidebar workflows section |
| WorkflowCard | `frontend/src/components/sidebar/WorkflowCard.tsx` | Individual workflow card |
| n8nStore | `frontend/src/stores/n8nStore.ts` | Zustand store for N8N state |
| Backend routes | `scripts/server.py` | N8N proxy endpoints |
| Tests (FE) | `frontend/src/components/sidebar/__tests__/` | Vitest tests |
| Tests (BE) | `tests/test_n8n_client.py` | pytest tests |

---

## Testing

- **Framework:** Vitest + React Testing Library (frontend), pytest (backend)
- **Location:** `frontend/src/components/sidebar/__tests__/`, `tests/test_n8n_client.py`

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { N8NPanel } from '../N8NPanel';

test('renders workflow cards when connected', () => {
  // Mock useN8NStore to return connected + workflows
  render(<N8NPanel />);
  expect(screen.getByText('Daily Discovery')).toBeInTheDocument();
});

test('hides panel when not connected', () => {
  // Mock useN8NStore to return connected: false
  const { container } = render(<N8NPanel />);
  expect(container.firstChild).toBeNull();
});

test('pause button toggles workflow active state', async () => {
  render(<N8NPanel />);
  fireEvent.click(screen.getByText('Pause'));
  await waitFor(() => {
    expect(screen.getByText('Resume')).toBeInTheDocument();
  });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
