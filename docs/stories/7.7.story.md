# Story 7.7: Bug Fixes (Router Regex + update_vlan Schema)

> **Epic:** 7 - Deterministic Task Executor & Modular Agent Architecture
> **Sprint:** S6 (Week 1)
> **Priority:** P2 (quality)
> **Points:** 2
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** None (independent)

---

## Status

**Draft**

---

## Story

**As a** CNL user,
**I want** the Router to correctly distinguish between analysis and configuration intents for overlapping keywords,
**so that** "analyze my VLANs" routes to analyst and "configure VLAN 100" routes to specialist.

---

## Acceptance Criteria

### Router Regex Refinement (Bug 5.2)

1. `_quick_classify()` considers verb context: action verbs (configure, create, change, set, add, remove, delete, enable, disable, update) boost specialist score
2. `_quick_classify()` considers verb context: analysis verbs (analyze, check, verify, show, list, why, what, how, status, health) boost analyst score
3. "analyze my VLANs" → network-analyst (not specialist)
4. "configure VLAN 100 on network X" → meraki-specialist (not analyst)
5. "show me the firewall rules" → network-analyst
6. "add a firewall rule to block port 23" → meraki-specialist
7. Existing classification accuracy maintained or improved (>96%)

### update_vlan Schema Completion (Bug 5.3)

8. `update_vlan` tool schema in `agent_tools.py` includes optional fields: `dhcpHandling`, `dnsNameservers`, `dhcpOptions`, `reservedIpRanges`
9. ~~`update_vlan` function in `config.py` accepts and passes through optional DHCP/DNS fields~~ **REMOVED (Architect MEDIUM-1):** `update_vlan()` already uses `**kwargs` which passes through any parameter. Only the schema in `agent_tools.py` needs updating.
10. Schema validates against OpenAI function-calling format

### generate_discovery_report Reference Check (Bug 5.1)

11. Verify that modular analyst task files reference `generate_discovery_report` correctly (function name matches FUNCTION_REGISTRY)
12. Fix any references if mismatched

---

## Technical Notes

### Verb-Aware Classification (Shared Utility — HIGH-1)
Current `_quick_classify()` uses keyword weights. The fix imports verb sets from `scripts/verb_utils.py` (created in Story 7.2) and adds a verb-detection pre-pass:

```python
from scripts.verb_utils import ACTION_VERBS, ANALYSIS_VERBS

def _quick_classify(message: str) -> Optional[ClassificationResult]:
    words = message.lower().split()
    has_action = any(w in ACTION_VERBS for w in words)
    has_analysis = any(w in ANALYSIS_VERBS for w in words)

    # If clear verb signal, boost the appropriate agent
    if has_action and not has_analysis:
        specialist_boost = 0.3
    elif has_analysis and not has_action:
        analyst_boost = 0.3
    # ... rest of existing keyword logic
```

**Important:** The verb sets (`ACTION_VERBS`, `ANALYSIS_VERBS`) are a shared utility in `scripts/verb_utils.py`, also used by `find_matching_task()` in Story 7.2/7.3. This prevents duplication and ensures consistent classification behavior.

### Note on Migration Overlap
With Story 7.3 (Router Integration), the task registry's `find_matching_task()` will handle many of these cases more cleanly via `trigger_keywords`. However, the regex fix is still valuable for the legacy flow fallback.

---

## Integration Verification

- **IV1:** Existing 31 agent_router tests still pass
- **IV2:** Classification accuracy on test set maintained or improved
- **IV3:** update_vlan schema validates correctly

---

## Dependencies

| Direction | Story | Title | Status |
|-----------|-------|-------|--------|
| None | — | Independent fix | — |

---

## Tasks

- [ ] Add verb-aware pre-pass to _quick_classify() using shared verb_utils.py
- [ ] Test overlapping keywords: VLAN, firewall, SSID, switch, port
- [ ] Complete update_vlan schema in agent_tools.py
- [ ] ~~Update update_vlan() in config.py~~ **REMOVED** — kwargs already handles it (MEDIUM-1)
- [ ] Verify generate_discovery_report references in analyst tasks
- [ ] Run existing agent_router test suite — all must pass
- [ ] Write new classification tests for verb disambiguation (target: 8+ tests)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `scripts/agent_router.py` | MODIFY | Verb-aware _quick_classify() using shared verb_utils |
| `scripts/agent_tools.py` | MODIFY | Complete update_vlan schema |
| ~~`scripts/config.py`~~ | ~~MODIFY~~ | **REMOVED** — update_vlan already uses **kwargs (MEDIUM-1) |
| `tests/test_verb_classification.py` | CREATE | Verb disambiguation tests |

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Quality Gate**: All existing tests pass, accuracy >= 96%, schema validates
