# Story 13.6: Packet Capture

> **Epic:** 13 - Camera Analytics, Sensors & Observability
> **Sprint:** TBD
> **Priority:** P1 (platform depth)
> **Points:** 3
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** None (independent)

---

## Status

**Draft**

---

## Story

**As a** network engineer,
**I want** to initiate packet captures from Meraki devices,
**so that** I can debug traffic issues.

---

## Acceptance Criteria

1. `create_packet_capture` initiates a capture with filter options (port, protocol, duration)
2. `get_packet_capture_status` returns capture progress and download URL when complete
3. Capture duration limited to prevent resource exhaustion
4. Natural language: "capture packets on switch X port 5 for 30 seconds" works

---

## Scope

| Layer | New Items | Details |
|-------|-----------|---------|
| `api.py` | 2 methods | `create_packet_capture`, `get_packet_capture_status` |
| `discovery.py` | — | One-off action, no continuous discovery |
| `config.py` | — | Capture is a diagnostic action, not persistent config |
| `agent_tools.py` | 2 schemas | network-analyst tools |
| Safety | MODERATE | Initiates capture on device (non-destructive but resource-consuming) |

---

## Implementation Pattern

This story follows the standardized 7-step implementation pattern:

1. `api.py` -- Add SDK wrapper methods with `@log_api_call`
2. `discovery.py` -- N/A (one-off action)
3. `config.py` -- N/A (diagnostic action)
4. `agent_router.py` -- Register in `FUNCTION_REGISTRY`
5. `agent_tools.py` -- Add tool schemas + TOOL_SAFETY classification
6. `safety.py` -- Register in `SAFETY_CLASSIFICATION`
7. `tests/` -- Add comprehensive tests

**Note:** Both `SAFETY_CLASSIFICATION` (safety.py) and `TOOL_SAFETY` (agent_tools.py) must be updated.

---

## Tasks

- [ ] Add `create_packet_capture`, `get_packet_capture_status` to api.py with `@log_api_call`
- [ ] Add duration limit validation (e.g., max 300 seconds) in `create_packet_capture`
- [ ] Add hardware product-type guard (packet capture available on switches and appliances)
- [ ] Register packet capture functions in FUNCTION_REGISTRY (agent_router.py)
- [ ] Add 2 tool schemas to agent_tools.py (network-analyst)
- [ ] Register safety classifications in safety.py (MODERATE) and agent_tools.py (TOOL_SAFETY)
- [ ] Add tests (target: >= 90% coverage)
- [ ] Verify all schemas pass `validate_tool_schema()` with `additionalProperties: False`

---

## File List

(To be populated during implementation)

---

## Dependencies

- Packet capture must be enabled in Dashboard (org setting)
- Requires switch or appliance hardware

---

## Testing

### Expected Test Count: ~6-8 tests

**Test Coverage:**
- `test_create_packet_capture` - API method
- `test_create_packet_capture_duration_limit` - Duration validation
- `test_get_packet_capture_status` - API method
- `test_packet_capture_product_guard` - Hardware guard (skip when no switches/appliances)
- `test_function_registry_packet_capture` - Router registration
- `test_packet_capture_tool_schemas` - Schema validation
- `test_packet_capture_safety_classification` - Safety classification (MODERATE)

---
