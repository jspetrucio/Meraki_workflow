# Story 8.1: Site-to-Site VPN

> **Epic:** 8 - Network Security & Monitoring
> **Sprint:** S7
> **Priority:** P0 (core operations)
> **Points:** 8
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** None (independent)

---

## Status

**Draft**

---

## Story

**As a** network engineer,
**I want** to configure and monitor Site-to-Site VPN through CNL,
**so that** I can manage VPN tunnels without navigating the Dashboard.

---

## Acceptance Criteria

1. `discover_vpn_topology` returns all VPN peers, status, and subnets for an org
2. `configure_s2s_vpn` supports hub-and-spoke and full-mesh topologies
3. `add_vpn_peer` adds a third-party VPN peer with IKE/IPSec settings
4. Backup created before any VPN config change (org-level backup via new `backup_vpn_config()` since VPN is org-scoped, not network-scoped)
5. Dry-run mode supported: preview VPN topology changes before applying
6. VPN status integrated into `full_discovery()` output
7. Issue detection: `vpn_peer_down` added to `find_issues()`

---

## Scope

| Layer | New Items | Details |
|-------|-----------|---------|
| `api.py` | 3 methods | `get_vpn_config`, `update_vpn_config`, `get_vpn_statuses` |
| `discovery.py` | 1 function | `discover_vpn_topology` |
| `config.py` | 2 functions | `configure_s2s_vpn`, `add_vpn_peer` |
| `agent_tools.py` | 3 schemas | meraki-specialist tools |
| Safety | DANGEROUS | Requires confirmation + backup |

---

## Implementation Pattern

This story follows the standardized 7-step implementation pattern:

1. `api.py` -- Add SDK wrapper methods with `@log_api_call`
2. `discovery.py` -- Add discovery function with `client.safe_call()`
3. `config.py` -- Add config function with backup + `ConfigResult`
4. `agent_router.py` -- Register in `FUNCTION_REGISTRY`
5. `agent_tools.py` -- Add tool schemas + TOOL_SAFETY classification
6. `safety.py` -- Register in `SAFETY_CLASSIFICATION`
7. `tests/` -- Add comprehensive tests

**Note:** Both `SAFETY_CLASSIFICATION` (safety.py) and `TOOL_SAFETY` (agent_tools.py) must be updated.

---

## Tasks

- [ ] Add `get_vpn_config`, `update_vpn_config`, `get_vpn_statuses` to api.py with `@log_api_call`
- [ ] Add `discover_vpn_topology` to discovery.py with `client.safe_call()`
- [ ] Add `configure_s2s_vpn` and `add_vpn_peer` to config.py with backup + `ConfigResult`
- [ ] Add `backup_vpn_config()` for org-level VPN backup (since VPN is org-scoped)
- [ ] Register VPN functions in FUNCTION_REGISTRY (agent_router.py)
- [ ] Add 3 tool schemas to agent_tools.py (meraki-specialist)
- [ ] Register safety classifications in safety.py (DANGEROUS) and agent_tools.py (TOOL_SAFETY)
- [ ] Add `vpn_peer_down` issue detection to `find_issues()`
- [ ] Integrate VPN status into `full_discovery()` output
- [ ] Implement dry-run mode for VPN topology changes
- [ ] Add tests (target: >= 90% coverage)
- [ ] Verify all schemas pass `validate_tool_schema()` with `additionalProperties: False`

---

## File List

(To be populated during implementation)

---
