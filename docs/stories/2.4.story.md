# Story 2.4: Agent Sidebar

> **Epic:** 2 - Chat Frontend
> **Sprint:** S5 (Week 5)
> **Priority:** P1
> **Points:** 3
> **Type:** Frontend
> **Agent:** @dev
> **Depends on:** Story 2.1 (React Scaffold), Story 2.3 (Chat Interface)

---

## Status

**Draft**

---

## Story

**As a** user,
**I want** a sidebar showing available agents and my Meraki profiles,
**so that** I can see what's available and switch contexts easily.

---

## Acceptance Criteria

1. Sidebar shows 3 agents with icon, name, and one-line description
2. Active agent highlighted visually
3. Click agent to set as active (subsequent commands routed to that agent)
4. Auto-routing mode toggle (let Router decide vs. manual selection)
5. Profile section below agents showing current Meraki org
6. Profile switcher dropdown with all configured profiles
7. Connection status indicator (green = connected, red = API error)
8. Sidebar collapsible on smaller screens

---

## Integration Verification

- **IV1:** Agent list matches actual agent definitions (not hardcoded)
- **IV2:** Profile switching updates backend context immediately
- **IV3:** Connection status reflects actual Meraki API connectivity

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`frontend/src/**/*.tsx`** (AgentSidebar.tsx, ProfileSelector.tsx, ConnectionStatus.tsx):
- FOCUS: Component prop typing (no 'any'), hook dependency arrays
- FOCUS: Accessibility (aria labels, semantic HTML for navigation sidebar)
- FOCUS: Memory leaks (useEffect cleanup for polling intervals)
- SKIP: JSX formatting, Tailwind class ordering

**`frontend/src/stores/**`** (agentStore.ts):
- VALIDATE: Immutable state updates, no side effects in store definitions
- VALIDATE: Proper TypeScript interfaces for agent state shape

### Review Focus for This Story
- Agent list polling must clean up interval on unmount (memory leak prevention)
- Profile selector must not expose API keys in dropdown labels
- Connection status indicator must handle rapid state changes (debounce)
- Sidebar collapse/expand must preserve scroll position

---

## Tasks / Subtasks

- [ ] **T1: Create AgentSidebar component** (AC: 1, 2, 3, 4, 8)
  - [ ] T1.1: `AgentSidebar.tsx` — container for agent list + profile section
  - [ ] T1.2: Fetch agent list from backend (or use agentStore)
  - [ ] T1.3: Collapse/expand toggle button
  - [ ] T1.4: Auto-routing toggle switch at top

- [ ] **T2: Create AgentCard component** (AC: 1, 2, 3)
  - [ ] T2.1: `AgentCard.tsx` — icon, name, description, active indicator
  - [ ] T2.2: Click handler → set active agent in agentStore
  - [ ] T2.3: Active state: highlighted border/background
  - [ ] T2.4: Show agent status (idle/thinking/executing)

- [ ] **T3: Create ProfileSwitcher component** (AC: 5, 6, 7)
  - [ ] T3.1: `ProfileSwitcher.tsx` — dropdown with profile names
  - [ ] T3.2: Fetch profiles via `GET /api/v1/profiles`
  - [ ] T3.3: Show active profile with org name
  - [ ] T3.4: Switch → `POST /api/v1/profiles/{name}/activate`
  - [ ] T3.5: Connection status badge (green/red dot)

- [ ] **T4: Implement useProfiles hook** (AC: 5, 6)
  - [ ] T4.1: `hooks/useProfiles.ts` — fetch profiles, switch profile
  - [ ] T4.2: Cache profile list in settingsStore

- [ ] **T5: Write tests**
  - [ ] T5.1: Test agent list rendering
  - [ ] T5.2: Test agent selection
  - [ ] T5.3: Test profile switching
  - [ ] T5.4: Test sidebar collapse

---

## Dev Notes

### Sidebar Component Structure

[Source: architecture.md#5.6 React Frontend]

```
components/sidebar/
├── AgentSidebar.tsx      # Agent list with descriptions
├── AgentCard.tsx          # Individual agent status
└── ProfileSwitcher.tsx    # Meraki profile switching
```

### Agent Definitions (for display)

Three agents to display:
- **Network Analyst** — "Network discovery, analysis, diagnostics"
- **Meraki Specialist** — "Configure ACL, Firewall, SSID, VLAN, Switch"
- **Workflow Creator** — "Create automation workflows"

### useAgents Hook

[Source: architecture.md#5.6 React Frontend - Zustand Store]

```typescript
// hooks/useAgents.ts
import { useAgentStore } from '@/stores/agentStore';
import { useCallback } from 'react';
import { api } from '@/lib/api';

export function useAgents() {
  const { agents, activeAgent, autoRouting, setActiveAgent, setAutoRouting } = useAgentStore();

  const selectAgent = useCallback((agentName: string) => {
    setActiveAgent(agentName);
    setAutoRouting(false); // Manual selection disables auto-routing
  }, [setActiveAgent, setAutoRouting]);

  const toggleAutoRouting = useCallback((enabled: boolean) => {
    setAutoRouting(enabled);
    if (enabled) setActiveAgent(null); // Clear manual selection
  }, [setActiveAgent, setAutoRouting]);

  return { agents, activeAgent, autoRouting, selectAgent, toggleAutoRouting };
}
```

### useProfiles Hook

```typescript
// hooks/useProfiles.ts
import { useSettingsStore } from '@/stores/settingsStore';
import { useCallback, useEffect } from 'react';
import { api } from '@/lib/api';

export function useProfiles() {
  const { profiles, activeProfile, connectionStatus, setProfiles, setActiveProfile, setConnectionStatus } = useSettingsStore();

  useEffect(() => {
    api.get('/profiles').then(data => {
      setProfiles(data.profiles);
      setActiveProfile(data.active);
    });
    api.get('/status').then(data => {
      setConnectionStatus(data.meraki_connected ? 'connected' : 'error');
    });
  }, []);

  const switchProfile = useCallback(async (name: string) => {
    await api.post(`/profiles/${name}/activate`);
    setActiveProfile(name);
    const status = await api.get('/status');
    setConnectionStatus(status.meraki_connected ? 'connected' : 'error');
  }, [setActiveProfile, setConnectionStatus]);

  return { profiles, activeProfile, connectionStatus, switchProfile };
}
```

### Zustand agentStore Pattern

[Source: architecture.md#5.6 React Frontend]

```typescript
// stores/agentStore.ts (created in Story 2.1)
interface AgentStore {
  agents: AgentDefinition[];
  activeAgent: string | null;
  autoRouting: boolean;
  connectionStatus: 'connected' | 'disconnected' | 'reconnecting';
  setActiveAgent: (name: string | null) => void;
  setAutoRouting: (v: boolean) => void;
}
```

### API Endpoints

- `GET /api/v1/profiles` → profile list + active
- `POST /api/v1/profiles/{name}/activate` → switch profile
- `GET /api/v1/status` → connection status

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| AgentSidebar | `frontend/src/components/sidebar/AgentSidebar.tsx` | Sidebar container |
| AgentCard | `frontend/src/components/sidebar/AgentCard.tsx` | Individual agent card |
| ProfileSwitcher | `frontend/src/components/sidebar/ProfileSwitcher.tsx` | Profile dropdown |
| useAgents hook | `frontend/src/hooks/useAgents.ts` | Agent selection logic |
| useProfiles hook | `frontend/src/hooks/useProfiles.ts` | Profile fetching/switching |
| Tests | `frontend/src/components/sidebar/__tests__/` | Vitest tests |

---

## Testing

- **Framework:** Vitest + React Testing Library
- **Location:** `frontend/src/components/sidebar/__tests__/`

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { AgentSidebar } from '../AgentSidebar';

test('renders all 3 agents', () => {
  render(<AgentSidebar />);
  expect(screen.getByText('Network Analyst')).toBeInTheDocument();
  expect(screen.getByText('Meraki Specialist')).toBeInTheDocument();
  expect(screen.getByText('Workflow Creator')).toBeInTheDocument();
});

test('clicking agent sets it as active', () => {
  render(<AgentSidebar />);
  fireEvent.click(screen.getByText('Network Analyst'));
  expect(screen.getByText('Network Analyst').closest('[data-active]')).toBeTruthy();
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
