# Story 4.3: Auto-Update & Versioning

> **Epic:** 4 - Tauri Desktop Application
> **Sprint:** S6 (Week 5-6)
> **Priority:** P2
> **Points:** 3
> **Type:** Desktop / Rust / CI
> **Agent:** @dev
> **Depends on:** Story 4.1 (Tauri App Shell)

---

## Status

**Draft**

---

## Story

**As a** user,
**I want** the app to check for updates and offer one-click upgrades,
**so that** I always have the latest version without manual steps.

---

## Acceptance Criteria

1. Tauri updater configured to check GitHub Releases for new versions
2. Update check on app launch (non-blocking, background check)
3. Update notification banner in app when new version available
4. One-click "Update Now" that downloads and installs
5. Semantic versioning displayed in app (Settings > About)
6. Changelog shown in update dialog

---

## Integration Verification

- **IV1:** Update preserves user settings and credentials
- **IV2:** Update preserves client data in `clients/` directory
- **IV3:** Rollback to previous version is possible

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`src-tauri/**/*.rs`** (updater configuration):
- CRITICAL: Update endpoints must use HTTPS only
- CRITICAL: Update signatures must be verified before installation
- HIGH: Update download must not block the main application
- MEDIUM: User must be informed of update progress

**`frontend/src/**/*.tsx`** (UpdateBanner.tsx, AboutSection.tsx):
- FOCUS: Component prop typing, accessibility
- FOCUS: Update notification UX (non-intrusive, dismissible)

### Review Focus for This Story
- `tauri.conf.json` updater endpoints must point to HTTPS GitHub Releases URLs
- Signature verification must use the Tauri signing public key (not skipped)
- Update download failures must not crash the app (graceful fallback)
- "Check for Updates" button must have rate limiting (prevent API abuse)

---

## Tasks / Subtasks

- [ ] **T1: Configure Tauri Updater** (AC: 1)
  - [ ] T1.1: Add `tauri-plugin-updater` to `Cargo.toml`
  - [ ] T1.2: Configure updater endpoint in `tauri.conf.json` → GitHub Releases API
  - [ ] T1.3: Generate signing keypair for update verification (`tauri signer generate`)
  - [ ] T1.4: Store public key in `tauri.conf.json`, private key in CI secrets
  - [ ] T1.5: Updater JSON endpoint format matching Tauri 2.0 spec

- [ ] **T2: Background update check** (AC: 2, 3)
  - [ ] T2.1: On app startup, spawn async task to check for updates
  - [ ] T2.2: Non-blocking — app usable immediately, check happens in background
  - [ ] T2.3: If new version found → emit `update-available` event to frontend
  - [ ] T2.4: Frontend shows subtle banner: "Version X.Y.Z available" with "Update" button
  - [ ] T2.5: Recheck every 24 hours while app is running

- [ ] **T3: Update dialog** (AC: 4, 6)
  - [ ] T3.1: Click "Update" → show dialog with version number + changelog
  - [ ] T3.2: Changelog fetched from GitHub Release body (markdown)
  - [ ] T3.3: "Update Now" button → download + install via Tauri updater
  - [ ] T3.4: Progress indicator during download
  - [ ] T3.5: "Restart to apply" prompt after download completes
  - [ ] T3.6: "Skip this version" + "Remind me later" options

- [ ] **T4: Version display** (AC: 5)
  - [ ] T4.1: Version from `Cargo.toml` / `tauri.conf.json` `version` field
  - [ ] T4.2: Expose version via Tauri command: `#[tauri::command] fn get_version()`
  - [ ] T4.3: Settings > About section: app name, version, build date
  - [ ] T4.4: Also show in tray tooltip: "CNL v1.0.0"

- [ ] **T5: Semantic versioning setup** (AC: 5)
  - [ ] T5.1: Single source of truth: `src-tauri/tauri.conf.json` → `version` field
  - [ ] T5.2: Python package version synced from same source (or read at runtime)
  - [ ] T5.3: Frontend version injected via Vite define: `import.meta.env.VITE_APP_VERSION`
  - [ ] T5.4: Git tags match version: `v1.0.0`

- [ ] **T6: Data preservation on update** (AC: IV1, IV2)
  - [ ] T6.1: Verify `~/.cnl/` directory NOT included in app bundle (external data)
  - [ ] T6.2: Verify `~/.meraki/` directory NOT touched by updater
  - [ ] T6.3: Verify `clients/` directory persists (lives outside app bundle)
  - [ ] T6.4: Document data locations in README for user reference

- [ ] **T7: Write tests**
  - [ ] T7.1: Test version extraction from config
  - [ ] T7.2: Test update check HTTP request/response parsing
  - [ ] T7.3: Test "skip version" persistence
  - [ ] T7.4: Test changelog markdown rendering

---

## Dev Notes

### Tauri 2.0 Updater Configuration

```json
// In tauri.conf.json
{
  "plugins": {
    "updater": {
      "endpoints": [
        "https://github.com/cisco/cnl/releases/latest/download/latest.json"
      ],
      "pubkey": "GENERATED_PUBLIC_KEY_HERE"
    }
  }
}
```

### Update Manifest Format (latest.json)

Published alongside each GitHub Release:

```json
{
  "version": "1.1.0",
  "notes": "## What's New\n- Bug fixes\n- Performance improvements",
  "pub_date": "2026-02-05T00:00:00Z",
  "platforms": {
    "darwin-aarch64": {
      "signature": "SIGNATURE_HERE",
      "url": "https://github.com/cisco/cnl/releases/download/v1.1.0/CNL_1.1.0_aarch64.app.tar.gz"
    },
    "darwin-x86_64": {
      "signature": "SIGNATURE_HERE",
      "url": "https://github.com/cisco/cnl/releases/download/v1.1.0/CNL_1.1.0_x64.app.tar.gz"
    }
  }
}
```

### Frontend Update Banner Component

```typescript
// components/common/UpdateBanner.tsx
interface UpdateInfo {
  version: string;
  notes: string;
  date: string;
}

// Listen for update-available event from Tauri
// Show dismissible banner at top of app
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Updater config | `src-tauri/tauri.conf.json` | Updater endpoints + pubkey |
| Update check | `src-tauri/src/updater.rs` | Background update check logic |
| Update banner | `frontend/src/components/common/UpdateBanner.tsx` | UI notification |
| Version cmd | `src-tauri/src/commands.rs` | Tauri command for version info |

---

## Testing

- **Framework:** Rust unit tests + Vitest (frontend) + manual integration
- **Location:** `src-tauri/src/updater.rs`, `frontend/src/components/common/__tests__/`
- **Manual Test Scenarios:**
  - App launch → no update → no banner shown
  - App launch → update available → banner shown with correct version
  - Click "Update Now" → download progress → restart prompt
  - Click "Skip" → dismissed, not shown until next version
  - Settings > About → shows correct version number

```typescript
// frontend/src/components/common/__tests__/UpdateBanner.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { UpdateBanner } from '../UpdateBanner';

test('shows update banner when update available', () => {
  render(<UpdateBanner version="1.1.0" notes="Bug fixes" />);
  expect(screen.getByText(/1\.1\.0 available/)).toBeInTheDocument();
  expect(screen.getByText('Update Now')).toBeInTheDocument();
});

test('skip button hides banner', () => {
  render(<UpdateBanner version="1.1.0" notes="Bug fixes" />);
  fireEvent.click(screen.getByText('Skip'));
  expect(screen.queryByText(/1\.1\.0 available/)).not.toBeInTheDocument();
});

test('about section shows current version', () => {
  render(<AboutSection version="1.0.0" buildDate="2026-02-05" />);
  expect(screen.getByText('v1.0.0')).toBeInTheDocument();
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
