# Story 12.4: HA / Warm Spare

> **Epic:** 12 - Switching, Wireless & Monitoring
> **Sprint:** TBD
> **Priority:** P1 (high availability)
> **Points:** 5
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** Phase 1 complete (Epics 8-10)

---

## Status

**Draft**

---

## Story

**As a** network architect,
**I want** to configure High Availability (warm spare) on MX appliances,
**so that** I can ensure failover capability through natural language.

---

## Acceptance Criteria

1. `discover_ha_config` returns HA status, primary/spare IPs, and last failover time
2. `configure_warm_spare` enables/disables HA with spare uplink IPs
3. `trigger_failover` initiates manual failover (DANGEROUS, requires typing CONFIRM)
4. Issue detection: `no_ha_configured` on critical networks
5. Backup created before any HA config change
6. Dry-run mode supported: preview HA changes before applying
7. HA status integrated into `full_discovery()` output
8. Safety: DANGEROUS classification for failover operations (brief outage)

---

## Scope

| Layer | New Items | Details |
|-------|-----------|---------|
| `api.py` | 3 methods | `get_warm_spare`, `update_warm_spare`, `swap_warm_spare` |
| `discovery.py` | 1 function | `discover_ha_config` |
| `config.py` | 2 functions | `configure_warm_spare`, `trigger_failover` |
| `agent_tools.py` | 3 schemas | meraki-specialist tools |
| `safety.py` | DANGEROUS | Failover causes brief outage |

---

## Implementation Pattern

This story follows the standardized 7-step implementation pattern:

1. `api.py` -- Add SDK wrapper methods with `@log_api_call`
2. `discovery.py` -- Add discovery function with `client.safe_call()`
3. `config.py` -- Add config function with backup + `ConfigResult`
4. `agent_router.py` -- Register in `FUNCTION_REGISTRY`
5. `agent_tools.py` -- Add tool schemas + TOOL_SAFETY classification
6. `safety.py` -- Register in `SAFETY_CLASSIFICATION`
7. `tests/` -- Add comprehensive tests

**Note:** Both `SAFETY_CLASSIFICATION` (safety.py) and `TOOL_SAFETY` (agent_tools.py) must be updated.

---

## Tasks

- [ ] Add `get_warm_spare`, `update_warm_spare`, `swap_warm_spare` to api.py with `@log_api_call`
- [ ] Add `discover_ha_config` to discovery.py with `client.safe_call()`
- [ ] Add `configure_warm_spare` and `trigger_failover` to config.py with backup + `ConfigResult`
- [ ] Register HA functions in FUNCTION_REGISTRY (agent_router.py)
- [ ] Add 3 tool schemas to agent_tools.py (meraki-specialist)
- [ ] Register safety classifications in safety.py (DANGEROUS) and agent_tools.py (TOOL_SAFETY)
- [ ] Add `no_ha_configured` issue detection to `find_issues()`
- [ ] Integrate HA status into `full_discovery()` output
- [ ] Implement dry-run mode for HA changes
- [ ] Implement CONFIRM typing requirement for `trigger_failover`
- [ ] Add tests (target: >= 90% coverage)
- [ ] Verify all schemas pass `validate_tool_schema()` with `additionalProperties: False`

---

## File List

(To be populated during implementation)

---

## Dependencies

- Phase 1 complete (Epics 8-10)
- MX appliances must be present in network (product type guard: `appliance`)
- Warm spare requires MX firmware >= 16.x
- Requires spare MX device (same model or higher)

---

## Testing

**Target:** >= 90% coverage

**Test Files:**
- `tests/test_epic12_switching.py`

**Test Scenarios:**
1. API wrappers: verify SDK calls and `@log_api_call` decorator
2. Discovery: verify HA data structure with primary/spare status
3. Config: verify backup creation before HA changes
4. Issue detection: verify `no_ha_configured` detection logic
5. Safety: verify DANGEROUS classification requires confirmation
6. Dry-run: verify preview mode without applying changes
7. Product type guard: verify early-exit when no appliances present
8. Integration: verify HA status in `full_discovery()` output
9. Failover: verify CONFIRM typing requirement for `trigger_failover`

---
