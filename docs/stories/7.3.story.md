# Story 7.3: Router Integration & Feature Flag

> **Epic:** 7 - Deterministic Task Executor & Modular Agent Architecture
> **Sprint:** S6-S7 (Week 1-2)
> **Priority:** P0 (integration)
> **Points:** 10
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** Story 7.1 (Task Executor), Story 7.2 (Task Registry)

---

## Status

**Draft**

---

## Story

**As a** CNL platform developer,
**I want** the existing Router to check for modular task definitions before falling back to the legacy LLM flow,
**so that** deterministic tasks execute via task_executor while unmatched messages use the existing path.

---

## Acceptance Criteria

### ClassificationResult Extension

1. `ClassificationResult` dataclass gains new optional field: `task_definition: Optional[TaskDefinition] = None`
2. When `task_definition` is set, it means the message matched a modular task
3. Existing fields (`agent_name`, `confidence`, `reasoning`, `requires_confirmation`) remain unchanged

### classify_intent() Modification

4. `classify_intent()` gains a new priority layer: `find_matching_task(message)` AFTER explicit prefix
5. Priority order becomes: (1) explicit prefix → (2) task match WITH verb check → (3) regex → (4) LLM fallback (amended per Architect HIGH-1)
6. When task match found: `confidence=1.0`, `reasoning=f"Matched task: {task_match.name}"`, `task_definition=task_match`
7. When no task match: existing flow continues unchanged

### process_message() Modification

8. `process_message()` checks `classification.task_definition` BEFORE entering LLM flow
9. If `task_definition` exists: delegate to `task_executor.execute()` and yield all chunks
10. If `task_definition` is None: existing LLM flow runs (load .md, chat_completion, tool_calls)
11. Both paths yield the same streaming dict format (compatible with WebSocket handler)

### Feature Flag

12. Settings gains `use_modular_tasks: bool = True` field
13. When `use_modular_tasks=False`: skip task registry check entirely (pure legacy mode)
14. Feature flag controllable via settings endpoint (`PUT /api/settings`)
15. Log message when routing to task_executor: `"Routing to task_executor: {task_name}"`
16. Log message when routing to legacy flow: `"Routing to legacy LLM flow for agent: {agent_name}"`

### WebSocket Gate Confirmation Support (CRITICAL-2 Amendment)

17. Modify WebSocket handler in `server.py` to support gate step confirmation
18. When receiving `{"type": "confirmation_required", "_event": event}` from task executor, store the `event` reference keyed by `request_id`
19. When user sends `{"type": "confirm", "request_id": rid}`, look up the stored event and call `event.set()` to resume the generator
20. When user sends `{"type": "deny", "request_id": rid}`, set a denial flag and `event.set()` — executor checks denial and aborts
21. Pending confirmation events expire after 300s (same timeout as executor's `asyncio.wait_for`)

### Backward Compatibility

22. All existing tests pass without modification
23. Messages that don't match any modular task route to legacy flow identically
24. Explicit prefix routing (`@analyst`, `@specialist`) still takes priority over task match
25. WebSocket handler changes are additive — existing message types unchanged

---

## Technical Notes

### Modified Files
- `scripts/agent_router.py` — modify `classify_intent()` and `process_message()`
- `scripts/settings.py` — add `use_modular_tasks` field
- `scripts/server.py` — modify WebSocket handler for gate confirmation (CRITICAL-2)

### Key Design Decision
Explicit prefix (@analyst, @specialist) takes priority FIRST. Task registry check is SECOND — after prefix but before regex/LLM. This prevents keyword collisions where analysis queries match configuration tasks (HIGH-1).

### Gate Confirmation WebSocket Pattern (CRITICAL-2)
```python
# In WebSocket handler (server.py):
pending_confirmations: dict[str, asyncio.Event] = {}

# When task_executor yields confirmation_required:
if chunk.get("type") == "confirmation_required":
    event = chunk.pop("_event")  # Remove internal field before sending to client
    pending_confirmations[chunk["request_id"]] = event
    await websocket.send_json(chunk)

# When client confirms:
elif msg_type == "confirm":
    rid = data.get("request_id")
    if rid in pending_confirmations:
        pending_confirmations[rid].set()
        del pending_confirmations[rid]
```

### Risk Mitigation
- Feature flag defaults to `True` (new behavior)
- Setting it to `False` instantly reverts to pure legacy mode
- No code deletion — legacy path preserved in full

---

## Integration Verification

- **IV1:** process_message yields same dict types from both paths (verified by existing WebSocket tests)
- **IV2:** All 31 existing agent_router tests continue passing
- **IV3:** Feature flag toggle takes effect without server restart
- **IV4:** server.py WebSocket handler correctly stores and triggers confirmation events (CRITICAL-2)

---

## Dependencies

| Direction | Story | Title | Status |
|-----------|-------|-------|--------|
| Blocked by | 7.1 | Task Executor Core Engine | Draft |
| Blocked by | 7.2 | YAML Frontmatter Parser | Draft |
| Blocks | 7.5 | Network Analyst Migration | Draft |
| Blocks | 7.6 | Meraki Specialist Migration | Draft |

---

## Tasks

- [ ] Add `task_definition` field to ClassificationResult
- [ ] Add `use_modular_tasks` to Settings
- [ ] Initialize TaskRegistry at module level in agent_router.py
- [ ] Modify classify_intent(): add task match AFTER explicit prefix, BEFORE regex (HIGH-1)
- [ ] Modify process_message(): add task_executor branch
- [ ] Modify server.py WebSocket handler: add gate confirmation support (CRITICAL-2)
- [ ] Implement pending_confirmations dict with event storage and cleanup
- [ ] Add logging for routing decisions
- [ ] Verify all 31 existing agent_router tests still pass
- [ ] Write new tests for task routing path (target: 15+ tests)
- [ ] Write integration test: task match → executor flow
- [ ] Write integration test: no task match → legacy flow
- [ ] Write test: feature flag off → legacy flow always
- [ ] Write test: gate confirmation via WebSocket (event.set() flow)
- [ ] Write test: gate denial via WebSocket

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `scripts/agent_router.py` | MODIFY | Add task registry check + executor branch |
| `scripts/settings.py` | MODIFY | Add use_modular_tasks field |
| `scripts/server.py` | MODIFY | WebSocket gate confirmation support — CRITICAL-2 |
| `tests/test_router_integration.py` | CREATE | Integration tests for dual-path routing + gate confirmation |

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Quality Gate**: All existing tests pass, backward compatibility verified, feature flag functional
