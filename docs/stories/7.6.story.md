# Story 7.6: Meraki Specialist Skill Migration

> **Epic:** 7 - Deterministic Task Executor & Modular Agent Architecture
> **Sprint:** S7 (Week 2)
> **Priority:** P1 (migration)
> **Points:** 8
> **Type:** Backend/Content
> **Agent:** @dev
> **Depends on:** Story 7.1 (Task Executor), Story 7.2 (Task Registry), Story 7.3 (Router Integration), Story 7.4 (New Registry Entries)

---

## Status

**Draft**

---

## Story

**As a** CNL platform developer,
**I want** the Meraki Specialist's 6 modular task files to have YAML frontmatter with deterministic steps including mandatory safety gates,
**so that** configuration changes always follow backup → preview → confirm → apply → verify sequence.

---

## Acceptance Criteria

### Skill Files Unpacked

1. Extract `CNL_agents/meraki-specialist-skill.zip` to `CNL_agents/meraki-specialist/`
2. Directory structure matches spec: `tasks/`, `schemas/`, `hooks/`, `references/`
3. 16 files present (SKILL.md + 6 tasks + 3 schemas + 2 hooks + 4 references)

### YAML Frontmatter Added to Tasks

4. `tasks/configure-wireless.md` — steps: parse_intent → resolve_targets → backup_current_state → generate_preview → confirm (gate) → apply_changes → verify
5. `tasks/configure-switching.md` — steps: parse_intent → resolve_targets → catalyst_detection → sgt_preflight_check → backup_current_state → generate_preview → confirm (gate) → apply_changes → verify
6. `tasks/configure-security.md` — steps: parse_intent → resolve_targets → backup_current_state → generate_preview → confirm (gate) → apply_changes → verify
7. `tasks/configure-monitoring.md` — steps: parse_intent → resolve_targets → apply_changes → verify (no gate — monitoring is low risk)
8. `tasks/rollback.md` — steps: parse_intent → list_backups → select_backup (gate) → rollback_config → verify
9. `tasks/executar-especifico.md` — steps: parse_intent (agent) → resolve_targets → safety_check (gate if dangerous) → execute (agent) → verify

### Mandatory Safety Pattern for Write Tasks

10. Every write task (wireless, switching, security) MUST have `backup_current_state` step BEFORE any changes
11. Every write task MUST have a `gate` step (confirmation) BEFORE apply
12. Every write task MUST have a `verify` step AFTER apply
13. `configure-switching` additionally requires `catalyst_detection` and `sgt_preflight_check` BEFORE backup

### Trigger Keywords Defined

14. `configure-wireless`: [ssid, wifi, wireless, splash page, bandwidth limit, rf profile, radio]
15. `configure-switching`: [vlan, acl, switch port, qos, trunk, stp, port config, access port, sgt]
16. `configure-security`: [firewall, l3 rule, l7 rule, nat, vpn, traffic shaping, content filter]
17. `configure-monitoring`: [alert, snmp, syslog, camera, motion alert, notification]
18. `rollback`: [rollback, undo, revert, restore, go back, undo change]
19. `executar-especifico`: (no keywords — fallback task for meraki-specialist agent)

### Risk Levels

20. `configure-wireless`: `risk_level: high`
21. `configure-switching`: `risk_level: high`
22. `configure-security`: `risk_level: high`
23. `configure-monitoring`: `risk_level: medium`
24. `rollback`: `risk_level: high`
25. `executar-especifico`: `risk_level: high`

### Legacy .md Preserved

26. `.claude/agents/meraki-specialist.md` remains as fallback (NOT deleted)
27. Legacy .md reduced to identity-only prompt (agent name, role, personality)
28. Step instructions removed from legacy .md and moved to modular tasks

---

## Technical Notes

### Critical Safety Difference
Unlike Network Analyst (read-only), Meraki Specialist tasks WRITE to the network. The step sequence is non-negotiable:

```
backup → preview → gate(confirm) → apply → verify
```

This is the core value proposition of the task executor: these steps are enforced by Python, not by LLM good behavior.

### Catalyst Detection Flow (configure-switching only)
```
catalyst_detection(serial)
  → if mode=monitored → ABORT with error "Device is in monitored mode, writes blocked"
sgt_preflight_check(serial)
  → if has_sgt_restriction → WARN user about locked ports
  → proceed to backup
```

### Hooks
- `hooks/pre-task.md` → detect_catalyst_mode + SGT preflight + license check + backup
- `hooks/post-task.md` → audit log + changelog + handoffs + error handling

---

## Integration Verification

- **IV1:** `find_matching_task("configure VLAN 100 on switch X")` returns `configure-switching`
- **IV2:** `find_matching_task("add firewall rule to block port 23")` returns `configure-security`
- **IV3:** `find_matching_task("undo last change")` returns `rollback`
- **IV4:** `configure-switching` always runs catalyst_detection before any write
- **IV5:** All write tasks always create backup before applying changes

## Testing

- `python -m pytest tests/test_specialist_migration.py -v`
- `python -m pytest tests/test_task_registry.py -v`

---

## Dependencies

| Direction | Story | Title | Status |
|-----------|-------|-------|--------|
| Blocked by | 7.1 | Task Executor Core Engine | Draft |
| Blocked by | 7.2 | YAML Frontmatter Parser | Draft |
| Blocked by | 7.3 | Router Integration | Draft |
| Blocked by | 7.4 | New FUNCTION_REGISTRY Entries | Draft |

---

## Tasks

- [ ] Extract meraki-specialist-skill.zip to CNL_agents/meraki-specialist/
- [ ] Add YAML frontmatter to configure-wireless.md
- [ ] Add YAML frontmatter to configure-switching.md (with catalyst/SGT steps)
- [ ] Add YAML frontmatter to configure-security.md
- [ ] Add YAML frontmatter to configure-monitoring.md
- [ ] Add YAML frontmatter to rollback.md
- [ ] Add YAML frontmatter to executar-especifico.md
- [ ] Define trigger_keywords for each task
- [ ] Reduce .claude/agents/meraki-specialist.md to identity-only
- [ ] Write integration tests: keyword matching (target: 12+ tests)
- [ ] Write e2e test: configure-switching → full safety sequence
- [ ] Write test: catalyst_detection abort when monitored

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `CNL_agents/meraki-specialist/tasks/*.md` | MODIFY | Add YAML frontmatter |
| `CNL_agents/meraki-specialist/SKILL.md` | VERIFY | Hub file intact |
| `.claude/agents/meraki-specialist.md` | MODIFY | Reduce to identity-only |
| `tests/test_specialist_migration.py` | CREATE | Migration integration tests |

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Quality Gate**: All 6 tasks parseable, safety sequence enforced, catalyst detection blocks writes on monitored devices
