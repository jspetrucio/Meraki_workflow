# Epic 7 — Technical Architecture Review

> **Reviewer:** @architect (Aria)
> **Date:** 2026-02-07
> **Status:** APPROVED WITH CONDITIONS
> **Verdict:** Architecture is sound. 6 issues found (2 CRITICAL, 2 HIGH, 2 MEDIUM). All addressable without redesign.

---

## 1. Executive Summary

The Epic 7 stories describe a well-structured brownfield addition that layers a deterministic Python task executor on top of the existing agent router. The core decisions are validated against the actual codebase:

| Decision | Validated | Notes |
|----------|-----------|-------|
| Reuse `_execute_function()` | PARTIAL | Private function — needs extraction (see CRITICAL-1) |
| Reuse `backup_config()` / `rollback_config()` | YES | Signatures match, auto-injection compatible |
| AsyncGenerator streaming | YES | Same contract as `process_message()` → WebSocket handler |
| JSON file-based state | YES | Consistent with `clients/{name}/` pattern |
| Feature flag on Settings | YES | `Settings` is a simple `@dataclass`, field addition trivial |
| FUNCTION_REGISTRY unmodified | YES | Dict of `str → callable`, easy to add entries |

---

## 2. CRITICAL Issues

### CRITICAL-1: `_execute_function` and `_serialize_result` Are Private

**Files:** `scripts/agent_router.py` lines 466-554
**Stories affected:** 7.1, 7.3

Story 7.1 says: *"Import `_execute_function` and `_serialize_result` from `agent_router.py`"*

**Problem:** Both functions are prefixed with `_` (Python private convention) and are NOT exported in `scripts/__init__.py`. Importing them directly from `agent_router` is technically possible but violates encapsulation. More importantly, `_execute_function` depends on module-level `FUNCTION_REGISTRY` and uses `SettingsManager.load()` internally for auto-injection.

**Required action:** Extract both functions into `scripts/executor_utils.py` as the feature doc already suggests as "optional". This should be **mandatory** for Story 7.1, not optional.

```python
# scripts/executor_utils.py (new file)
from scripts.agent_router import FUNCTION_REGISTRY, _serialize_result

async def execute_function(func_name, args, registry=None):
    """Public wrapper — same logic as agent_router._execute_function."""
    registry = registry or FUNCTION_REGISTRY
    ...
```

**Impact on stories:** Add `executor_utils.py` to Story 7.1 file list. Story 7.3 imports from utils instead of router.

---

### CRITICAL-2: Gate Step Has No Real Confirmation Handling in WebSocket

**Files:** `scripts/server.py` lines 575-587
**Stories affected:** 7.1, 7.3

Story 7.1 AC#11 says: *"gate step yields `{"type": "confirmation_required", ...}` and pauses"*

**Problem:** The WebSocket handler in `server.py` has a `confirm` message type handler (line 575) but it merely sends back a text acknowledgment — it does NOT resume the `process_message` generator. The `async for chunk in process_message(...)` loop on line 530 runs to completion with no mechanism to pause/resume.

An AsyncGenerator cannot "pause" in the middle — once you `yield`, control returns to the consumer (WebSocket handler), and you need a mechanism to send confirmation back IN to the generator.

**Required action:** Story 7.1 must define a confirmation mechanism. Options:

1. **Event-based pause** (recommended): Use `asyncio.Event` that the gate step `await`s. WebSocket handler sets the event when user confirms.
2. **Split execution**: Gate step saves state and returns. Confirmation triggers a new `execute()` call that resumes from the saved step.
3. **Callback injection**: Pass a `confirm_callback` coroutine to `execute()` that the gate step calls.

**Recommendation:** Option 1 is cleanest for AsyncGenerator pattern:

```python
# In TaskExecutor.execute():
elif step.type == "gate":
    confirm_event = asyncio.Event()
    yield {"type": "confirmation_required", "request_id": rid, "_event": confirm_event}
    # Pauses here until WebSocket handler calls confirm_event.set()
    await asyncio.wait_for(confirm_event.wait(), timeout=300)
```

**Impact on stories:**
- Story 7.1: Add confirmation event mechanism to AC#11
- Story 7.3: WebSocket handler must be modified (currently says "no changes needed" — INCORRECT)
- Story 7.3 file list: Add `scripts/server.py` as MODIFY

---

## 3. HIGH Issues

### HIGH-1: Keyword Collision Between Task Registry and Legacy Router

**Stories affected:** 7.2, 7.3, 7.7

Story 7.3 AC#5 says: *"Priority order becomes: (1) task match → (2) explicit prefix → (3) regex → (4) LLM fallback"*

**Problem:** If task registry runs FIRST and matches on keywords like "vlan" or "firewall", it will catch messages like "what VLANs do I have?" and route to `configure-switching` instead of `network-analyst`. The keyword matching in Story 7.2 (AC#11: *"case-insensitive, matches whole words, returns highest-overlap task"*) is too aggressive without verb context.

**Required action:** `find_matching_task()` MUST incorporate verb-awareness (same logic as Story 7.7's verb pre-pass) or Story 7.3 priority should be:

```
(1) explicit prefix → (2) task match WITH verb check → (3) regex → (4) LLM fallback
```

Alternatively, move task match AFTER explicit prefix (which is already the case by the code) and add a minimum keyword-match threshold (e.g., at least 2 keywords must match, or verb must be present).

**Impact on stories:**
- Story 7.2: `find_matching_task()` needs verb-awareness, not just keyword counting
- Story 7.7: Verb pre-pass becomes a shared utility used by BOTH router and registry

---

### HIGH-2: Safety Layer Integration Missing from Task Executor

**Files:** `scripts/safety.py`
**Stories affected:** 7.1

The existing `safety.py` has a complete safety pipeline: `classify_operation()`, `before_operation()` (auto-backup), `generate_confirmation_request()`, `process_confirmation_response()`, `execute_dry_run()`, `execute_undo()`. The task executor stories make NO mention of integrating with this existing safety layer.

**Problem:** Story 7.1 designs its own safety pattern (pre-task hooks, gate steps, change_log for rollback) which duplicates functionality already in `safety.py`. This creates two parallel safety systems:

1. `safety.py` — used by legacy `process_message()` path
2. Task executor hooks — used by new deterministic path

**Required action:** Story 7.1 should either:

**Option A (recommended):** Have the task executor call into `safety.py` functions within tool steps:
- `before_operation()` in pre-task hook (creates backup, returns backup info)
- `classify_operation()` to determine if gate step is needed dynamically
- `execute_undo()` for rollback (instead of custom change_log logic)

**Option B:** Document that the task executor's step-based safety REPLACES the safety.py approach for deterministic tasks, and safety.py remains only for legacy path.

**Impact on stories:**
- Story 7.1: Add AC clarifying safety.py integration vs. replacement
- Story 7.1: Technical notes should reference safety.py functions

---

## 4. MEDIUM Issues

### MEDIUM-1: update_vlan Uses **kwargs — Schema Validation Risk

**File:** `scripts/config.py` line 411-463
**Stories affected:** 7.7

`update_vlan()` uses `**kwargs` which means ANY parameter gets passed through to the Meraki API. Story 7.7 proposes adding DHCP/DNS fields to the schema but the function itself already accepts them via kwargs.

**Problem:** The issue isn't the function — it's the `agent_tools.py` schema that doesn't list them. When the LLM calls `update_vlan`, it won't know about DHCP fields because they're not in the tool schema.

**Required action:** Story 7.7 only needs to update `agent_tools.py` schema. The config.py change is unnecessary (kwargs already passes everything through). Remove the config.py task from Story 7.7.

---

### MEDIUM-2: Data Model Split Between task_executor.py and task_registry.py

**Stories affected:** 7.1, 7.2

Both Story 7.1 and 7.2 define `TaskDefinition` and `StepDefinition`. Story 7.2 notes "shared with 7.1" but doesn't specify WHERE the canonical definition lives.

**Required action:** Create `scripts/task_models.py` containing ALL shared data models:
- `TaskDefinition`, `StepDefinition` (used by 7.1 and 7.2)
- `TaskRunState`, `StepResult`, `ChangeEntry` (used by 7.1)
- `TaskParseError` (used by 7.2)

Both `task_executor.py` and `task_registry.py` import from `task_models.py`.

**Impact on stories:**
- Add `scripts/task_models.py` (CREATE) to Story 7.1 file list
- Story 7.2 imports from task_models.py instead of defining its own

---

## 5. Validated Assumptions (No Issues)

| Assumption | Verified Against |
|------------|-----------------|
| `agent_router.py` has ~749 lines | YES — exactly 749 lines |
| `ClassificationResult` is a simple dataclass | YES — 4 fields, no inheritance, line 53-69 |
| `_execute_function` uses `asyncio.to_thread()` | YES — line 546 |
| `_execute_function` auto-injects client, client_name, org_id | YES — lines 519-542 |
| `FUNCTION_REGISTRY` is a flat dict[str, callable] | YES — built by `_build_function_registry()` line 171-229 |
| `backup_config` returns Path | YES — line 132 |
| `rollback_config` returns ConfigResult | YES — line 208 |
| `check_switch_port_writeability` exists | YES — line 831-911, returns SwitchPortPreflight |
| `ai_engine.chat_completion` supports stream=True | YES — returns AsyncGenerator, line 101-197 |
| `ai_engine.classify` uses function-calling | YES — line 265-357 |
| `Settings` is a @dataclass | YES — line 28, easy to add fields |
| WebSocket handler iterates process_message chunks | YES — `async for chunk in process_message(...)` line 530-536 |
| `_quick_classify()` uses regex pattern matching | YES — line 254-348, keyword weights |
| `process_message()` yields dict with `type` key | YES — classification, stream, function_result, error types |
| YAML (pyyaml) is available | YES — listed in requirements, used elsewhere |

---

## 6. Dependency Graph Validation

```
7.1 (Executor) ─────┐
                     ├─→ 7.3 (Router Integration) ─→ 7.5 (Analyst Migration)
7.2 (Registry) ─────┘                              ─→ 7.6 (Specialist Migration)
                                                          ↑
7.4 (New Functions) ──────────────────────────────────────┘

7.7 (Bug Fixes) ── independent
```

**Validation:** Correct. Wave plan is sound:
- Wave 1: 7.1, 7.2, 7.4, 7.7 (all independent)
- Wave 2: 7.3 (depends on 7.1 + 7.2)
- Wave 3: 7.5 + 7.6 (depends on 7.3 + 7.4)

---

## 7. Story Point Assessment

| Story | PM Points | Architect Assessment | Notes |
|-------|-----------|---------------------|-------|
| 7.1 | 13 | 13 (accurate) | Largest story, includes executor_utils.py extraction and confirmation mechanism |
| 7.2 | 5 | 5 (accurate) | Straightforward YAML parsing + registry |
| 7.3 | 8 | **10** (underestimated) | WebSocket handler modification for gate confirmation adds complexity |
| 7.4 | 5 | 5 (accurate) | 4 wrapper functions + schemas |
| 7.5 | 5 | 5 (accurate) | Content work, YAML frontmatter |
| 7.6 | 8 | 8 (accurate) | More tasks, safety sequence validation |
| 7.7 | 3 | **2** (overestimated) | config.py change unnecessary, only schema + regex |

**Revised total:** 48 (was 47)

---

## 8. Required Story Amendments

### Story 7.1 — Amendments Required
1. Add `scripts/executor_utils.py` to file list (CRITICAL-1)
2. Add `scripts/task_models.py` to file list (MEDIUM-2)
3. Add confirmation event mechanism to AC#11 (CRITICAL-2)
4. Add AC clarifying safety.py integration (HIGH-2)
5. Reference safety.py functions in Technical Notes

### Story 7.2 — Amendments Required
1. `find_matching_task()` must incorporate verb-awareness (HIGH-1)
2. Import data models from `task_models.py` (MEDIUM-2)

### Story 7.3 — Amendments Required
1. Add `scripts/server.py` to file list as MODIFY (CRITICAL-2)
2. Points increase from 8 → 10
3. Add AC for WebSocket handler gate confirmation support
4. Clarify that explicit prefix still takes priority over task match

### Story 7.7 — Amendments Required
1. Remove config.py modification task (MEDIUM-1)
2. Points decrease from 3 → 2
3. Verb pre-pass should be a shared utility (HIGH-1)

---

## 9. Risk Assessment

| Risk | Severity | Mitigation |
|------|----------|------------|
| Gate confirmation mechanism complexity | HIGH | Use asyncio.Event pattern, add 2 extra tests |
| Keyword collision false positives | MEDIUM | Verb-aware matching, minimum threshold |
| Two parallel safety systems (safety.py vs hooks) | MEDIUM | Document boundary: hooks for new path, safety.py for legacy |
| Large blast radius on agent_router.py | LOW | Feature flag + executor_utils extraction minimizes changes |
| Task .md files malformed in production | LOW | Strict validation in parser, graceful fallback to legacy |

---

## 10. Final Verdict

**APPROVED WITH CONDITIONS.** The architecture is fundamentally sound and the wave plan is correct. The 2 CRITICAL issues must be addressed in the stories before implementation begins:

1. **Extract `_execute_function` to public module** (simple refactor)
2. **Define gate confirmation mechanism** (requires design decision on asyncio.Event vs. state-split)

The 2 HIGH issues should be addressed but can be resolved during implementation if needed.

Proceed to @sm for sprint planning.

---

*— Aria, arquitetando o futuro*
