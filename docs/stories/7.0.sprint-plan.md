# Epic 7 — Sprint Plan

> **Scrum Master:** @sm (River)
> **Date:** 2026-02-07
> **Status:** READY FOR EXECUTION
> **Tech Review:** APPROVED WITH CONDITIONS (all conditions addressed in story amendments)
> **Total Points:** 48 (revised from 47 per architect assessment)

---

## 1. Summary of Architect Amendments Applied

All 6 issues from `7.0.tech-review.md` have been incorporated into the stories:

| Issue | Severity | Story | Amendment Applied |
|-------|----------|-------|-------------------|
| CRITICAL-1: Private function extraction | CRITICAL | 7.1 | Added `executor_utils.py` to file list and tasks |
| CRITICAL-2: Gate confirmation mechanism | CRITICAL | 7.1, 7.3 | Added asyncio.Event pattern to AC#11, WebSocket handler mods to 7.3 |
| HIGH-1: Keyword collision | HIGH | 7.2, 7.3, 7.7 | Verb-aware matching, shared `verb_utils.py`, priority reorder |
| HIGH-2: Safety layer integration | HIGH | 7.1 | Added safety.py integration ACs (29-33), referenced in Technical Notes |
| MEDIUM-1: update_vlan kwargs | MEDIUM | 7.7 | Removed config.py task, points 3→2 |
| MEDIUM-2: Shared data models | MEDIUM | 7.1, 7.2 | Added `task_models.py` to 7.1, imports in 7.2 |

---

## 2. Point Distribution (Revised)

| Story | Title | Points | Type | Sprint |
|-------|-------|--------|------|--------|
| 7.1 | Task Executor Core Engine | 13 | Backend/Python | S6 W1 |
| 7.2 | YAML Frontmatter Parser & Task Registry | 5 | Backend/Python | S6 W1 |
| 7.3 | Router Integration & Feature Flag | **10** | Backend/Python | S6-S7 |
| 7.4 | New FUNCTION_REGISTRY Entries | 5 | Backend/Python | S6 W1 |
| 7.5 | Network Analyst Skill Migration | 5 | Backend/Content | S7 W2 |
| 7.6 | Meraki Specialist Skill Migration | 8 | Backend/Content | S7 W2 |
| 7.7 | Bug Fixes (Router Regex + Schema) | **2** | Backend/Python | S6 W1 |
| **Total** | | **48** | | |

---

## 3. Wave Execution Plan

### Wave 1 — Foundation (All Independent, Parallel)
**Sprint:** S6 Week 1
**Points:** 25 (13 + 5 + 5 + 2)
**Estimated Duration:** 2-3 days

| Story | Agent | Priority | Notes |
|-------|-------|----------|-------|
| 7.1 | @dev | P0 | Largest story. Creates task_models.py, executor_utils.py, task_executor.py |
| 7.2 | @dev | P0 | Creates task_registry.py, verb_utils.py. Depends on task_models.py from 7.1 but models are simple — can develop in parallel with 7.1 if models defined first |
| 7.4 | @dev | P1 | 4 new functions in config.py + schemas in agent_tools.py |
| 7.7 | @dev | P2 | Quick fix: verb pre-pass in _quick_classify() + update_vlan schema |

**Parallelization Strategy:**
```
@dev Agent 1: Story 7.1 (task_models.py FIRST, then executor_utils.py, then task_executor.py)
@dev Agent 2: Story 7.2 + 7.7 (verb_utils.py shared between both, task_registry.py, then verb pre-pass fix)
@dev Agent 3: Story 7.4 (completely independent — new functions in config.py)
```

**Critical Path:** Story 7.1 must produce `task_models.py` early — Story 7.2 imports from it.

**Wave 1 Definition of Done:**
- [ ] task_models.py created with all shared data models
- [ ] executor_utils.py created with public execute_function/serialize_result
- [ ] task_executor.py created with full step dispatcher + asyncio.Event gate
- [ ] task_registry.py created with verb-aware find_matching_task
- [ ] verb_utils.py created with shared ACTION_VERBS/ANALYSIS_VERBS
- [ ] 4 new functions in config.py (detect_catalyst_mode, sgt_preflight_check, check_license, backup_current_state)
- [ ] _quick_classify() has verb-aware pre-pass
- [ ] update_vlan schema completed in agent_tools.py
- [ ] All existing 268 tests still pass
- [ ] New tests: ~75+ (30 executor + 20 registry + 16 functions + 8 verb)

---

### Wave 2 — Integration (Depends on Wave 1)
**Sprint:** S6 Week 1 (tail) - S7 Week 2 (start)
**Points:** 10
**Estimated Duration:** 1-2 days

| Story | Agent | Priority | Blocked By |
|-------|-------|----------|------------|
| 7.3 | @dev | P0 | 7.1 + 7.2 |

**Why 10 Points (upgraded from 8):**
- WebSocket handler modification for gate confirmation (CRITICAL-2) adds significant complexity
- Must modify 3 files (agent_router.py, settings.py, server.py) instead of 2
- Gate confirmation testing requires async WebSocket simulation

**Wave 2 Definition of Done:**
- [ ] classify_intent() has task match layer (after prefix, before regex)
- [ ] process_message() branches to task_executor when task_definition present
- [ ] server.py WebSocket handles confirm/deny with asyncio.Event
- [ ] Feature flag use_modular_tasks in Settings
- [ ] All 31 existing agent_router tests still pass
- [ ] New tests: ~15+ (routing + gate confirmation)

---

### Wave 3 — Migration (Depends on Wave 2 + 7.4)
**Sprint:** S7 Week 2
**Points:** 13 (5 + 8)
**Estimated Duration:** 2 days

| Story | Agent | Priority | Blocked By |
|-------|-------|----------|------------|
| 7.5 | @dev | P1 | 7.1, 7.2, 7.3 |
| 7.6 | @dev | P1 | 7.1, 7.2, 7.3, 7.4 |

**Parallelization:** 7.5 and 7.6 are fully independent of each other and can run in parallel.

```
@dev Agent 1: Story 7.5 (Network Analyst — 5 tasks, read-only, no gates)
@dev Agent 2: Story 7.6 (Meraki Specialist — 6 tasks, write safety, gates required)
```

**Wave 3 Definition of Done:**
- [ ] CNL_agents/network-analyst/ extracted with YAML frontmatter on all 5 tasks
- [ ] CNL_agents/meraki-specialist/ extracted with YAML frontmatter on all 6 tasks
- [ ] All specialist write tasks follow backup→preview→gate→apply→verify sequence
- [ ] configure-switching has catalyst_detection + sgt_preflight_check steps
- [ ] Legacy .md files reduced to identity-only
- [ ] Keyword matching tests pass for both agents
- [ ] New tests: ~22+ (10 analyst + 12 specialist)

---

## 4. Dependency Graph

```
Wave 1 (parallel):
  7.1 (Executor) ─────┐
  7.2 (Registry) ─────┤
  7.4 (Functions) ─────┤──→ Wave 2:
  7.7 (Bug Fixes) ─────┘      7.3 (Router Integration) ──→ Wave 3 (parallel):
                                                              7.5 (Analyst Migration)
                               7.4 (Functions) ──────────────→ 7.6 (Specialist Migration)
```

---

## 5. Risk Register

| Risk | Probability | Impact | Mitigation | Owner |
|------|-------------|--------|------------|-------|
| asyncio.Event gate complexity | Medium | High | Architect provided pattern; add extra tests | @dev (7.1, 7.3) |
| Keyword collision false positives | Medium | Medium | Verb-aware matching + minimum threshold | @dev (7.2, 7.7) |
| executor_utils extraction breaks existing tests | Low | High | Run full test suite after extraction; keep _execute_function as thin wrapper | @dev (7.1) |
| Task .md files malformed in production | Low | Medium | Strict validation in parser, graceful fallback to legacy | @dev (7.2) |
| Safety.py integration scope creep | Low | Medium | Document boundary clearly: hooks orchestrate, safety.py decides | @dev (7.1) |

---

## 6. Quality Gates

### Per-Story Gates
- All existing 268 tests must pass after each story
- New tests meet minimum targets specified in each story
- CodeRabbit integration enabled on all stories
- Classification accuracy >= 96% maintained (Story 7.7)

### Per-Wave Gates
- **Wave 1 Complete:** 75+ new tests, all foundations built, no regressions
- **Wave 2 Complete:** Router dual-path verified, gate confirmation works e2e
- **Wave 3 Complete:** Both agent migrations parseable, safety sequence enforced

### Epic-Level Gate
- Feature flag toggle works: `use_modular_tasks=False` → pure legacy behavior
- Feature flag toggle works: `use_modular_tasks=True` → modular task execution
- All 268 + ~112 new tests pass (estimated total: ~380)

---

## 7. Agent Assignments

| Story | Primary Agent | Specialty Needed |
|-------|--------------|-----------------|
| 7.1 | @dev | Python async, dataclass design, asyncio.Event |
| 7.2 | @dev | YAML parsing, text matching, NLP basics |
| 7.3 | @dev | FastAPI WebSocket, router internals |
| 7.4 | @dev | Meraki API, config.py patterns |
| 7.5 | @dev | Content + YAML frontmatter |
| 7.6 | @dev | Content + safety patterns |
| 7.7 | @dev | Regex, OpenAI schema format |

---

## 8. Execution Order for @dev

```
1. Start Wave 1 (parallel where possible):
   a. Story 7.1 — BEGIN with task_models.py (unblocks 7.2)
   b. Story 7.4 — fully independent, start immediately
   c. Story 7.7 — small, start immediately
   d. Story 7.2 — start after task_models.py exists (or develop models inline, reconcile later)

2. Wave 1 Complete → Start Wave 2:
   e. Story 7.3 — router integration + WebSocket gate

3. Wave 2 Complete → Start Wave 3 (parallel):
   f. Story 7.5 — analyst migration
   g. Story 7.6 — specialist migration
```

## Testing

- `python -m pytest tests/test_task_executor.py -v`
- `python -m pytest tests/test_task_registry.py -v`
- `python -m pytest tests/ -k "test_specialist or test_analyst" -v`

## File Locations

| File | Description |
|------|-------------|
| `scripts/task_executor.py` | Task execution engine |
| `scripts/task_registry.py` | YAML parser and matching |
| `tasks/` | Task definition files |
| `tests/` | Test suite |

---

*— River, removendo obstaculos*
