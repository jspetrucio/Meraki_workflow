# Story 4.1: Tauri App Shell

> **Epic:** 4 - Tauri Desktop Application
> **Sprint:** S6 (Week 5-6)
> **Priority:** P1
> **Points:** 5
> **Type:** Desktop / Rust
> **Agent:** @dev
> **Depends on:** Story 1.1 (FastAPI Server), Story 2.1 (React Scaffold)

---

## Status

**Draft**

---

## Story

**As a** user,
**I want** a native desktop application that I double-click to launch,
**so that** I don't need to run terminal commands to use CNL.

---

## Acceptance Criteria

1. Tauri 2.0 project configured in `src-tauri/`
2. App launches FastAPI server as sidecar process on startup
3. App loads web UI from embedded frontend assets (not localhost in production)
4. App window: 1200x800 default, resizable, min 900x600
5. App title: "Cisco Neural Language"
6. App icon: Custom icon (placeholder acceptable for MVP)
7. Graceful shutdown: kills FastAPI process on app close
8. macOS: `.app` bundle generated via `tauri build`

---

## Integration Verification

- **IV1:** FastAPI backend starts reliably within 3 seconds of app launch
- **IV2:** All web UI features work identically in Tauri wrapper
- **IV3:** App close cleanly terminates all child processes (no orphan Python processes)

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`src-tauri/**/*.rs`** (main.rs, lib.rs -- Tauri sidecar):
- CRITICAL: Child process (Python/uvicorn) must be terminated on app close
- CRITICAL: Port binding must have fallback if 3141 is occupied
- CRITICAL: No `unsafe` blocks without justification
- HIGH: Missing error handling (no bare `unwrap()` on fallible operations)
- HIGH: Resource leaks (file handles, network connections)
- MEDIUM: Clippy warnings, missing docs on public functions

**`src-tauri/tauri.conf.json`**:
- VALIDATE: Security allowlist is minimal (principle of least privilege)
- VALIDATE: CSP headers are restrictive
- VALIDATE: Bundle identifier matches Cisco naming (`com.cisco.cnl`)

### Review Focus for This Story
- Sidecar process must be spawned with proper stdout/stderr piping (not lost)
- Port readiness detection must have timeout (don't wait forever for Python to start)
- Tauri permissions must be scoped to minimum required (no `*` allowlists)
- App should gracefully handle Python not being installed on the system

---

## Tasks / Subtasks

- [ ] **T1: Initialize Tauri 2.0 project** (AC: 1)
  - [ ] T1.1: Install Tauri CLI: `cargo install tauri-cli`
  - [ ] T1.2: Run `cargo tauri init` inside project root → creates `src-tauri/`
  - [ ] T1.3: Configure `Cargo.toml` with dependencies: `tauri`, `serde`, `serde_json`, `tokio`
  - [ ] T1.4: Set Tauri 2.0 features in `Cargo.toml`: `["system-tray"]` (prep for Story 4.2)

- [ ] **T2: Configure `tauri.conf.json`** (AC: 3, 4, 5, 6, 8)
  - [ ] T2.1: Set `build.devUrl` → `http://localhost:5173` (Vite dev server)
  - [ ] T2.2: Set `build.frontendDist` → `../frontend/dist` (production build)
  - [ ] T2.3: Window config: title "Cisco Neural Language", 1200x800, min 900x600, resizable
  - [ ] T2.4: Bundle identifier: `com.cisco.cnl`
  - [ ] T2.5: Bundle targets: `["dmg", "app"]`
  - [ ] T2.6: External binary config: `"externalBin": ["python-sidecar"]`
  - [ ] T2.7: Resources: `"resources": ["scripts/**", "templates/**"]`

- [ ] **T3: Implement Sidecar Manager** (AC: 2, 7)
  - [ ] T3.1: `src-tauri/src/sidecar.rs` — module for Python process management
  - [ ] T3.2: `find_python()` → locate Python binary (bundled → system → error)
  - [ ] T3.3: `start_server()` → spawn `python -m uvicorn scripts.server:app --host 127.0.0.1 --port 3141`
  - [ ] T3.4: `wait_for_health()` → poll `GET /api/v1/health` until 200 or timeout (10s)
  - [ ] T3.5: `stop_server(child: &mut Child)` → send SIGTERM, wait 5s, SIGKILL if needed
  - [ ] T3.6: Store `Child` process handle in Tauri managed state

- [ ] **T4: Implement main.rs** (AC: 2, 7)
  - [ ] T4.1: `src-tauri/src/main.rs` — Tauri builder with sidecar setup
  - [ ] T4.2: In `setup()`: start sidecar, wait for health, manage state
  - [ ] T4.3: Splash screen or loading indicator while server starts
  - [ ] T4.4: `on_window_event(CloseRequested)` → stop sidecar, exit app
  - [ ] T4.5: Handle sidecar crash: show error dialog, offer restart

- [ ] **T5: Create app icons** (AC: 6)
  - [ ] T5.1: Create placeholder icon (CNL logo or Cisco-themed)
  - [ ] T5.2: Generate all required sizes: 32x32, 128x128, 256x256, 512x512, icon.icns
  - [ ] T5.3: Place icons in `src-tauri/icons/`

- [ ] **T6: Dev mode integration** (AC: 3)
  - [ ] T6.1: `tauri dev` launches Vite dev server + FastAPI sidecar simultaneously
  - [ ] T6.2: Hot reload works in Tauri dev mode (Vite HMR proxied through WebView)
  - [ ] T6.3: Verify WebSocket connections work through Tauri WebView

- [ ] **T7: Production build** (AC: 8)
  - [ ] T7.1: `npm run build` in `frontend/` → produces `dist/`
  - [ ] T7.2: `cargo tauri build` → produces `.app` bundle in `src-tauri/target/release/bundle/`
  - [ ] T7.3: Verify `.app` includes embedded frontend assets
  - [ ] T7.4: Verify `.app` includes Python scripts and templates as resources
  - [ ] T7.5: Test `.app` launches successfully on clean macOS install

- [ ] **T8: Write tests**
  - [ ] T8.1: Test sidecar start/stop lifecycle
  - [ ] T8.2: Test health check polling with timeout
  - [ ] T8.3: Test graceful shutdown (no orphan processes)
  - [ ] T8.4: Test fallback when Python not found

---

## Dev Notes

### Tauri Architecture

[Source: architecture.md#5.7 Tauri Desktop App]

```
┌─────────────────────────────────────────┐
│           Tauri Application              │
│                                          │
│  ┌──────────────────────────────────┐   │
│  │         Rust Backend              │   │
│  │  ┌──────────┐ ┌───────────────┐  │   │
│  │  │Sidecar   │ │System Tray    │  │   │
│  │  │Manager   │ │Manager        │  │   │
│  │  │(spawns   │ │(Story 4.2)    │  │   │
│  │  │ uvicorn) │ │               │  │   │
│  │  └────┬─────┘ └───────────────┘  │   │
│  └───────┼──────────────────────────┘   │
│          │                               │
│  ┌───────▼──────────────────────────┐   │
│  │      FastAPI Process              │   │
│  │      (localhost:3141)             │   │
│  └───────▲──────────────────────────┘   │
│          │                               │
│  ┌───────┼──────────────────────────┐   │
│  │      WebView                      │   │
│  │      (loads localhost:3141)       │   │
│  │      System WebView (not Chromium)│   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### Sidecar Manager Pattern

[Source: architecture.md#5.7 Rust Sidecar Manager]

```rust
// src-tauri/src/sidecar.rs
use std::process::{Command, Child};

pub struct SidecarManager {
    process: Option<Child>,
}

impl SidecarManager {
    pub fn new() -> Self {
        Self { process: None }
    }

    pub fn start(&mut self) -> Result<(), String> {
        let python = self.find_python()?;
        let child = Command::new(python)
            .args(["-m", "uvicorn", "scripts.server:app",
                   "--host", "127.0.0.1", "--port", "3141"])
            .spawn()
            .map_err(|e| format!("Failed to start server: {}", e))?;
        self.process = Some(child);
        Ok(())
    }

    pub fn stop(&mut self) {
        if let Some(ref mut child) = self.process {
            let _ = child.kill();
            let _ = child.wait();
        }
        self.process = None;
    }

    fn find_python(&self) -> Result<String, String> {
        // 1. Check bundled python
        // 2. Check system python3
        // 3. Check system python
        for cmd in ["python3", "python"] {
            if Command::new(cmd).arg("--version").output().is_ok() {
                return Ok(cmd.to_string());
            }
        }
        Err("Python not found".to_string())
    }
}

impl Drop for SidecarManager {
    fn drop(&mut self) {
        self.stop();
    }
}
```

### Tauri Configuration Reference

[Source: architecture.md — tauri.conf.json]

```json
{
  "build": {
    "devUrl": "http://localhost:5173",
    "frontendDist": "../frontend/dist"
  },
  "app": {
    "windows": [{
      "title": "Cisco Neural Language",
      "width": 1200,
      "height": 800,
      "minWidth": 900,
      "minHeight": 600,
      "decorations": true,
      "resizable": true
    }]
  },
  "bundle": {
    "identifier": "com.cisco.cnl",
    "active": true,
    "targets": ["dmg", "app"],
    "externalBin": ["python-sidecar"],
    "resources": ["scripts/**", "templates/**"]
  }
}
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Rust main | `src-tauri/src/main.rs` | Tauri builder + sidecar lifecycle |
| Sidecar module | `src-tauri/src/sidecar.rs` | Python process management |
| Tauri config | `src-tauri/tauri.conf.json` | Window, bundle, build settings |
| Cargo config | `src-tauri/Cargo.toml` | Rust dependencies |
| Icons | `src-tauri/icons/` | App icons all sizes |

---

## Testing

- **Framework:** Rust unit tests (`#[cfg(test)]`) + manual integration
- **Location:** `src-tauri/src/sidecar.rs` (inline tests)
- **Manual Tests:**
  - `cargo tauri dev` → app opens, web UI loads, chat works
  - `cargo tauri build` → `.app` created, double-click launches correctly
  - Close app → verify no orphan `python` processes (`ps aux | grep uvicorn`)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
