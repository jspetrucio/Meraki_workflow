# Story 4.2: System Tray & Native Features

> **Epic:** 4 - Tauri Desktop Application
> **Sprint:** S6 (Week 5-6)
> **Priority:** P2
> **Points:** 3
> **Type:** Desktop / Rust
> **Agent:** @dev
> **Depends on:** Story 4.1 (Tauri App Shell)

---

## Status

**Draft**

---

## Story

**As a** user,
**I want** system tray integration and native OS features,
**so that** CNL feels like a proper desktop application.

---

## Acceptance Criteria

1. System tray icon with CNL logo
2. Tray menu: Open CNL, Quick Discovery, Settings, Quit
3. "Quick Discovery" runs discovery for default profile, shows notification when complete
4. Native notifications for: discovery complete, configuration applied, errors
5. Launch on startup option (configurable in settings)
6. Global keyboard shortcut to open/focus CNL window (configurable, default: Cmd+Shift+M)

---

## Integration Verification

- **IV1:** System tray persists when main window is closed
- **IV2:** Quick Discovery produces same results as in-app discovery
- **IV3:** Notifications work on macOS (primary platform)

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`src-tauri/**/*.rs`** (tray.rs -- system tray module):
- CRITICAL: Tray menu handlers must not panic (use Result types)
- HIGH: Resource cleanup on tray icon destruction
- HIGH: No bare `unwrap()` on fallible operations
- MEDIUM: Clippy warnings

**`frontend/src/**/*.tsx`** (UpdateBanner.tsx, AboutSection.tsx):
- HIGH: Component prop typing (no 'any' types)
- HIGH: Hook dependency arrays (useEffect cleanup for update listeners)
- MEDIUM: Accessibility (aria labels on banner dismiss, about dialog)
- MEDIUM: Conditional rendering for update availability states

### Review Focus for This Story
- Menu item click handlers must be non-blocking (no heavy computation on UI thread)
- "Quit" action must trigger proper cleanup (stop Python process, save state)
- Tray tooltip must reflect actual server status (not stale)
- macOS-specific tray behaviors must be handled (template images, dark mode)

---

## Tasks / Subtasks

- [ ] **T1: Create System Tray** (AC: 1, 2)
  - [ ] T1.1: Tray icon from `src-tauri/icons/tray-icon.png` (16x16, 32x32)
  - [ ] T1.2: Tray menu items: "Open CNL", separator, "Quick Discovery", "Settings", separator, "Quit"
  - [ ] T1.3: "Open CNL" → show/focus main window
  - [ ] T1.4: "Quit" → stop sidecar + exit app (full shutdown)
  - [ ] T1.5: "Settings" → show main window + navigate to settings route

- [ ] **T2: Minimize to tray behavior** (AC: 1)
  - [ ] T2.1: Override `CloseRequested` → hide window instead of quitting
  - [ ] T2.2: Tray remains visible when window is hidden
  - [ ] T2.3: Double-click tray icon → show/focus window
  - [ ] T2.4: "Quit" menu item performs actual quit (stops sidecar)

- [ ] **T3: Quick Discovery from tray** (AC: 3)
  - [ ] T3.1: "Quick Discovery" menu click → `POST /api/v1/discovery/full` to sidecar
  - [ ] T3.2: Show notification "Discovery started for {profile}..."
  - [ ] T3.3: On completion → notification "Discovery complete: {n} networks, {n} devices"
  - [ ] T3.4: On error → notification "Discovery failed: {error}"

- [ ] **T4: Native notifications** (AC: 4)
  - [ ] T4.1: Use `tauri-plugin-notification` for cross-platform notifications
  - [ ] T4.2: Notification for discovery completion (title, body, icon)
  - [ ] T4.3: Notification for config applied ("ACL applied to {network}")
  - [ ] T4.4: Notification for errors (critical only, not warnings)
  - [ ] T4.5: Respect macOS notification permissions

- [ ] **T5: Launch on startup** (AC: 5)
  - [ ] T5.1: Use `tauri-plugin-autostart` for login item registration
  - [ ] T5.2: Toggle setting in frontend settings panel (Story 2.5)
  - [ ] T5.3: Read preference from `~/.cnl/settings.json` via backend API
  - [ ] T5.4: Default: disabled

- [ ] **T6: Global keyboard shortcut** (AC: 6)
  - [ ] T6.1: Use `tauri-plugin-global-shortcut` for system-wide shortcut
  - [ ] T6.2: Default shortcut: `Cmd+Shift+M` (macOS), `Ctrl+Shift+M` (others)
  - [ ] T6.3: Shortcut → show/focus main window (toggle)
  - [ ] T6.4: Configurable via settings (store in settings.json)
  - [ ] T6.5: Handle shortcut registration failure gracefully

- [ ] **T7: Write tests**
  - [ ] T7.1: Test tray menu creation and item handlers
  - [ ] T7.2: Test minimize-to-tray behavior
  - [ ] T7.3: Test Quick Discovery HTTP call from tray
  - [ ] T7.4: Test notification permissions check

---

## Dev Notes

### Tauri 2.0 Plugins Required

| Plugin | Purpose | Crate |
|--------|---------|-------|
| `tauri-plugin-notification` | Native OS notifications | `tauri-plugin-notification` |
| `tauri-plugin-autostart` | Launch on login | `tauri-plugin-autostart` |
| `tauri-plugin-global-shortcut` | System-wide hotkey | `tauri-plugin-global-shortcut` |

### System Tray Pattern

[Source: architecture.md#5.7 Tauri Desktop App]

```rust
// src-tauri/src/tray.rs
use tauri::{
    menu::{Menu, MenuItem},
    tray::{TrayIconBuilder, TrayIconEvent},
    Manager,
};

pub fn create_system_tray(app: &tauri::App) -> tauri::Result<()> {
    let open = MenuItem::with_id(app, "open", "Open CNL", true, None::<&str>)?;
    let discovery = MenuItem::with_id(app, "discovery", "Quick Discovery", true, None::<&str>)?;
    let settings = MenuItem::with_id(app, "settings", "Settings", true, None::<&str>)?;
    let quit = MenuItem::with_id(app, "quit", "Quit", true, None::<&str>)?;

    let menu = Menu::with_items(app, &[&open, &discovery, &settings, &quit])?;

    TrayIconBuilder::new()
        .icon(app.default_window_icon().unwrap().clone())
        .menu(&menu)
        .tooltip("CNL - Cisco Neural Language")
        .on_menu_event(move |app, event| {
            match event.id.as_ref() {
                "open" => { /* show/focus window */ }
                "discovery" => { /* POST /api/v1/discovery/full */ }
                "settings" => { /* show window + navigate to /settings */ }
                "quit" => { /* stop sidecar + exit */ }
                _ => {}
            }
        })
        .build(app)?;

    Ok(())
}
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Tray module | `src-tauri/src/tray.rs` | System tray setup + handlers |
| Tray icon | `src-tauri/icons/tray-icon.png` | 16x16/32x32 tray icon |
| Main (updated) | `src-tauri/src/main.rs` | Plugin registration |

---

## Testing

- **Framework:** Rust unit tests (`#[cfg(test)]`) + manual integration
- **Location:** `src-tauri/src/tray.rs` (inline tests)
- **Manual Test Scenarios:**
  - Close window → tray remains → click "Open CNL" → window reappears
  - Click "Quick Discovery" → notification appears with results
  - Set launch on startup → reboot → CNL starts automatically
  - Press Cmd+Shift+M → CNL window appears/focuses

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_tray_menu_items_created() {
        // Verify all 4 menu items exist: Open, Discovery, Settings, Quit
        let items = vec!["open", "discovery", "settings", "quit"];
        assert_eq!(items.len(), 4);
    }

    #[test]
    fn test_shortcut_string_format() {
        let shortcut_mac = "Cmd+Shift+M";
        let shortcut_other = "Ctrl+Shift+M";
        assert!(shortcut_mac.contains("Cmd"));
        assert!(shortcut_other.contains("Ctrl"));
    }
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |
| 2026-02-05 | 0.1.2 | Added frontend path instructions for UpdateBanner/AboutSection per PO validation | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
