# Story 12.5: Air Marshal / Rogue AP Detection

> **Epic:** 12 - Switching, Wireless & Monitoring
> **Sprint:** TBD
> **Priority:** P1 (security monitoring)
> **Points:** 3
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** Phase 1 complete (Epics 8-10)

---

## Status

**Draft**

---

## Story

**As a** security engineer,
**I want** to monitor rogue APs detected by Air Marshal,
**so that** I can identify unauthorized wireless devices through natural language.

---

## Acceptance Criteria

1. `discover_rogue_aps` returns detected rogue APs with classification
2. Data includes BSSID, SSID, channel, signal strength, and containment status
3. Issue detection: `rogue_aps_detected` when uncontained rogues exist
4. Natural language: "are there any rogue APs?" works
5. Rogue AP status integrated into `full_discovery()` output
6. Read-only feature (no config changes)
7. Safety: SAFE classification (read-only monitoring)

---

## Scope

| Layer | New Items | Details |
|-------|-----------|---------|
| `api.py` | 2 methods | `get_air_marshal`, `get_air_marshal_rules` |
| `discovery.py` | 1 function | `discover_rogue_aps` |
| `config.py` | â€” | Read-only feature, no config |
| `agent_tools.py` | 2 schemas | network-analyst tools |
| `safety.py` | SAFE | Read-only |

---

## Implementation Pattern

This story follows the standardized 7-step implementation pattern:

1. `api.py` -- Add SDK wrapper methods with `@log_api_call`
2. `discovery.py` -- Add discovery function with `client.safe_call()`
3. `config.py` -- (Skip - read-only feature)
4. `agent_router.py` -- Register in `FUNCTION_REGISTRY`
5. `agent_tools.py` -- Add tool schemas + TOOL_SAFETY classification
6. `safety.py` -- Register in `SAFETY_CLASSIFICATION`
7. `tests/` -- Add comprehensive tests

**Note:** Both `SAFETY_CLASSIFICATION` (safety.py) and `TOOL_SAFETY` (agent_tools.py) must be updated.

---

## Tasks

- [ ] Add `get_air_marshal`, `get_air_marshal_rules` to api.py with `@log_api_call`
- [ ] Add `discover_rogue_aps` to discovery.py with `client.safe_call()`
- [ ] Register rogue AP functions in FUNCTION_REGISTRY (agent_router.py)
- [ ] Add 2 tool schemas to agent_tools.py (network-analyst)
- [ ] Register safety classifications in safety.py (SAFE) and agent_tools.py (TOOL_SAFETY)
- [ ] Add `rogue_aps_detected` issue detection to `find_issues()`
- [ ] Integrate rogue AP status into `full_discovery()` output
- [ ] Add tests (target: >= 90% coverage)
- [ ] Verify all schemas pass `validate_tool_schema()` with `additionalProperties: False`

---

## File List

(To be populated during implementation)

---

## Dependencies

- Phase 1 complete (Epics 8-10)
- Wireless APs must be present in network (product type guard: `wireless`)
- Air Marshal requires MR firmware >= 26.x

---

## Testing

**Target:** >= 90% coverage

**Test Files:**
- `tests/test_epic12_switching.py`

**Test Scenarios:**
1. API wrappers: verify SDK calls and `@log_api_call` decorator
2. Discovery: verify rogue AP data structure with BSSID, SSID, channel
3. Issue detection: verify `rogue_aps_detected` detection logic
4. Safety: verify SAFE classification (no confirmation required)
5. Product type guard: verify early-exit when no wireless APs present
6. Integration: verify rogue AP status in `full_discovery()` output
7. Natural language: verify "are there any rogue APs?" parsing

---
