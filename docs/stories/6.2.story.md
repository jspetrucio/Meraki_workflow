# Story 6.2: npm/npx Distribution

> **Epic:** 6 - Distribution & Packaging
> **Sprint:** S8 (Week 7-8)
> **Priority:** P2
> **Points:** 5
> **Type:** DevOps / Node.js
> **Agent:** @devops
> **Depends on:** Story 6.1 (pip Distribution)

---

## Status

**Draft**

---

## Story

**As a** Node.js user,
**I want** to run CNL via `npx cnl`,
**so that** I can use it without installing Python manually.

---

## Acceptance Criteria

1. npm package published as `cnl`
2. Package includes embedded Python (via python-build-standalone or similar)
3. `npx cnl` starts the app (downloads on first run if needed)
4. `npx cnl --setup` runs initial setup wizard
5. Works on macOS, Windows, Linux
6. Reasonable download size (< 100MB including embedded Python)

---

## Integration Verification

- **IV1:** `npx cnl` works on a machine without Python installed
- **IV2:** Functionality identical to pip-installed version
- **IV3:** First-run download completes in under 3 minutes on broadband

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`dist/**/*.js`** (npm package distribution code):
- CRITICAL: No `child_process.execSync()` with unsanitized user input — use `execFileSync()` with array args
- CRITICAL: SHA256 checksum verification MUST pass before extracting downloaded Python binary
- CRITICAL: No world-writable paths for Python installation (use user-local directory)
- HIGH: Package size validation (must stay under 100MB bundled)
- HIGH: Platform detection must handle unknown OS/arch gracefully (error, not crash)

### Review Focus for This Story
- Python download must verify SHA256 checksum before extraction (supply chain security)
- Embedded Python cache path (`~/.cnl/python/`) must not be world-writable
- Platform detection must reject unsupported architectures with clear error message
- `child_process.execSync` must not pass unsanitized user input (command injection risk)
- npm package must not bundle unnecessary files (keep under 100MB)

### Quality Gate Tasks

- [ ] **Pre-Commit (@dev):** All `child_process` calls use `execFileSync` with array arguments (no shell interpolation)
- [ ] **Pre-Commit (@dev):** SHA256 verification function has unit test with known-good and tampered binary
- [ ] **Pre-PR (@devops):** `npm pack` output is under 100MB
- [ ] **Pre-PR (@devops):** Installation tested on macOS, Linux, Windows (CI matrix)
- [ ] **Pre-Deployment (@devops):** No secrets or credentials in published npm package (`npm pack --dry-run` audit)

---

## Tasks / Subtasks

- [ ] **T1: Create npm package structure** (AC: 1)
  - [ ] T1.1: `dist/package.json` — npm package config
  - [ ] T1.2: Package name: `cnl` (or `@cisco/cnl` if scoped)
  - [ ] T1.3: `bin` field: `{"cnl": "./bin/cnl.js"}`
  - [ ] T1.4: Keywords, description, repository, license fields

- [ ] **T2: Create npx entry point** (AC: 3, 4)
  - [ ] T2.1: `dist/bin/cnl.js` — main entry script (Node.js)
  - [ ] T2.2: Check if Python available (system or embedded)
  - [ ] T2.3: If no Python → download python-build-standalone for current platform
  - [ ] T2.4: Run `python -m uvicorn scripts.server:app` using found/embedded Python
  - [ ] T2.5: `--setup` flag → run setup wizard in terminal mode
  - [ ] T2.6: `--cli` flag → drop into Python CLI mode

- [ ] **T3: Embedded Python management** (AC: 2, 6)
  - [ ] T3.1: `dist/lib/python-manager.js` — download and manage embedded Python
  - [ ] T3.2: Download URL for python-build-standalone (per-platform)
  - [ ] T3.3: Cache in `~/.cnl/python/` to avoid re-download
  - [ ] T3.4: Platform detection: `darwin-arm64`, `darwin-x64`, `linux-x64`, `win32-x64`
  - [ ] T3.5: Verify checksum after download
  - [ ] T3.6: Progress bar during download (using `ora` or `cli-progress`)

- [ ] **T4: Python package installation** (AC: 2)
  - [ ] T4.1: After Python available → `pip install cnl` into local venv
  - [ ] T4.2: Or bundle pre-built wheel with npm package (larger but faster first-run)
  - [ ] T4.3: Cache installed packages in `~/.cnl/venv/`
  - [ ] T4.4: Upgrade path: `npx cnl --upgrade` → re-install latest CNL pip package

- [ ] **T5: Cross-platform support** (AC: 5)
  - [ ] T5.1: macOS (arm64 + x64): test on Apple Silicon and Intel
  - [ ] T5.2: Linux (x64): test on Ubuntu 22.04
  - [ ] T5.3: Windows (x64): test on Windows 11 (PowerShell + cmd)
  - [ ] T5.4: Handle path separators and shell differences
  - [ ] T5.5: Handle process spawning differences (child_process)

- [ ] **T6: First-run experience** (AC: 3)
  - [ ] T6.1: First `npx cnl` → "Setting up CNL for the first time..."
  - [ ] T6.2: Download Python (if needed) → install dependencies → start server
  - [ ] T6.3: Show progress for each step
  - [ ] T6.4: Open browser to `http://localhost:3141` on success
  - [ ] T6.5: Subsequent runs skip setup → start immediately

- [ ] **T7: Write tests**
  - [ ] T7.1: Test platform detection logic
  - [ ] T7.2: Test Python detection (system vs embedded)
  - [ ] T7.3: Test CLI argument parsing
  - [ ] T7.4: Test first-run vs subsequent-run paths

---

## Dev Notes

### npm Package Structure

[Source: architecture.md#8.2 New Additions]

```
dist/
├── bin/
│   └── cnl.js              # npx entry point (#!/usr/bin/env node)
├── lib/
│   ├── python-manager.js   # Python download + management
│   ├── server-launcher.js  # Start uvicorn process
│   └── platform.js         # Platform detection utilities
├── package.json            # npm package config
└── README.md               # npm-specific docs
```

### Entry Point (cnl.js)

```javascript
#!/usr/bin/env node
// dist/bin/cnl.js

const { ensurePython } = require('../lib/python-manager');
const { launchServer } = require('../lib/server-launcher');
const { program } = require('commander');

program
  .option('--setup', 'Run initial setup wizard')
  .option('--cli', 'CLI-only mode')
  .option('--upgrade', 'Upgrade CNL to latest version')
  .option('--version', 'Show version')
  .parse(process.argv);

async function main() {
  const python = await ensurePython();  // Returns path to python binary
  await ensureCnlInstalled(python);     // pip install cnl if needed

  if (program.opts().setup) {
    // Run onboarding in terminal mode
  } else if (program.opts().cli) {
    // Spawn python CLI
  } else {
    // Launch server + open browser
    await launchServer(python);
  }
}

main().catch(console.error);
```

### Platform Detection

```javascript
// dist/lib/platform.js

/**
 * Detect current platform and architecture for Python download.
 * Returns a key matching PYTHON_URLS.
 */
function detectPlatform() {
  const platform = process.platform;  // 'darwin', 'linux', 'win32'
  const arch = process.arch;          // 'arm64', 'x64'
  const key = `${platform}-${arch}`;

  const SUPPORTED = ['darwin-arm64', 'darwin-x64', 'linux-x64', 'win32-x64'];
  if (!SUPPORTED.includes(key)) {
    throw new Error(
      `Unsupported platform: ${key}. CNL supports: ${SUPPORTED.join(', ')}`
    );
  }
  return key;
}

/**
 * Check if system Python is available and meets minimum version.
 */
async function findSystemPython() {
  const { execSync } = require('child_process');
  for (const cmd of ['python3', 'python']) {
    try {
      const version = execSync(`${cmd} --version`, { encoding: 'utf8' }).trim();
      const match = version.match(/Python (\d+)\.(\d+)/);
      if (match && parseInt(match[1]) >= 3 && parseInt(match[2]) >= 10) {
        return cmd;
      }
    } catch {
      continue;
    }
  }
  return null;  // No suitable Python found → will download embedded
}

module.exports = { detectPlatform, findSystemPython };
```

### Error Handling in Entry Point

```javascript
// dist/bin/cnl.js — enhanced error handling
async function main() {
  try {
    const python = await ensurePython();
    await ensureCnlInstalled(python);

    if (program.opts().setup) {
      await runSetup(python);
    } else if (program.opts().cli) {
      await spawnCli(python);
    } else {
      await launchServer(python);
    }
  } catch (err) {
    if (err.code === 'ECONNREFUSED') {
      console.error('\\n❌ Failed to connect. Is the server already running?');
    } else if (err.message.includes('Unsupported platform')) {
      console.error(`\\n❌ ${err.message}`);
      console.error('Please install Python 3.10+ manually and try again.');
    } else if (err.message.includes('Python not found')) {
      console.error('\\n❌ Python download failed. Check your internet connection.');
    } else {
      console.error(`\\n❌ Unexpected error: ${err.message}`);
    }
    process.exit(1);
  }
}
```

### Python Build Standalone URLs

```javascript
const PYTHON_URLS = {
  'darwin-arm64': 'https://github.com/indygreg/python-build-standalone/releases/download/.../cpython-3.11-aarch64-apple-darwin.tar.zst',
  'darwin-x64': 'https://github.com/indygreg/python-build-standalone/releases/download/.../cpython-3.11-x86_64-apple-darwin.tar.zst',
  'linux-x64': 'https://github.com/indygreg/python-build-standalone/releases/download/.../cpython-3.11-x86_64-unknown-linux-gnu.tar.zst',
  'win32-x64': 'https://github.com/indygreg/python-build-standalone/releases/download/.../cpython-3.11-x86_64-pc-windows-msvc.tar.zst',
};
```

### npm package.json

```json
{
  "name": "cnl",
  "version": "0.1.0",
  "description": "Cisco Neural Language - Natural language Meraki network management",
  "bin": { "cnl": "./bin/cnl.js" },
  "engines": { "node": ">=18" },
  "dependencies": {
    "commander": "^12.0.0",
    "ora": "^8.0.0",
    "node-fetch": "^3.3.0"
  }
}
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Entry point | `dist/bin/cnl.js` | npx entry (#!/usr/bin/env node) |
| Python manager | `dist/lib/python-manager.js` | Download + manage embedded Python |
| Server launcher | `dist/lib/server-launcher.js` | Start uvicorn process |
| Platform utils | `dist/lib/platform.js` | Platform detection |
| Package config | `dist/package.json` | npm package config |

---

## Testing

- **Framework:** Jest (unit) + Manual cross-platform testing
- **Location:** `dist/__tests__/`

```javascript
// dist/__tests__/platform.test.js
const { detectPlatform, findSystemPython } = require('../lib/platform');

test('detects current platform correctly', () => {
  const key = detectPlatform();
  expect(key).toMatch(/^(darwin|linux|win32)-(arm64|x64)$/);
});

test('throws on unsupported platform', () => {
  // Mock process.platform/arch for unsupported combo
  const orig = process.arch;
  Object.defineProperty(process, 'arch', { value: 'mips' });
  expect(() => detectPlatform()).toThrow('Unsupported platform');
  Object.defineProperty(process, 'arch', { value: orig });
});
```
- **Test Matrix:**
  | Platform | Python Pre-installed | Expected |
  |----------|---------------------|----------|
  | macOS arm64 | Yes | Uses system Python |
  | macOS arm64 | No | Downloads embedded |
  | Ubuntu 22.04 | Yes | Uses system Python |
  | Windows 11 | No | Downloads embedded |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |
| 2026-02-05 | 0.1.2 | Added security Quality Gates and dist/ path instructions per PO validation (NO-GO fix) | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
