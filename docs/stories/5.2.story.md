# Story 5.2: Pre-Built N8N Workflow Templates

> **Epic:** 5 - N8N Integration
> **Sprint:** S7 (Week 6-7)
> **Priority:** P2
> **Points:** 5
> **Type:** Backend (Python) + Data
> **Agent:** @dev
> **Depends on:** Story 5.1 (N8N Connection Manager)

---

## Status

**Draft**

---

## Story

**As a** user,
**I want** pre-built automation templates I can deploy to N8N with one click,
**so that** I don't need to build workflows from scratch.

---

## Acceptance Criteria

1. Template library with 5 initial workflows:
   - Scheduled Daily Discovery (run discovery every morning, alert on changes)
   - Device Offline Alert (webhook trigger, Slack/email notification)
   - Firmware Compliance Check (weekly scan, report non-compliant devices)
   - Security Audit (daily, check for insecure SSIDs, open ports)
   - Configuration Drift Detection (compare current config to baseline)
2. Each template is a valid N8N workflow JSON
3. Templates include CNL webhook nodes that call back to the local CNL API
4. One-click deploy: user selects template → CNL pushes to N8N via API
5. Chat command: "set up a daily discovery workflow" → deploys template to N8N

---

## Integration Verification

- **IV1:** Templates deploy successfully to N8N and execute without errors
- **IV2:** N8N webhooks correctly trigger CNL operations
- **IV3:** Template modifications don't break existing deployed workflows

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`scripts/**/*.py`** (n8n_client.py — template engine):
- CRITICAL: Template variables must be properly escaped (no injection into workflow JSON)
- HIGH: Workflow JSON output must be valid against N8N schema
- HIGH: Template metadata must be complete (name, description, variables)
- MEDIUM: Template rendering must handle missing optional variables gracefully

**`tests/**/*.py`** (test_n8n_client.py — template tests):
- VALIDATE: All 5 template variables tested (webhook_url, org_id, network_id, email, schedule_cron)
- VALIDATE: Generated workflow JSON structure is valid
- DO NOT: Require docstrings in test functions

### Review Focus for This Story
- `N8NTemplateEngine` must sanitize variable values before injection (special chars in org names)
- Generated workflows must include proper error handling nodes
- Template metadata must match actual template variable requirements
- Workflow export format must be compatible with N8N import endpoint

---

## Tasks / Subtasks

- [ ] **T1: Create template system** (AC: 2, 3)
  - [ ] T1.1: `templates/n8n/` directory for N8N workflow templates
  - [ ] T1.2: Template format: N8N-compatible JSON with placeholder variables
  - [ ] T1.3: Variable substitution: `{{CNL_BASE_URL}}`, `{{MERAKI_PROFILE}}`, `{{NOTIFICATION_EMAIL}}`
  - [ ] T1.4: `N8NTemplateEngine` class for loading and rendering templates

- [ ] **T2: Daily Discovery template** (AC: 1)
  - [ ] T2.1: `templates/n8n/daily-discovery.json`
  - [ ] T2.2: Cron trigger: every day at 7:00 AM
  - [ ] T2.3: HTTP node → `POST {{CNL_BASE_URL}}/api/v1/discovery/full`
  - [ ] T2.4: IF node → compare with previous snapshot
  - [ ] T2.5: Notification node → email/Slack with changes summary

- [ ] **T3: Device Offline Alert template** (AC: 1)
  - [ ] T3.1: `templates/n8n/device-offline-alert.json`
  - [ ] T3.2: Webhook trigger from Meraki Dashboard (or polling via CNL)
  - [ ] T3.3: HTTP node → `GET {{CNL_BASE_URL}}/api/v1/discovery/snapshots/latest`
  - [ ] T3.4: Filter node → find offline devices
  - [ ] T3.5: Notification node → Slack/email with device details

- [ ] **T4: Firmware Compliance template** (AC: 1)
  - [ ] T4.1: `templates/n8n/firmware-compliance.json`
  - [ ] T4.2: Cron trigger: weekly (Sunday midnight)
  - [ ] T4.3: HTTP node → `POST {{CNL_BASE_URL}}/api/v1/discovery/full`
  - [ ] T4.4: Code node → check firmware versions against known-good list
  - [ ] T4.5: Report node → generate compliance report

- [ ] **T5: Security Audit template** (AC: 1)
  - [ ] T5.1: `templates/n8n/security-audit.json`
  - [ ] T5.2: Cron trigger: daily at 6:00 AM
  - [ ] T5.3: HTTP node → `POST {{CNL_BASE_URL}}/api/v1/discovery/full`
  - [ ] T5.4: Code node → check for insecure SSIDs (open auth), open telnet, weak encryption
  - [ ] T5.5: Report node → generate security findings report

- [ ] **T6: Config Drift Detection template** (AC: 1)
  - [ ] T6.1: `templates/n8n/config-drift.json`
  - [ ] T6.2: Cron trigger: daily at midnight
  - [ ] T6.3: HTTP node → `POST {{CNL_BASE_URL}}/api/v1/discovery/compare`
  - [ ] T6.4: IF node → check if diff is non-empty
  - [ ] T6.5: Notification node → alert with drift details

- [ ] **T7: Template deployment API** (AC: 4)
  - [ ] T7.1: `GET /api/v1/n8n/templates` → list available templates with descriptions
  - [ ] T7.2: `POST /api/v1/n8n/templates/{name}/deploy` → render template + push to N8N
  - [ ] T7.3: Accept body: `{variables: {notification_email: "...", slack_webhook: "..."}}`
  - [ ] T7.4: Return deployed workflow ID and activation status

- [ ] **T8: Chat integration** (AC: 5)
  - [ ] T8.1: Agent router recognizes N8N deployment intents
  - [ ] T8.2: "set up daily discovery" → maps to `daily-discovery` template
  - [ ] T8.3: Agent asks for notification preferences (email/Slack) before deploying
  - [ ] T8.4: Confirmation prompt before deployment (moderate safety level)

- [ ] **T9: Write tests**
  - [ ] T9.1: Test template loading and variable substitution
  - [ ] T9.2: Test each template is valid N8N workflow JSON
  - [ ] T9.3: Test deployment API with mock N8N
  - [ ] T9.4: Test template listing endpoint

---

## Dev Notes

### N8N Template Structure

Each template is a standard N8N workflow JSON with variable placeholders:

```json
{
  "name": "CNL - Daily Discovery",
  "nodes": [
    {
      "type": "n8n-nodes-base.scheduleTrigger",
      "parameters": {
        "rule": { "interval": [{ "triggerAtHour": 7 }] }
      }
    },
    {
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "{{CNL_BASE_URL}}/api/v1/discovery/full",
        "method": "POST"
      }
    }
  ],
  "connections": { ... }
}
```

### Template Variables

Each template supports these standard placeholder variables:

| Variable | Example Value | Description |
|----------|---------------|-------------|
| `{{CNL_BASE_URL}}` | `http://localhost:3141` | Base URL of the CNL API server |
| `{{MERAKI_PROFILE}}` | `default` | Active Meraki profile name |
| `{{NOTIFICATION_EMAIL}}` | `admin@cisco.com` | Email for alerts/reports |
| `{{SLACK_WEBHOOK}}` | `https://hooks.slack.com/...` | Slack webhook URL for notifications |
| `{{CRON_SCHEDULE}}` | `0 7 * * *` | Override default schedule (optional) |

### Template Engine

```python
# scripts/n8n_template_engine.py
import json
import re
from pathlib import Path
from typing import Optional

class N8NTemplateEngine:
    """Loads, renders, and deploys N8N workflow templates."""

    TEMPLATE_METADATA = {
        "daily-discovery": {
            "name": "Scheduled Daily Discovery",
            "description": "Run discovery every morning, alert on changes",
            "required_vars": ["CNL_BASE_URL"],
            "optional_vars": ["NOTIFICATION_EMAIL", "CRON_SCHEDULE"],
        },
        "device-offline-alert": {
            "name": "Device Offline Alert",
            "description": "Webhook trigger, Slack/email notification on device down",
            "required_vars": ["CNL_BASE_URL"],
            "optional_vars": ["SLACK_WEBHOOK", "NOTIFICATION_EMAIL"],
        },
        "firmware-compliance": {
            "name": "Firmware Compliance Check",
            "description": "Weekly scan, report non-compliant devices",
            "required_vars": ["CNL_BASE_URL"],
            "optional_vars": ["NOTIFICATION_EMAIL"],
        },
        "security-audit": {
            "name": "Security Audit",
            "description": "Daily check for insecure SSIDs, open ports",
            "required_vars": ["CNL_BASE_URL"],
            "optional_vars": ["NOTIFICATION_EMAIL"],
        },
        "config-drift": {
            "name": "Configuration Drift Detection",
            "description": "Compare current config to baseline, alert on drift",
            "required_vars": ["CNL_BASE_URL"],
            "optional_vars": ["NOTIFICATION_EMAIL", "SLACK_WEBHOOK"],
        },
    }

    def __init__(self, template_dir: Path):
        self.template_dir = template_dir

    def list_templates(self) -> list[dict]:
        """Return template metadata (name, description, variables)."""
        return [
            {"id": tid, **meta}
            for tid, meta in self.TEMPLATE_METADATA.items()
            if (self.template_dir / f"{tid}.json").exists()
        ]

    def render(self, template_name: str, variables: dict) -> dict:
        """Load template JSON, substitute variables, return N8N workflow."""
        path = self.template_dir / f"{template_name}.json"
        raw = path.read_text()
        # Substitute {{VARIABLE_NAME}} placeholders
        for key, value in variables.items():
            raw = raw.replace(f"{{{{{key}}}}}", str(value))
        # Warn about unresolved variables
        remaining = re.findall(r"\{\{(\w+)\}\}", raw)
        if remaining:
            raise ValueError(f"Unresolved variables: {remaining}")
        return json.loads(raw)

    def deploy(self, client: "N8NClient", template_name: str, variables: dict) -> dict:
        """Render and push to N8N."""
        workflow_data = self.render(template_name, variables)
        return client.create_workflow(workflow_data)
```

### Template Directory

```
templates/n8n/
├── daily-discovery.json
├── device-offline-alert.json
├── firmware-compliance.json
├── security-audit.json
└── config-drift.json
```

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| Template engine | `scripts/n8n_template_engine.py` | Load, render, deploy templates |
| Templates | `templates/n8n/*.json` | N8N workflow JSON files |
| API routes | `scripts/server.py` | `/api/v1/n8n/templates` endpoints |
| Tests | `tests/test_n8n_templates.py` | Template validation tests |

---

## Testing

- **Framework:** pytest
- **Location:** `tests/test_n8n_templates.py`

```python
import json
import pytest
from pathlib import Path
from scripts.n8n_template_engine import N8NTemplateEngine

@pytest.fixture
def engine(tmp_path):
    tmpl = tmp_path / "daily-discovery.json"
    tmpl.write_text(json.dumps({
        "name": "CNL - Daily Discovery",
        "nodes": [{"url": "{{CNL_BASE_URL}}/api/v1/discovery/full"}]
    }))
    return N8NTemplateEngine(tmp_path)

def test_list_templates(engine):
    templates = engine.list_templates()
    assert any(t["id"] == "daily-discovery" for t in templates)

def test_render_substitutes_variables(engine):
    result = engine.render("daily-discovery", {"CNL_BASE_URL": "http://localhost:3141"})
    assert "http://localhost:3141" in json.dumps(result)

def test_render_raises_on_missing_variable(engine):
    with pytest.raises(ValueError, match="Unresolved variables"):
        engine.render("daily-discovery", {})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
