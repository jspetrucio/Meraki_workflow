# Story 11.5: Policy Objects

> **Epic:** 11 - SD-WAN, Policy & Templates
> **Sprint:** S8
> **Priority:** P1 (advanced operations)
> **Points:** 5
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** None (independent, but required by Story 11.3)

---

## Status

**Draft**

---

## Story

**As a** security admin,
**I want** to manage reusable policy objects and groups,
**so that** firewall rules reference named objects instead of raw IPs.

---

## Acceptance Criteria

1. `discover_policy_objects` returns all objects and groups with usage counts
2. Full CRUD for policy objects (CIDR, FQDN, port ranges)
3. Group management for organizing objects
4. Dependency check before delete (warn if object is in use)
5. Backup created before any policy object deletion
6. Dry-run mode supported: preview policy object changes before applying
7. Policy objects integrated into `full_discovery()` output

---

## Scope

| Layer | New Items | Details |
|-------|-----------|---------|
| `api.py` | 5 methods | `get_policy_objects`, `create_policy_object`, `update_policy_object`, `delete_policy_object`, `get_policy_object_groups` |
| `discovery.py` | 1 function | `discover_policy_objects` |
| `config.py` | 1 function | `manage_policy_object` |
| `agent_tools.py` | 4 schemas | meraki-specialist tools |
| Safety | MODERATE | Objects referenced by rules |

---

## Implementation Pattern

This story follows the standardized 7-step implementation pattern:

1. `api.py` -- Add SDK wrapper methods with `@log_api_call`
2. `discovery.py` -- Add discovery function with `client.safe_call()`
3. `config.py` -- Add config function with backup + `ConfigResult`
4. `agent_router.py` -- Register in `FUNCTION_REGISTRY`
5. `agent_tools.py` -- Add tool schemas + TOOL_SAFETY classification
6. `safety.py` -- Register in `SAFETY_CLASSIFICATION`
7. `tests/` -- Add comprehensive tests

**Note:** Both `SAFETY_CLASSIFICATION` (safety.py) and `TOOL_SAFETY` (agent_tools.py) must be updated.

---

## Tasks

- [ ] Add `get_policy_objects`, `create_policy_object`, `update_policy_object`, `delete_policy_object`, `get_policy_object_groups` to api.py with `@log_api_call`
- [ ] Add `discover_policy_objects` to discovery.py with `client.safe_call()`
- [ ] Add `manage_policy_object` to config.py with backup + `ConfigResult`
- [ ] Implement dependency check before delete (warn if object is in use by firewall rules or Adaptive Policy)
- [ ] Register policy object functions in FUNCTION_REGISTRY (agent_router.py)
- [ ] Add 4 tool schemas to agent_tools.py (meraki-specialist)
- [ ] Register safety classifications in safety.py (MODERATE) and agent_tools.py (TOOL_SAFETY)
- [ ] Integrate policy objects into `full_discovery()` output
- [ ] Implement dry-run mode for policy object changes
- [ ] Add tests (target: >= 90% coverage)
- [ ] Verify all schemas pass `validate_tool_schema()` with `additionalProperties: False`

---

## File List

(To be populated during implementation)

---

## Dependencies

- Phase 1 complete (Epics 8-10)
- **Required by Story 11.3** (Adaptive Policy / SGT)
- Uses existing backup infrastructure from config.py

---

## Testing

### Test Coverage

- Unit tests for all 5 api.py methods
- Integration tests for discovery and config functions
- Safety classification tests
- Tool schema validation tests
- Policy object CRUD tests (create, update, delete)
- Group management tests
- Dependency check test (delete with object in use)
- Dry-run mode test

### Test Expectations

- >= 90% code coverage for new functions
- All schemas pass validation with `additionalProperties: False`
- MODERATE tools logged appropriately
- Backup created before deletion operations
- `full_discovery()` includes policy objects with usage counts
- Dependency check prevents deletion of in-use objects (or warns appropriately)
- Objects correctly support CIDR, FQDN, and port range types

---
