# Story 7.4: New FUNCTION_REGISTRY Entries

> **Epic:** 7 - Deterministic Task Executor & Modular Agent Architecture
> **Sprint:** S6 (Week 1)
> **Priority:** P1 (enabler for migration)
> **Points:** 5
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** None (independent)

---

## Status

**Draft**

---

## Story

**As a** CNL platform developer,
**I want** new functions registered in the FUNCTION_REGISTRY for Catalyst detection, SGT preflight, license checks, and generic backup,
**so that** the task executor's tool steps can call them deterministically.

---

## Acceptance Criteria

### detect_catalyst_mode

1. `detect_catalyst_mode(serial: str, client: Optional[MerakiClient] = None) -> dict` in `config.py`
2. Returns `{"serial": str, "mode": str, "writable": bool}` where mode is one of: `native_meraki`, `managed`, `monitored`
3. Logic: query device model/firmware via Meraki API, classify based on product type and management mode
4. `monitored` mode → `writable=False` (blocks write operations)
5. `managed` + `native_meraki` → `writable=True`
6. If API call fails, return `{"serial": serial, "mode": "unknown", "writable": False, "error": str}`

### sgt_preflight_check

7. `sgt_preflight_check(serial: str, client: Optional[MerakiClient] = None) -> dict` in `config.py`
8. Wraps existing `check_switch_port_writeability()` with a simplified return format
9. Returns `{"serial": str, "has_sgt_restriction": bool, "writable_ports": int, "read_only_ports": int, "writable_ratio": float}`
10. If `has_sgt_restriction=True` and `writable_ratio < 0.5`, include `"warning": "Most ports are SGT-locked"`

### check_license

11. `check_license(serial: str, client: Optional[MerakiClient] = None) -> dict` in `config.py`
12. Returns `{"serial": str, "license_type": str, "features_available": list[str]}`
13. license_type: `enterprise`, `advanced`, `standard`, `unknown`
14. Uses Meraki licensing API to determine device license level
15. If API unavailable, returns `{"serial": serial, "license_type": "unknown", "features_available": [], "error": str}`

### backup_current_state

16. `backup_current_state(resource_type: str, targets: dict, client_name: str, client: Optional[MerakiClient] = None) -> dict` in `config.py`
17. Generic wrapper over existing `backup_config()` that accepts flexible target parameters
18. Returns `{"backup_path": str, "resource_type": str, "timestamp": str, "targets": dict}`
19. Supports resource types: `network`, `ssid`, `vlan`, `firewall`, `switch_acl`

### FUNCTION_REGISTRY Registration

20. All 4 functions added to `FUNCTION_REGISTRY` in `agent_router.py`
21. All 4 functions added to `MERAKI_SPECIALIST_TOOLS` in `agent_tools.py` with OpenAI function-calling schemas
22. Safety classifications added to `TOOL_SAFETY` in `agent_tools.py`: all 4 are `SafetyLevel.SAFE` (read-only operations except backup which is safe-write)

---

## Technical Notes

### Existing Infrastructure
- `check_switch_port_writeability()` already exists in config.py — sgt_preflight_check wraps it
- `backup_config()` already exists in config.py — backup_current_state extends it
- Auto-injection of `client`, `client_name` in `_execute_function()` handles parameter resolution

### Meraki API Endpoints
- Device info: `GET /devices/{serial}`
- Licensing: `GET /organizations/{orgId}/licensing/coterm/licenses`
- Switch ports: `GET /devices/{serial}/switch/ports` (already used by check_switch_port_writeability)

---

## Integration Verification

- **IV1:** All 4 functions callable via `_execute_function()` with auto-injection
- **IV2:** Existing FUNCTION_REGISTRY entries unchanged
- **IV3:** Tool schemas validate against OpenAI function-calling format

---

## Dependencies

| Direction | Story | Title | Status |
|-----------|-------|-------|--------|
| Blocks | 7.5 | Network Analyst Migration | Draft |
| Blocks | 7.6 | Meraki Specialist Migration | Draft |

---

## Tasks

- [ ] Implement detect_catalyst_mode() in config.py
- [ ] Implement sgt_preflight_check() in config.py (wrapper over check_switch_port_writeability)
- [ ] Implement check_license() in config.py
- [ ] Implement backup_current_state() in config.py (wrapper over backup_config)
- [ ] Add all 4 to FUNCTION_REGISTRY in agent_router.py
- [ ] Add OpenAI function-calling schemas to agent_tools.py
- [ ] Add safety classifications to TOOL_SAFETY
- [ ] Write unit tests for each function (target: 16+ tests)
- [ ] Test error handling (API unavailable, invalid serial)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `scripts/config.py` | MODIFY | Add 4 new functions |
| `scripts/agent_router.py` | MODIFY | Register 4 functions in FUNCTION_REGISTRY |
| `scripts/agent_tools.py` | MODIFY | Add tool schemas + safety classifications |
| `tests/test_new_registry_functions.py` | CREATE | Unit tests |

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Quality Gate**: All functions handle API failures gracefully, schemas validated
