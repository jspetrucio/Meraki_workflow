# Story 2.5: Settings Panel

> **Epic:** 2 - Chat Frontend
> **Sprint:** S5 (Week 5)
> **Priority:** P1
> **Points:** 3
> **Type:** Frontend
> **Agent:** @dev
> **Depends on:** Story 2.1 (React Scaffold), Story 1.4 (Settings API)

---

## Status

**Draft**

---

## Story

**As a** user,
**I want** a settings panel to manage my credentials, AI provider, and preferences,
**so that** I can update my configuration without re-running onboarding.

---

## Acceptance Criteria

1. Settings accessible via gear icon in sidebar
2. Sections: Meraki Profiles, AI Provider, N8N Connection, Appearance
3. Meraki Profiles: Add/edit/delete profiles with validation
4. AI Provider: Switch between Claude/GPT/Gemini, update API key
5. N8N Connection: URL input, connection test button, enable/disable toggle
6. Appearance: Dark/light mode toggle, font size
7. All changes saved immediately via backend API
8. Dangerous operations (delete profile) require confirmation

---

## Integration Verification

- **IV1:** Profile changes reflect in sidebar immediately
- **IV2:** AI provider change affects next chat message processing
- **IV3:** N8N toggle correctly enables/disables N8N features throughout app

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Profile**: assertive
> **Quality Gates**: block_on_critical=true, require_resolution=true

### Applicable Path Instructions

**`frontend/src/**/*.tsx`** (SettingsPanel.tsx, ProviderConfig.tsx, ThemeSelector.tsx):
- CRITICAL: API key inputs must use `type="password"` — never display in plaintext
- CRITICAL: Settings panel must mask stored keys (show `has_key: true`, not the key itself)
- FOCUS: Component prop typing, accessibility
- FOCUS: Optimistic updates with rollback on failure

**`frontend/src/stores/**`** (settingsStore.ts):
- VALIDATE: Immutable state updates, optimistic update + rollback pattern
- VALIDATE: Proper TypeScript interfaces for settings state

**`frontend/**/*.test.*`** (settings panel tests):
- VALIDATE: User interaction testing, proper async handling

### Review Focus for This Story
- Provider API key fields must clear after successful save (no lingering in DOM)
- Settings save must use PATCH (partial update) — not PUT (full replace)
- Optimistic updates must rollback correctly on 4xx/5xx API errors
- Theme toggle must persist to both localStorage and backend simultaneously

---

## Tasks / Subtasks

- [ ] **T1: Create SettingsPanel component** (AC: 1, 2)
  - [ ] T1.1: `SettingsPanel.tsx` — tabbed/sectioned layout
  - [ ] T1.2: Gear icon trigger in sidebar footer
  - [ ] T1.3: Slide-over or full-page panel
  - [ ] T1.4: Sections: Meraki, AI, N8N, Appearance

- [ ] **T2: Meraki Profiles section** (AC: 3)
  - [ ] T2.1: `ProfileManager.tsx` — list profiles with edit/delete
  - [ ] T2.2: Add profile form (name, API key, org ID)
  - [ ] T2.3: Validate on save → `POST /api/v1/credentials/validate`
  - [ ] T2.4: Delete with confirmation dialog
  - [ ] T2.5: Set active profile

- [ ] **T3: AI Provider section** (AC: 4)
  - [ ] T3.1: `AIProviderSettings.tsx` — provider dropdown + model + key
  - [ ] T3.2: Provider options: Anthropic/OpenAI/Google/Ollama
  - [ ] T3.3: "Test Connection" button → validate
  - [ ] T3.4: Save via `PATCH /api/v1/settings` + `POST /api/v1/credentials/provider/{name}`

- [ ] **T4: N8N section** (AC: 5)
  - [ ] T4.1: `N8NSettings.tsx` — URL input + API key + enable toggle
  - [ ] T4.2: "Test Connection" → `POST /api/v1/credentials/validate {type: "n8n"}`
  - [ ] T4.3: Enable/disable toggle → `PATCH /api/v1/settings {n8n_enabled: bool}`

- [ ] **T5: Appearance section** (AC: 6)
  - [ ] T5.1: Dark/light mode toggle (uses ThemeToggle from Story 2.1)
  - [ ] T5.2: Font size slider (small/medium/large)
  - [ ] T5.3: Language selector (en/pt) — future use

- [ ] **T6: Implement useSettings hook** (AC: 7)
  - [ ] T6.1: `hooks/useSettings.ts` — fetch/update settings via REST API
  - [ ] T6.2: Optimistic UI updates with rollback on error

- [ ] **T7: Write tests**
  - [ ] T7.1: Test settings panel rendering
  - [ ] T7.2: Test provider switching
  - [ ] T7.3: Test profile CRUD
  - [ ] T7.4: Test N8N toggle

---

## Dev Notes

### Settings Component Structure

[Source: architecture.md#5.6 React Frontend]

```
components/settings/
├── SettingsPanel.tsx       # Settings page
├── AIProviderSettings.tsx  # AI provider configuration
├── ProfileManager.tsx      # Meraki profiles CRUD
└── N8NSettings.tsx         # N8N connection settings
```

### useSettings Hook

[Source: architecture.md#5.6 React Frontend — Zustand Store]

```typescript
// hooks/useSettings.ts
import { useSettingsStore } from '@/stores/settingsStore';
import { useCallback, useEffect } from 'react';
import { api } from '@/lib/api';

export function useSettings() {
  const {
    settings, setSettings,
    loading, setLoading,
    error, setError,
  } = useSettingsStore();

  useEffect(() => {
    setLoading(true);
    api.get('/settings')
      .then(data => setSettings(data))
      .catch(err => setError(err.message))
      .finally(() => setLoading(false));
  }, []);

  const updateSettings = useCallback(async (patch: Partial<Settings>) => {
    const prev = { ...settings };
    setSettings({ ...settings, ...patch }); // Optimistic update
    try {
      await api.patch('/settings', patch);
    } catch (err) {
      setSettings(prev); // Rollback on error
      throw err;
    }
  }, [settings, setSettings]);

  const saveProviderKey = useCallback(async (provider: string, apiKey: string) => {
    await api.post(`/credentials/provider/${provider}`, { api_key: apiKey });
  }, []);

  const validateCredentials = useCallback(async (type: string, data: Record<string, string>) => {
    return api.post('/credentials/validate', { type, ...data });
  }, []);

  return { settings, loading, error, updateSettings, saveProviderKey, validateCredentials };
}
```

### Zustand settingsStore Pattern

```typescript
// stores/settingsStore.ts (relevant additions for Settings Panel)
interface Settings {
  ai_provider: string;
  ai_model: string;
  n8n_enabled: boolean;
  n8n_url: string;
  theme: 'light' | 'dark';
  font_size: 'small' | 'medium' | 'large';
  language: 'en' | 'pt';
}

interface SettingsStore {
  settings: Settings;
  loading: boolean;
  error: string | null;
  setSettings: (s: Partial<Settings>) => void;
  setLoading: (v: boolean) => void;
  setError: (e: string | null) => void;
}
```

### API Endpoints

[Source: Story 1.4 — settings_routes.py]

- `GET /api/v1/settings` → current settings (keys masked)
- `PATCH /api/v1/settings` → partial update
- `GET /api/v1/credentials/providers` → configured providers
- `POST /api/v1/credentials/provider/{name}` → save key
- `POST /api/v1/credentials/validate` → test connectivity

### File Locations

| File | Location | Purpose |
|------|----------|---------|
| SettingsPanel | `frontend/src/components/settings/SettingsPanel.tsx` | Tabbed settings container |
| AIProviderSettings | `frontend/src/components/settings/AIProviderSettings.tsx` | AI provider config |
| ProfileManager | `frontend/src/components/settings/ProfileManager.tsx` | Meraki profiles CRUD |
| N8NSettings | `frontend/src/components/settings/N8NSettings.tsx` | N8N connection settings |
| useSettings hook | `frontend/src/hooks/useSettings.ts` | Settings fetch/update logic |
| Tests | `frontend/src/components/settings/__tests__/` | Vitest tests |

---

## Testing

- **Framework:** Vitest + React Testing Library
- **Location:** `frontend/src/components/settings/__tests__/`

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { SettingsPanel } from '../SettingsPanel';

test('renders all settings sections', () => {
  render(<SettingsPanel />);
  expect(screen.getByText('Meraki Profiles')).toBeInTheDocument();
  expect(screen.getByText('AI Provider')).toBeInTheDocument();
  expect(screen.getByText('N8N Connection')).toBeInTheDocument();
  expect(screen.getByText('Appearance')).toBeInTheDocument();
});

test('switching AI provider triggers save', async () => {
  render(<SettingsPanel />);
  fireEvent.change(screen.getByLabelText('Provider'), { target: { value: 'openai' } });
  await waitFor(() => {
    expect(screen.getByText('Saved')).toBeInTheDocument();
  });
});

test('delete profile requires confirmation', () => {
  render(<SettingsPanel />);
  fireEvent.click(screen.getByText('Delete'));
  expect(screen.getByText('Are you sure?')).toBeInTheDocument();
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1.0 | Story created from PRD + Architecture | River (SM) |
| 2026-02-05 | 0.1.1 | CodeRabbit integration enabled — assertive profile, path instructions + review focus added | River (SM) |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

---

## QA Results
_(To be filled by QA agent)_
