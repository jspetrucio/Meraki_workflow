# Story 7.2: YAML Frontmatter Parser & Task Registry

> **Epic:** 7 - Deterministic Task Executor & Modular Agent Architecture
> **Sprint:** S6 (Week 1)
> **Priority:** P0 (foundation)
> **Points:** 5
> **Type:** Backend/Python
> **Agent:** @dev
> **Depends on:** None (foundation)

---

## Status

**Draft**

---

## Story

**As a** CNL platform developer,
**I want** to parse YAML frontmatter from task `.md` files and maintain a registry of available tasks,
**so that** the Router can match user messages to modular task definitions.

---

## Acceptance Criteria

### YAML Frontmatter Parser

1. `parse_task_file(file_path) -> TaskDefinition` reads a `.md` file, extracts YAML frontmatter between `---` delimiters
2. Parser extracts: `name`, `agent`, `trigger_keywords`, `risk_level`, `steps` (list of step dicts)
3. Parser extracts optional fields: `description`, `requires_confirmation`, `timeout_seconds`
4. Parser preserves Markdown body (below frontmatter) as `body_markdown` field for agent steps
5. Invalid YAML raises `TaskParseError` with file path and line number
6. Missing required fields raise `TaskParseError` listing missing fields
7. Steps are validated: each step must have `name` and `type` (tool|agent|gate)

### Task Registry

8. `TaskRegistry` class loads all task `.md` files from a configured directory
9. `load_tasks(directory: Path) -> dict[str, TaskDefinition]` scans directory recursively
10. `find_matching_task(message: str) -> Optional[TaskDefinition]` matches user message against `trigger_keywords` WITH verb-awareness (HIGH-1 amendment)
11. Keyword matching: case-insensitive, matches whole words, returns highest-overlap task
12. If multiple tasks tie on keyword count, prefer the one with higher `risk_level` (safer operations are less specific)
12a. **Verb-aware matching (Architect HIGH-1):** `find_matching_task()` must incorporate verb context to avoid routing analysis queries to configuration tasks. Uses shared verb sets from `scripts/verb_utils.py` (ACTION_VERBS, ANALYSIS_VERBS). If message contains only analysis verbs + domain keywords, do NOT match write tasks. Minimum threshold: at least 2 keywords OR 1 keyword + matching verb to return a task match.
13. Registry auto-discovers tasks from `CNL_agents/{agent_name}/tasks/*.md`
14. Registry supports hot-reload: `reload()` re-scans directory

### Data Model Import

15. All data models (`TaskDefinition`, `StepDefinition`, `TaskParseError`) imported from `scripts/task_models.py` (shared with Story 7.1 — MEDIUM-2 amendment)

### Task File Format

16. Tasks follow this frontmatter schema:
```yaml
---
name: configure-switching
agent: meraki-specialist
trigger_keywords: [vlan, acl, switch port, qos, trunk, stp]
risk_level: high
steps:
  - name: parse_intent
    type: agent
    description: "Interpret user request"
  - name: resolve_targets
    type: tool
    tool: get_devices
    args_from: intent
  - name: confirm
    type: gate
    message_template: "Confirm changes above?"
  - name: apply_changes
    type: tool
    tool: update_switch_acls
    args_from: preview.payload
---
```

---

## Technical Notes

### File Location
- `scripts/task_registry.py` (~200-250 lines)

### Dependencies
- `pyyaml` (already installed)
- `dataclasses` from stdlib
- `scripts/task_models.py` (shared data models from Story 7.1)

### Key Decisions
- Frontmatter parsing uses `yaml.safe_load()` — no arbitrary code execution
- Registry is a singleton initialized at server startup
- `find_matching_task()` runs BEFORE the existing regex/LLM classification pipeline
- **Verb-awareness** is shared with Story 7.7's verb pre-pass — extract to `scripts/verb_utils.py` as shared utility (HIGH-1 recommendation)

---

## Integration Verification

- **IV1:** TaskDefinition dataclass shared with task_executor.py (imported from same module or shared models)
- **IV2:** Registry directory structure matches CNL_agents/ layout from feature doc
- **IV3:** find_matching_task() returns None for non-matching messages — allows fallback to legacy flow

---

## Dependencies

| Direction | Story | Title | Status |
|-----------|-------|-------|--------|
| Blocks | 7.3 | Router Integration | Draft |
| Blocks | 7.5 | Network Analyst Migration | Draft |
| Blocks | 7.6 | Meraki Specialist Migration | Draft |

---

## Tasks

- [ ] Import data models from `scripts/task_models.py` (created in Story 7.1)
- [ ] Implement parse_task_file() with YAML frontmatter extraction
- [ ] Implement validation (required fields, step types)
- [ ] Implement TaskRegistry class with load_tasks()
- [ ] Implement find_matching_task() with verb-aware keyword matching (HIGH-1)
- [ ] Create `scripts/verb_utils.py` with shared ACTION_VERBS and ANALYSIS_VERBS sets
- [ ] Implement reload() for hot-reload support
- [ ] Handle edge cases: empty files, no frontmatter, malformed YAML
- [ ] Write unit tests (target: 20+ tests)
- [ ] Write tests for verb-aware matching: "analyze VLANs" != configure-switching

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `scripts/task_registry.py` | CREATE | YAML parser + task registry |
| `scripts/verb_utils.py` | CREATE | Shared verb sets (ACTION_VERBS, ANALYSIS_VERBS) — HIGH-1 |
| `tests/test_task_registry.py` | CREATE | Unit tests |

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Enabled
> **Quality Gate**: Parser handles all edge cases, registry thread-safe
