{
  "workflow": {
    "unique_name": "definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB",
    "name": "Data Usage Daily Alert - 3GB Threshold",
    "title": "Data Usage Daily Alert - 3GB Threshold",
    "type": "generic.workflow",
    "base_type": "workflow",
    "variables": [
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "1437319",
          "scope": "local",
          "name": "organization_id",
          "type": "datatype.string",
          "description": "Meraki Organization ID",
          "is_required": true,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_02sZ5bnuvr2YirxlL8orPSCzk23RHvHLpgLqE",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.integer",
        "properties": {
          "value": 3221225472,
          "scope": "local",
          "name": "initial_threshold_bytes",
          "type": "datatype.integer",
          "description": "Initial threshold in bytes (3GB = 3221225472)",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_02F6JO4j1uL0dyldX5rFl1irlGs9lmQNfGnbC",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.integer",
        "properties": {
          "value": 1073741824,
          "scope": "local",
          "name": "increment_bytes",
          "type": "datatype.integer",
          "description": "Increment for additional alerts in bytes (1GB = 1073741824)",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_028Ultk8JoqKG9Pupx0dULztcNp6SAVcUrzD7",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "https://hooks.slack.com/services/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",
          "scope": "local",
          "name": "slack_webhook_url",
          "type": "datatype.string",
          "description": "Slack Incoming Webhook URL",
          "is_required": true,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_025gEhOj8AVjy0ySJLoQU6qw6ZrNFnAETr8jN",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "#network-alerts",
          "scope": "local",
          "name": "slack_channel",
          "type": "datatype.string",
          "description": "Slack channel for notifications",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_02eA7mi984zmEI4vVhVlcmQj4UEaFjfmeUIsp",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.integer",
        "properties": {
          "value": 0,
          "scope": "local",
          "name": "last_alert_threshold",
          "type": "datatype.integer",
          "description": "Last threshold that triggered an alert (bytes)",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_02LxYw6Mvo4VlQuvA0qZmd1QJEymhitHeaDC8",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.integer",
        "properties": {
          "value": 0,
          "scope": "local",
          "name": "current_usage_bytes",
          "type": "datatype.integer",
          "description": "Current daily usage in bytes",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_02RqGP2ZN5hYWCICkRLCdXzwQekqT3WCVULlQ",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "",
          "scope": "output",
          "name": "alert_status",
          "type": "datatype.string",
          "description": "Status of the alert execution",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false
        },
        "unique_name": "variable_workflow_02SNxlqaZzqp0eDFL9wLNr7VibwrBzZAJzGUp",
        "object_type": "variable_workflow"
      }
    ],
    "properties": {
      "atomic": {
        "is_atomic": false
      },
      "delete_workflow_instance": false,
      "description": "Monitors daily data usage and sends Slack alerts when consumption exceeds 3GB. Continues alerting for every additional 1GB consumed (4GB, 5GB, 6GB, etc.).",
      "display_name": "Data Usage Daily Alert - 3GB Threshold",
      "runtime_user": {
        "target_default": true
      },
      "target": {
        "target_type": "meraki.endpoint",
        "specify_on_workflow_start": true
      }
    },
    "object_type": "definition_workflow",
    "actions": [
      {
        "unique_name": "definition_activity_021q8aoKMLoJAqBPxmNY6eReHIrGjx48dwWe4",
        "name": "Generic Meraki API Request",
        "title": "Get Organization Network Usage",
        "type": "meraki.api_request",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "api_body": "",
          "api_method": "GET",
          "api_url": "/api/v1/organizations/$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_02sZ5bnuvr2YirxlL8orPSCzk23RHvHLpgLqE$/summary/top/appliances/byUtilization?t0=$workflow.startOfDay$",
          "continue_on_failure": false,
          "display_name": "Get Organization Network Usage",
          "runtime_user": {
            "target_default": true
          },
          "skip_execution": false,
          "target": {
            "use_workflow_target": true
          }
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_02vWtHCDn8hUuUnsA4jb0uDFXiZDmvufmlHU1",
        "name": "Execute Python Script",
        "title": "Calculate Total Daily Usage",
        "type": "python3.script",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "continue_on_failure": false,
          "display_name": "Calculate Total Daily Usage",
          "script": "import json\nimport sys\n\n# Get usage data from previous activity\nusage_response = '''$activity.definition_activity_021q8aoKMLoJAqBPxmNY6eReHIrGjx48dwWe4.output.response_body$'''\n\ntry:\n    data = json.loads(usage_response)\n    total_bytes = 0\n    \n    # Sum all usage from appliances\n    if isinstance(data, list):\n        for appliance in data:\n            if 'usage' in appliance:\n                usage = appliance.get('usage', {})\n                total_bytes += usage.get('sent', 0) + usage.get('received', 0)\n    \n    # Output the total\n    print(f'TOTAL_BYTES:{total_bytes}')\n    \nexcept Exception as e:\n    print(f'ERROR:{str(e)}')\n    sys.exit(1)\n",
          "runtime_user": {
            "target_default": true
          },
          "skip_execution": false
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_020VvjgSngBeDKd0xCy7SUXPZFDO25WWtGxp6",
        "name": "Set Variables",
        "title": "Set Current Usage Variable",
        "type": "core.set_multiple_variables",
        "base_type": "activity",
        "properties": {
          "continue_on_failure": false,
          "display_name": "Set Current Usage Variable",
          "variables_to_update": [
            {
              "variable_to_update": "$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_02RqGP2ZN5hYWCICkRLCdXzwQekqT3WCVULlQ$",
              "variable_value_new": "$activity.definition_activity_02vWtHCDn8hUuUnsA4jb0uDFXiZDmvufmlHU1.output.script_output$"
            }
          ]
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_02v9iDECHFWUvxhSeGmwZrwk5QN5okiij37Rf",
        "name": "Condition Block",
        "title": "Check if Threshold Exceeded",
        "type": "logic.condition_block",
        "base_type": "activity",
        "properties": {
          "continue_on_failure": false,
          "display_name": "Check if Threshold Exceeded"
        },
        "object_type": "definition_activity",
        "blocks": [
          {
            "unique_name": "definition_activity_026mCAIzcwyxFb3wAis1HOg2d2ylK3q7msNa1",
            "name": "Condition Branch",
            "title": "If usage >= 3GB and no alert sent yet",
            "type": "logic.condition_block",
            "base_type": "activity",
            "properties": {
              "condition": {
                "left_operand": "$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_02RqGP2ZN5hYWCICkRLCdXzwQekqT3WCVULlQ$",
                "operator": "gte",
                "right_operand": "$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_02F6JO4j1uL0dyldX5rFl1irlGs9lmQNfGnbC$"
              },
              "continue_on_failure": false
            },
            "object_type": "definition_activity",
            "actions": [
              {
                "unique_name": "definition_activity_02c0RNATZBDGj6Ups8J3OOu2xYS6VCzwAX89W",
                "name": "Execute Python Script",
                "title": "Calculate Next Threshold",
                "type": "python3.script",
                "base_type": "activity",
                "properties": {
                  "action_timeout": 180,
                  "continue_on_failure": false,
                  "display_name": "Calculate Next Threshold",
                  "script": "import math\n\ncurrent_usage = $workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_02RqGP2ZN5hYWCICkRLCdXzwQekqT3WCVULlQ$\ninitial_threshold = 3221225472  # 3GB in bytes\nincrement = 1073741824  # 1GB in bytes\nlast_alert = $workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_02LxYw6Mvo4VlQuvA0qZmd1QJEymhitHeaDC8$\n\n# Calculate which threshold we're at\nif current_usage >= initial_threshold:\n    # How many increments above initial threshold\n    excess = current_usage - initial_threshold\n    current_level = initial_threshold + (math.floor(excess / increment) * increment)\n    \n    if current_level > last_alert:\n        # New threshold crossed, should alert\n        usage_gb = round(current_usage / 1073741824, 2)\n        threshold_gb = round(current_level / 1073741824, 0)\n        next_threshold_gb = threshold_gb + 1\n        print(f'ALERT:YES|USAGE_GB:{usage_gb}|THRESHOLD_GB:{threshold_gb}|NEXT_GB:{next_threshold_gb}|NEW_LAST:{current_level}')\n    else:\n        print('ALERT:NO')\nelse:\n    print('ALERT:NO')\n",
                  "runtime_user": {
                    "target_default": true
                  },
                  "skip_execution": false
                },
                "object_type": "definition_activity"
              },
              {
                "unique_name": "definition_activity_02w8H7fm2WFdCvVzvDMwNfByUFM6qrlOqUhI1",
                "name": "HTTP Request",
                "title": "Send Slack Alert",
                "type": "web-service.http_request",
                "base_type": "activity",
                "properties": {
                  "action_timeout": 180,
                  "allow_auto_redirect": true,
                  "body": "{\n  \"channel\": \"#network-alerts\",\n  \"username\": \"Meraki Data Monitor\",\n  \"icon_emoji\": \":warning:\",\n  \"attachments\": [\n    {\n      \"color\": \"#ff6600\",\n      \"title\": \":rotating_light: Data Usage Alert\",\n      \"fields\": [\n        {\n          \"title\": \"Current Daily Usage\",\n          \"value\": \"$activity.definition_activity_02c0RNATZBDGj6Ups8J3OOu2xYS6VCzwAX89W.output.usage_gb$ GB\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Threshold Crossed\",\n          \"value\": \"$activity.definition_activity_02c0RNATZBDGj6Ups8J3OOu2xYS6VCzwAX89W.output.threshold_gb$ GB\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Next Alert At\",\n          \"value\": \"$activity.definition_activity_02c0RNATZBDGj6Ups8J3OOu2xYS6VCzwAX89W.output.next_gb$ GB\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Organization\",\n          \"value\": \"jose-org (ID: 1437319)\",\n          \"short\": true\n        }\n      ],\n      \"footer\": \"Meraki Workflow Automation\",\n      \"ts\": \"$workflow.now_epoch$\"\n    }\n  ]\n}",
                  "content_type": "application/json",
                  "continue_on_error_status_code": false,
                  "display_name": "Send Slack Alert",
                  "method": "POST",
                  "runtime_user": {
                    "target_default": true
                  },
                  "skip_execution": false,
                  "target": {
                    "use_workflow_target": false,
                    "override_workflow_target": true
                  },
                  "url": "$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_025gEhOj8AVjy0ySJLoQU6qw6ZrNFnAETr8jN$"
                },
                "object_type": "definition_activity"
              },
              {
                "unique_name": "definition_activity_02U4nLEWARBxZsyF14afK7bJvu3wmgj7PMv5z",
                "name": "Set Variables",
                "title": "Update Last Alert Threshold",
                "type": "core.set_multiple_variables",
                "base_type": "activity",
                "properties": {
                  "continue_on_failure": false,
                  "display_name": "Update Last Alert Threshold",
                  "variables_to_update": [
                    {
                      "variable_to_update": "$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.local.variable_workflow_02LxYw6Mvo4VlQuvA0qZmd1QJEymhitHeaDC8$",
                      "variable_value_new": "$activity.definition_activity_02c0RNATZBDGj6Ups8J3OOu2xYS6VCzwAX89W.output.new_last$"
                    },
                    {
                      "variable_to_update": "$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.output.variable_workflow_02SNxlqaZzqp0eDFL9wLNr7VibwrBzZAJzGUp$",
                      "variable_value_new": "Alert sent for threshold crossing"
                    }
                  ]
                },
                "object_type": "definition_activity"
              }
            ]
          },
          {
            "unique_name": "definition_activity_02294FFBYfm6ULaYBHt9cetOLTef0AujqbmGd",
            "name": "Condition Branch",
            "title": "Else - Under Threshold",
            "type": "logic.condition_block",
            "base_type": "activity",
            "properties": {
              "condition": {
                "left_operand": "1",
                "operator": "eq",
                "right_operand": "1"
              },
              "continue_on_failure": false
            },
            "object_type": "definition_activity",
            "actions": [
              {
                "unique_name": "definition_activity_02SVa2bg4f9NiCQzXA0tZmdR7U9T76vqcfDNJ",
                "name": "Set Variables",
                "title": "Set Status - No Alert Needed",
                "type": "core.set_multiple_variables",
                "base_type": "activity",
                "properties": {
                  "continue_on_failure": false,
                  "display_name": "Set Status - No Alert Needed",
                  "variables_to_update": [
                    {
                      "variable_to_update": "$workflow.definition_workflow_02WjFDIa0iI2juESqDDYZuLaf4bHrU5KvdncB.output.variable_workflow_02SNxlqaZzqp0eDFL9wLNr7VibwrBzZAJzGUp$",
                      "variable_value_new": "Usage under threshold - no alert needed"
                    }
                  ]
                },
                "object_type": "definition_activity"
              }
            ]
          }
        ]
      }
    ],
    "triggers": [
      {
        "unique_name": "definition_trigger_02YunC3MkBx7DHHGZPLX0eA37qQj5tIrIie0T",
        "name": "Schedule Trigger",
        "title": "Every 15 Minutes",
        "type": "trigger.schedule",
        "base_type": "trigger",
        "properties": {
          "display_name": "Every 15 Minutes",
          "run_every": 900,
          "timezone": "America/Sao_Paulo",
          "skip_on_overrun": true
        },
        "object_type": "definition_trigger"
      }
    ],
    "categories": [
      "category_02rDrNP86OeMZqyLpNy8z6HZxrAgUaY7LNm3B"
    ]
  },
  "categories": {
    "category_02rDrNP86OeMZqyLpNy8z6HZxrAgUaY7LNm3B": {
      "unique_name": "category_02rDrNP86OeMZqyLpNy8z6HZxrAgUaY7LNm3B",
      "name": "Meraki Data Monitoring",
      "title": "Meraki Data Monitoring",
      "type": "basic.category",
      "base_type": "category",
      "category_type": "custom",
      "object_type": "category"
    }
  }
}