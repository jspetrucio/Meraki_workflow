# Tauri 2.0 App Shell - File Structure

## Overview

This document provides a complete overview of the Tauri 2.0 desktop application structure created for CNL (Cisco Neural Language).

## Directory Structure

```
Meraki_Workflow/
├── package.json                          # Root npm scripts for Tauri
├── TAURI_SETUP.md                       # Developer setup guide
├── README.md                            # Updated with CNL Desktop App section
│
├── src-tauri/                           # Tauri application directory
│   ├── .gitignore                       # Ignore build artifacts
│   ├── README.md                        # Architecture and troubleshooting
│   ├── build.rs                         # Tauri build script
│   ├── Cargo.toml                       # Rust dependencies
│   ├── tauri.conf.json                  # Main Tauri configuration
│   │
│   ├── capabilities/                    # Tauri 2.0 security capabilities
│   │   └── default.json                 # Default permissions
│   │
│   ├── permissions/                     # Custom permission schemas
│   │   └── backend.toml                 # Backend command permissions
│   │
│   ├── icons/                           # Application icons
│   │   └── README.md                    # Icon generation guide
│   │
│   └── src/                             # Rust source code
│       ├── main.rs                      # Application entry point
│       ├── lib.rs                       # Library entry
│       └── sidecar.rs                   # FastAPI process manager
│
├── frontend/                            # React frontend (existing)
│   ├── src/
│   ├── dist/                            # Build output (embedded in .app)
│   └── package.json
│
└── scripts/                             # FastAPI backend (existing)
    └── server.py
```

## File Descriptions

### Root Level

#### package.json
```json
{
  "scripts": {
    "tauri": "tauri",
    "dev": "tauri dev",
    "build": "tauri build"
  }
}
```
- Provides npm scripts for Tauri development
- Manages @tauri-apps/cli as devDependency

#### TAURI_SETUP.md
Complete setup guide including:
- Prerequisites (Rust, Node.js, Python)
- Installation steps
- Development workflow
- Build instructions
- Troubleshooting

#### README.md (updated)
Added section:
- CNL Desktop App overview
- Quick start commands
- Architecture diagram

### src-tauri/

#### tauri.conf.json
Main configuration file defining:
- **Build**: devUrl, frontendDist paths
- **App**: Window settings (1200x800, min 800x600)
- **Bundle**: Identifier (com.cisco.cnl), targets (dmg, app)
- **Security**: CSP for localhost:3141 communication
- **Resources**: scripts/**, templates/**

#### Cargo.toml
Rust project configuration:
- Dependencies: tauri 2.0, serde, tokio, reqwest
- Features: custom-protocol
- Release optimizations: LTO, strip symbols, size optimization

#### build.rs
Simple Tauri build script:
```rust
fn main() {
    tauri_build::build()
}
```

### src-tauri/src/

#### main.rs
Application entry point featuring:
- Tauri builder with sidecar setup
- `setup()` hook to start FastAPI backend
- Health check waiting with timeout
- Window close event handler for cleanup
- Two Tauri commands:
  - `check_backend_health()` - Poll backend health
  - `is_backend_running()` - Check sidecar status

#### lib.rs
Library entry point:
```rust
pub mod sidecar;
```

#### sidecar.rs
FastAPI sidecar process manager:
- `SidecarManager` struct with Arc<Mutex<Option<Child>>>
- `find_python()` - Auto-discover Python executable
- `start()` - Spawn uvicorn process
- `wait_for_health()` - Async health check polling (10s timeout)
- `stop()` - Graceful shutdown (SIGTERM → SIGKILL)
- `is_running()` - Check process status
- Drop trait for automatic cleanup
- Unit tests included

### src-tauri/capabilities/

#### default.json
Tauri 2.0 capability definition:
- Identifier: "default"
- Windows: ["main"]
- Permissions:
  - core:default
  - core:window:* (close, minimize, maximize)
  - core:app:* (version, name)

### src-tauri/permissions/

#### backend.toml
Custom permission schema:
```toml
[backend]
default = []

[[backend.permission]]
identifier = "allow-check-health"

[[backend.permission]]
identifier = "allow-check-running"
```

### src-tauri/icons/

#### README.md
Icon requirements:
- 32x32.png
- 128x128.png
- 128x128@2x.png
- icon.icns (macOS)
- icon.ico (Windows)

Plus generation instructions.

## Build Artifacts (Gitignored)

When compiled, creates:
```
src-tauri/target/
├── debug/                    # Debug builds
├── release/                  # Release builds
│   ├── cnl                   # Executable
│   └── bundle/               # Platform bundles
│       ├── macos/
│       │   └── CNL.app       # Application bundle
│       └── dmg/
│           └── CNL_*.dmg     # Installer
```

## Development Workflow

### Starting Development Server

```bash
npm run dev
```

This:
1. Starts Vite dev server (port 5173)
2. Compiles Rust code
3. Launches Tauri app
4. Tauri spawns FastAPI (port 3141)
5. WebView loads localhost:5173

### Building for Production

```bash
npm run build
```

This:
1. Builds frontend: `cd frontend && npm run build`
2. Builds Tauri: `tauri build`
3. Produces `.app` and `.dmg` in `src-tauri/target/release/bundle/`

## Architecture

```
┌─────────────────────────────────────────┐
│           Tauri Application              │
│                                          │
│  ┌──────────────────────────────────┐   │
│  │         Rust Backend              │   │
│  │  ┌──────────┐                    │   │
│  │  │Sidecar   │                    │   │
│  │  │Manager   │                    │   │
│  │  │(spawns   │                    │   │
│  │  │ FastAPI) │                    │   │
│  │  └────┬─────┘                    │   │
│  └───────┼──────────────────────────┘   │
│          │                               │
│  ┌───────▼──────────────────────────┐   │
│  │      FastAPI Process              │   │
│  │      (localhost:3141)             │   │
│  └───────▲──────────────────────────┘   │
│          │                               │
│  ┌───────┼──────────────────────────┐   │
│  │      WebView                      │   │
│  │      (React Frontend)             │   │
│  │      localhost:5173 (dev)         │   │
│  │      asset://localhost (prod)     │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

## Key Features

### Tauri 2.0 Security Model
- Capability-based permissions
- Minimal CSP allowing only necessary origins
- No unsafe Rust code

### Sidecar Process Management
- Auto-discovery of Python
- Health check polling with timeout
- Graceful shutdown on app close
- Error handling and recovery

### Production Optimizations
- Size-optimized Rust compilation
- LTO and symbol stripping enabled
- Frontend minification via Vite
- Embedded assets in .app bundle

## Next Steps

1. **Install Rust**: `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh`
2. **Install Tauri CLI**: `npm install`
3. **Generate Icons**: Create actual icon files from CNL logo
4. **Test Development**: `npm run dev`
5. **Test Build**: `npm run build`
6. **Test on Clean Machine**: Verify .app works standalone

## Resources

- [Tauri Documentation](https://v2.tauri.app)
- [Tauri 2.0 Migration Guide](https://v2.tauri.app/start/migrate/from-tauri-1/)
- Story 4.1: `docs/stories/4.1.story.md`
- Setup Guide: `TAURI_SETUP.md`
- Architecture: `src-tauri/README.md`

---

**Created**: 2026-02-05
**Story**: 4.1 - Tauri App Shell
**Agent**: Claude Sonnet 4.5
